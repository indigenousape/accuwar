var startYear=new Date;startYear=startYear.getFullYear(),window.App={Models:{battleMapModel:{},clickedTerrModel:{},gameStartModel:{},nationStats:{},selectedTerrModel:{}},Collections:{terrCollection:{}},Constants:{AMBIENT_MUSIC:["audio/ambient-1.mp3","audio/ambient-2.mp3","audio/ambient-3.mp3","audio/ambient-4.mp3","audio/ambient-5.mp3","audio/ambient-6.mp3","audio/ambient-7.mp3","audio/ambient-8.mp3","audio/ambient-9.mp3","audio/ambient-10.mp3","audio/ambient-11.mp3","audio/ambient-12.mp3","audio/ambient-13.mp3","audio/ambient-14.mp3","audio/ambient-15.mp3","audio/ambient-16.mp3","audio/ambient-17.mp3","audio/ambient-18.mp3","audio/ambient-19.mp3","audio/ambient-20.mp3","audio/ambient-21.mp3","audio/ambient-22.mp3","audio/ambient-23.mp3","audio/ambient-24.mp3","audio/ambient-25.mp3","audio/ambient-26.mp3","audio/ambient-27.mp3"],ARMY_TRAINING_COST:1e7,ARMY_UNIT_COST:5e4,ATTACK_ARMY_MINIMUM:2e3,ATTACK_INVADE_ARMY_MINIMUM:1e4,ATTACK_MORALE_MINIMUM:20,COLOR_OPTIONS:["blue","orange","green","purple","pink"],COLOR_OPTIONS_DISP:["Blue","Orange","Green","Purple","Pink"],COST_PER_RECRUIT:5e4,DELAY_SHORTEST:4,DELAY_DEFAULT:6,DELAY_INFINITE:0,ECON_LVL_UP_AMT:1e10,ECON_STR_COST:1e9,FORT_LVL_COST:1e10,FORT_STR_COST:5e8,GDP_PENALTY_LOW_TAX:.9,HIGH_TAX_MORALE_AMT:.5,LEVEL_0_MOR_PER_TURN_MULT:1.05,LOGGING:!1,LOW_TAX_EC_CRASH_AMT:.15,MAX_RANK:5,MAX_TECH_LEVEL:10,MIN_ARMY_FOR_MORALE:25e4,MIN_ECON_POP_RECRUITING:1e3,PLAYER_1_DEF_START_COLOR:"blue",PLAYER_2_DEF_START_COLOR:"orange",POLICIES:[{side:"left",id:"repair_infra",title:"Repair infrastructure",priority:0},{side:"left",id:"repair_forts",title:"Repair forts",priority:0},{side:"left",id:"recruit_army",title:"Recruit army units",priority:0,amount:25e3},{side:"left",id:"upgrade_tech",title:"Upgrade technology",priority:0},{side:"right",id:"repair_infra",title:"Repair infrastructure",priority:0},{side:"right",id:"repair_forts",title:"Repair forts",priority:0},{side:"right",id:"recruit_army",title:"Recruit army units",priority:0,amount:25e3},{side:"right",id:"upgrade_tech",title:"Upgrade technology",priority:0}],RECRUIT_ARMY_MINIMUM:1e3,START_TURN:startYear,START_ARMY_UNITS:25e4,STARTING_TERRITORIES:25,STARTING_TERRITORIES_MOB:9,STARTING_TREASURY:5e11,STARTING_TREASURY_MOB:18e10,TERR_WARNINGS:[{army_cant_invade:"Not enough units to invade.",army_trapped:"Army units unable to mobilize.",gdp_shrinking:"Economy shrinking.",pop_shrinking:"Population shrinking.",below_min_army_units:"Not enough army units to attack.",below_min_army_morale:"Severely low army morale.",below_25_infr_str:"Severely damaged infrastructure.",below_25_fort_str:"Severely damaged fort.",below_25_econ_mor:"Severely low civilian morale."}],TESTING_MODE:!1,VICTORY_MUSIC:[{def:"audio/victory.mp3",rebels:"audio/victory_rebels.mp3",union:"audio/victory_union.mp3",college:"audio/victory_college.mp3",wallstreet:"audio/victory_wallstreet.mp3",wargames:"audio/victory_wargames.mp3"}],XP_PER_BATTLE:5},Defaults:{mobileMode:!0},Views:{allViews:[],battleMap:{},clickedTerrView:{},gameStartView:{},policiesView:{},leftViews:[],rightViews:[],nationStatsView:{},p1ColorView:{},p2ColorView:{},selectedFooterView:{},selectedTerrView:{},terrView:{}},Timers:{main:0,inner:0},Utilities:{activeSide:function(){return App.Models.nationStats.get("sideTurn")},addCommas:function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},capitalizeStr:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},console:function(e){App.Constants.LOGGING&&console.log(e)},crashNotification:function(e){var t=1e9<e?e-e%1e9:e-e%1e6,i=App.Models.nationStats.get(this.activeSide()).get("econCrashTurn")-App.Models.nationStats.get(this.activeSide()).get("econCrashTurnPrv"),o=i<=2&&0<i?"again":"",a={icon:"glyphicon glyphicon-globe",titleTxt:this.randomSource()+": Market "+this.marketAdjective()+" "+o+" in&nbsp;"+App.Models.nationStats.get(this.activeSide()).get("empName"),msgTxt:"$"+this.addCommas(Math.round(t))+" wiped out from the economy in "+App.Models.nationStats.get("currentTurn")+". Market fever blamed. Economists recommend raising taxes to stabilize&nbsp;nerves."};App.Views.battleMap.notify(a)},detectIE:function(){var e=window.navigator.userAgent,t=e.indexOf("MSIE ");if(0<t)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);if(0<e.indexOf("Trident/")){var i=e.indexOf("rv:");return parseInt(e.substring(i+3,e.indexOf(".",i)),10)}var o=e.indexOf("Edge/");return 0<o&&parseInt(e.substring(o+5,e.indexOf(".",o)),10)},displayInRange:function(){App.Utilities.enoughPopToAttack(App.Models.selectedTerrModel)&&App.Models.selectedTerrModel.get("morale")>App.Constants.ATTACK_MORALE_MINIMUM?App.Collections.terrCollection.attackRange(App.Models.selectedTerrModel):App.Collections.terrCollection.removeAttackRange(App.Models.selectedTerrModel),App.Utilities.enoughPopToReinforce(App.Models.selectedTerrModel)&&App.Collections.terrCollection.recruitTarget()},enoughMoraleToAttack:function(e){return e.get("morale")>App.Constants.ATTACK_MORALE_MINIMUM},enoughPopToAttack:function(e){var t=e.get("econStrength")/100;return e.get("armyPopulation")*t>2*App.Constants.ATTACK_ARMY_MINIMUM},enoughPopToInvade:function(e){var t=e.get("econStrength")/100;return e.get("armyPopulation")*t>App.Constants.ATTACK_INVADE_ARMY_MINIMUM},enoughPopToReinforce:function(e){var t=e.get("econStrength")/100;return e.get("armyPopulation")*t>2*App.Constants.ATTACK_ARMY_MINIMUM},exitFullScreen:function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()},flipEls:function(i){for(var e=0;e<i.length;e++)$(i[e]).each(function(){$(this).removeClass("flipInX").addClass("flipInX")});setTimeout(function(){for(var e=i,t=0;t<e.length;t++)$(e[t]).each(function(){$(this).removeClass("flipInX")})},1250)},getActiveEmpireName:function(){return App.Models.nationStats.get(App.Utilities.activeSide()).get("empName")},getEnemyEmpireName:function(){var e="left"===App.Utilities.activeSide()?"right":"left";return App.Models.nationStats.get(e).get("empName")},getTreasuryAuto:function(e){return App.Models.nationStats.get(e).get("treasury")},getTreasury:function(){return App.Models.nationStats.get(this.activeSide()).get("treasury")},growthDrags:function(e){return e<50?5-10*e/100:0},highTaxNotification:function(e){var t="",i="",o=!1;switch(e=14<e?_.random(2,e):e){case 2:t="WaPo: Outrage Over High Taxes",i="<p>Business leaders warn that high taxes will damage the "+this.getActiveEmpireName()+" economy over&nbsp;time.</p>",o=!0;break;case 3:t="Bloomberg: "+this.getActiveEmpireName()+" Shoppers Spend Less",i="<p>Citizens across "+this.getActiveEmpireName()+" are spending less after tax hike. Business owners are nervous for the&nbsp;future.</p>",o=!0;break;case 4:t="WSJ: "+this.getActiveEmpireName()+" Businesses Flee",i="<p>Recession fears as major employers close up shop and seek lower tax rates elsewhere. Citizens are scrambling to find&nbsp;work.</p>",o=!0;break;case 5:t="CNN: Citizens Demand Lower Taxes",i="<p>Angry citizens pack town halls across "+this.getActiveEmpireName()+" demanding tax relief to combat shrinking&nbsp;economy.</p>",o=!0;break;case 6:t="NPR: Homelessness in "+this.getActiveEmpireName(),i="<p>Desperation across "+this.getActiveEmpireName()+" as high taxes drive jobs away. Community leaders urge tax&nbsp;relief.</p>",o=!0;break;case 7:t="MSNBC: Nationwide Protests Erupt",i="<p>Protests disrupt peaceful communities across "+this.getActiveEmpireName()+" as angry citizens take to the streets over high taxes, scarce jobs, and unresponsive&nbsp;leaders.</p>",o=!0;break;case 8:t="Fox: Riots Grip "+this.getActiveEmpireName(),i="<p>Thousands injured as demonstrations against failing economy grow violent. Hundreds&nbsp;arrested.</p>",o=!0;break;case 9:t="WSJ: "+this.getActiveEmpireName()+" Economy in Danger Zone",i="<p>Economists warn tax relief needed soon or the "+this.getActiveEmpireName()+" economy may never&nbsp;recover.</p>",o=!0;break;case 10:t="NPR: Citizens Leaving "+this.getActiveEmpireName(),i="<p>Long lines at the border as citizens flee "+this.getActiveEmpireName()+" to seek a better life&nbsp;elsewhere.</p>",o=!0;break;case 11:t="Fox: Crime Wave Strikes "+this.getActiveEmpireName(),i="<p>Murders, robberies, and gang violence on the increase as depression continues. Citizens desperate for&nbsp;help.</p>",o=!0;break;case 12:t="NYT: "+this.getActiveEmpireName()+" Economy Continues Plunge",i="<p>No end in sight as the "+this.getActiveEmpireName()+" economy continues to shrink. Advisors recommend tax&nbsp;cuts.</p>",o=!0;break;case 13:t="AP: Depression Continues in "+this.getActiveEmpireName(),i="<p>Citizens desperate as crime and unemployment spiral out of control in "+this.getActiveEmpireName()+". Business leaders urge tax&nbsp;cut.</p>",o=!0;break;case 14:t="NYT: Leaders Silent in "+this.getActiveEmpireName(),i="<p>Citizens furious as government officials refuse to take steps to save crashing&nbsp;economy.</p>",o=!0;break;default:o=!1}o&&App.Views.battleMap.notify({icon:"glyphicon glyphicon-globe",titleTxt:t,msgTxt:i})},inReinforceMode:function(){return 0<$(".reinforce").length},isEnterKey:function(e){var t=!1;if(void 0!==e)t=13===(window.event?e.keyCode:e.which);return t},isEscKey:function(e){var t=!1;if(void 0!==e)t=27===(window.event?e.keyCode:e.which);return t},isFullScreen:function(e){return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement},isMobile:function(){var e=Math.max(document.documentElement.clientWidth,window.innerWidth||0),t=Math.max(document.documentElement.clientHeight,window.innerHeight||0),i=e<=1024||e<1280&&t<813;return i||(i=App.Defaults.mobileMode),i},isSafari:function(){var e=navigator.userAgent.toLowerCase();return-1!=e.indexOf("safari")&&-1===e.indexOf("chrome")},isMobileDevice:function(){var e=Math.max(document.documentElement.clientWidth,window.innerWidth||0),t=Math.max(document.documentElement.clientHeight,window.innerHeight||0);return e<1200&&t<813},launchFullScreen:function(e){e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()},lowTaxNotification:function(e){var t="",i="",o=!1;switch(e=15<e?_.random(0,e):e){case 2:var a=this.returnRecentCrash()?"growing":"recovering";t="WaPo: Spending Up Across&nbsp;"+this.getActiveEmpireName(),i="<p>Shops stay open late as citizens open their wallets in the rapidly "+a+"&nbsp;economy.</p>",o=!0;break;case 3:a=this.returnRecentCrash()?"Business Booms":"Strong Recovery";t=this.randomSource()+": "+a+" Across "+this.getActiveEmpireName(),i="<p>New jobs opening up across "+this.getActiveEmpireName()+" as businesses take advantage of low corporate tax rates.</p>",o=!0;break;case 4:var n=this.returnRecentCrash()?"Red Hot":"Recovering";t=this.randomSource()+": "+n+" Economy At Risk?",i="<p>Experts warn keeping taxes too low for too long risks market crashes in "+this.getActiveEmpireName()+".</p>",o=!0;break;case 5:var r=this.returnRecentCrash()?"Soars":"Recovering";t=this.randomSource()+": Real Estate Market "+r+" in&nbsp;"+App.Models.nationStats.get("currentTurn"),i="<p>People are taking advantage of low interest rates and buying second and third homes across the&nbsp;empire.</p>",o=!0;break;case 6:t="NPR: Infrastructure Crumbling Across&nbsp;"+this.getActiveEmpireName(),i="<p>Territories are struggling to maintain roads, bridges, and tunnels with less funding from the empire. Experts suggest raising&nbsp;taxes.</p>",o=!0;break;case 7:var s=this.returnRecentCrash()?"Breaks&nbsp;Records":"&nbsp;Strengthening";t=this.randomSource()+": "+this.getActiveEmpireName()+" Stock Market"+s,i="<p>Stock traders rejoice as the "+this.getActiveEmpireName()+" stock market sets new records for growth in&nbsp;"+App.Models.nationStats.get("currentTurn")+".</p>",o=!0;break;case 8:var l=this.returnRecentCrash()?" at All Time&nbsp;Lows":"&nbsp;Shrinking",p=this.returnRecentCrash()?"to boom":"strong recovery";t="WaPo: "+this.getActiveEmpireName()+" Unemployment"+l,i="<p>Employers scramble to find workers as economy continues "+p+" in&nbsp;"+App.Models.nationStats.get("currentTurn")+".</p>",o=!0;break;case 9:t="NPR: Poverty Declines Across&nbsp;"+this.getActiveEmpireName(),i="<p>Citizens enjoying higher pay and higher standards of living all across the empire. Leaders credit business-friendly tax environment.</p>",o=!0;break;case 10:var d=this.returnRecentCrash(4)?"a Thing of the&nbsp;Past?":"Here to&nbsp;Stay?",c=this.returnRecentCrash(4)?"and self-regulation are the keys to a healthy&nbsp;economy":"are like gambling with the "+this.getActiveEmpireName()+"&nbsp;economy";t=this.randomSource()+": Market Crashes "+d,i="<p>Experts say low taxes&nbsp;"+c+".</p>",o=!0;break;case 11:t="AAA: Citizens On The&nbsp;Go",i="<p>Citizens in "+this.getActiveEmpireName()+" planning longer vacations, more family trips in&nbsp;"+App.Models.nationStats.get("currentTurn")+".</p>",o=!0;break;case 12:var g=this.returnRecentCrash()?"another strong year for the&nbsp;economy":"a strong economic&nbsp;recovery";t=this.randomSource()+": Strong Growth Forecast in&nbsp;"+App.Models.nationStats.get("currentTurn"),i="<p>Low taxes mean big business in "+this.getActiveEmpireName()+". Experts predict&nbsp;"+g+".</p>",o=!0;break;case 13:t="WaPo: Higher Taxes&nbsp;Ahead?",i="<p>Leaders seeking re-election in "+this.returnNextElectionYear()+" face increasing pressure to raise taxes to shore up crumbling infrastructure, fund the military, and stabilize the&nbsp;economy.</p>",o=!0;break;case 14:var u=this.returnRecentCrash()?"":" despite recent&nbsp;hardships";t="Fox News: Immigrants Flock to&nbsp;"+this.getActiveEmpireName(),i="<p>The Red Cross reports long lines at the border as immigrants come to "+this.getActiveEmpireName()+" seeking new&nbsp;opportunities"+u+".</p>",o=!0;break;case 15:t="MSNBC: Corporate Scandals Make&nbsp;Headlines",i="<p>Industry titans face charges as investors seek damages following $"+(1e11<App.Models.nationStats.get(this.activeSide()).get("treasury")?_.random(50,250)+"&nbsp;billion":_.random(50,250)+"&nbsp;million")+" financial fraud. Leaders promise stronger&nbsp;regulations.</p>",o=!0;break;default:o=!1}o&&App.Views.battleMap.notify({icon:"glyphicon glyphicon-globe",titleTxt:t,msgTxt:i})},makeStarGroup:function(e){for(var t=(e.updateRank,'<span class="rank-stars"><strong>'),i=1;i<=e.newRank;i++)t+='<span class="glyphicon glyphicon-star" aria-hidden="true"></span>';for(i=App.Constants.MAX_RANK;i>e.newRank;i--)t+='<span class="glyphicon glyphicon-star-empty" aria-hidden="true"></span>';return t+=e.armyPromoted?"</strong> Army promoted!</span> ":"</strong></span>"},makeTerritories:function(){for(var e=parseInt(App.Models.battleMapModel.get("territories")),t=e===App.Constants.STARTING_TERRITORIES_MOB,i=t?3:5,o=[],a=[],n=new Array,r=0,s=1,l=0,p=0,d=t?3:10,c=t?5:14,g=t?2:4,u=t?3:5,m=App.Utilities.territoryNames("left","right"),A=1;A<=2*e;++A){var h=_.random(0,m.length-1),M=m[h];if(m.splice(h,1),r<e/i){0;var T=App.Constants.TESTING_MODE?25e5:App.Constants.START_ARMY_UNITS,f=App.Constants.TESTING_MODE?99:0,C=r===g?2:1;n[A]=l!=d?new App.Models.Territory({name:M,side:"left",color:"blue",armyPopulation:T,startPopulation:T,armyXP:f,fortLevel:C,small:t,color:App.Models.gameStartModel.get("p1Color"),column:r+1,row:s}):new App.Models.Territory({name:M,side:"left",color:"orange",armyRank:2,isCapital:!0,fortLevel:5,small:t,color:App.Models.gameStartModel.get("p1Color"),column:r+1,row:s}),o.push(n[A]),l++,r++}else{f=(App.Constants.TESTING_MODE,0),T=App.Constants.TESTING_MODE?1e4:App.Constants.START_ARMY_UNITS;0;C=r===u?2:1;var v=App.Constants.TESTING_MODE?10:100;n[A]=p!=c?new App.Models.Territory({name:M,side:"right",remainingTurns:0,armyXP:f,armyPopulation:T,fortLevel:C,fortStrength:v,small:t,color:App.Models.gameStartModel.get("p2Color"),column:r+1,row:s}):new App.Models.Territory({name:M,side:"right",remainingTurns:0,isCapital:!0,armyRank:2,fortLevel:5,small:t,color:App.Models.gameStartModel.get("p2Color"),column:r+1,row:s}),a.push(n[A]),p++,++r==2*i&&(r=0,s++)}App.Views.terrView=new App.Views.Terr({model:n[A]}),"left"===n[A].get("side")?App.Views.leftViews.push(App.Views.terrView):App.Views.rightViews.push(App.Views.terrView),App.Collections.terrCollection.add(n[A]),App.Views.allViews.push(App.Views.terrView),$("#battleZone").append(App.Views.terrView.$el)}App.Utilities.console("App.Views.leftViews: "),App.Utilities.console(App.Views.leftViews),App.Utilities.console("App.Views.rightViews: "),App.Utilities.console(App.Views.rightViews),App.Utilities.console("App.Views.allViews: "),App.Utilities.console(App.Views.allViews),App.Models.nationStats.get("left").set({terrs:o,terrsWithTurns:o}),App.Models.nationStats.get("right").set({terrs:a,terrsWithTurns:a}),App.Utilities.console("Territories Generated:"),App.Utilities.console(App.Collections.terrCollection),App.Models.battleMapModel.set("mobileMode",t)},marketAdjective:function(){var e=[" crashes "," tumbles "," collapses "," plummets "," plunges "," drops suddenly "," panic "," sell-off "];return e[_.random(0,e.length-1)]},newEconPopCalc:function(e,t,i){var o,a=1+(100-i)/100;if(.45<=t)o=(3+t)/100;else if(.35<=t)o=(2+t)/100;else if(.25<=t)o=(1+t)/100;else for(o=Math.random();.01<o;)o=Math.random();return e-=Math.round(e*(a*o))},newEconPopGrowthRate:function(e){var t=(e.econMorale-25)*Math.random()/50,i=(e.econStrengh-25)*Math.random()/50,o=e.econPop<1e6?10*Math.random():0,a=e.highTaxTurnLength?e.highTaxTurnLength/5:0,n=e.lowTaxCrash?.25:0;return(o+t+e.econLevel/5+i-this.growthDrags(e.econMorale)-this.growthDrags(e.econStrength)-a-n)/100},newEconStrengthCalc:function(e,t,i){var o,a=1+(100-i)/100;return o=.75<=t?Math.min(t,.9):.5<=t?Math.min(t,.8):.25<=t?Math.min(t,.5):t,e-=15<e?Math.round(e*(a*o)):Math.round(e*a*o),Math.round(e)},newGDPGrowthRate:function(e){var t=e.econPop<1e6?10*Math.random():0,i=2*Math.random()*(e.econMorale/100),o=2*Math.random()*(e.econStrength/100),a=e.econLevel/5,n=0<e.lowTaxTurnLength?e.lowTaxTurnLength/4+Math.random():0;n=e.lowTaxCrash?-5*Math.random()-5:n;return(t+i+o+a-this.growthDrags(e.econMorale)-this.growthDrags(e.econStrength)-this.growthDrags(e.econStrength)-Math.min(e.highTaxTurnLength,10)+n)/100},newRank:function(e,t){var i=100===e,o=i?t.get("armyRank")+1:t.get("armyRank");if(i&&o<=App.Constants.MAX_RANK){App.Utilities.console(t.get("name")+" was promoted to Rank "+(1+t.get("armyRank"))+".");var a=App.Models.nationStats.get(t.get("side")).get("armiesPromoted").slice();a.push(t.get("name")),App.Models.nationStats.get(t.get("side")).set("armiesPromoted",a)}return o},playNextTrack:function(){App.Utilities.setNextTrack(),$("#ambientMusic")[0].pause(),$("#ambientMusic")[0].load(),$("#ambientMusic")[0].oncanplaythrough=$("#ambientMusic")[0].play()},playVictoryTrack:function(){$("#ambientMusic").off(),$("#ambientMusic").attr("src",App.Utilities.victoryTrackSource()),$("#ambientMusic")[0].pause(),$("#ambientMusic")[0].load(),$("#ambientMusic")[0].oncanplaythrough=$("#ambientMusic")[0].play(),$("#ambientMusic").bind("ended",App.Utilities.playVictoryTrack)},randomBattleOutcome:function(e){var t=[],i=e.attCasRate<.05&&e.defCasRate<.05||e.defArmyCas<5e3&&e.attArmyCas<5e3,o=["Annihilates","Nearly Destroys","Devastates","Wipes Out","Massacres","Slaughters","Decimates","Demolishes","Butchers","Mows Down","Obliterates"],a=["Clobbers","Thrashes","Overpowers","Shreds","Trounces","Overwhelms","Beats Up","Dominates","Shatters","Crushes"],n=["Defeats","Blitzes","Whips","Assaults","Hammers","Bruises","Beats","Pummels","Ambushes","Pounds","Routes","Hits","Shells","Attacks"],r=["Narrowly Defeats","Edges","Barely Beats"],s=["Outlasts","Outfights","Outmaneuvers","Outflanks"],l=["Skirmishes with","Clashes with","Raids","Trades Mortars with","Exchanges Artillery Fire with","Exchanges Rocket Fire with"],p=["Repels","Defeats","Beats","Routes","Fends Off","Holds Off","Beats Back","Drives Back","Pushes Back","Fights Off"];t=e.attCasRate<e.defCasRate?i?l:e.defCasRate-e.attCasRate<.1&&e.defCasRate<.75&&e.attCasRate<.75?r:e.defCasRate-e.attCasRate<.1&&.75<=e.defCasRate&&.75<=e.attCasRate?s:.05<=e.defCasRate&&e.defCasRate<.4&&e.defCasRate/e.attCasRate<2||.33<=e.attCasRate?n:.4<=e.defCasRate&&e.attCasRate<.33||2<=e.defCasRate/e.attCasRate?.85<e.defCasRate?o:a:n:i?l:e.attCasRate-e.defCasRate<.1&&e.defCasRate<.75&&e.attCasRate<.75?r:e.defCasRate-e.attCasRate<.1&&.75<=e.defCasRate&&.75<=e.attCasRate?s:.05<=e.attCasRate&&e.attCasRate<.4&&e.attCasRate/e.defCasRate<2||.33<=e.defCasRate?p:.4<=e.attCasRate&&e.defCasRate<.33&&2<=e.attCasRate/e.defCasRate?.85<e.defCasRate?o:a:p;var d=_.random(0,t.length-1),c="<ul><li>"+App.Utilities.addCommas(e.defArmyCas)+" "+App.Models.clickedTerrModel.get("name")+" Army casualties ("+Math.round(e.defArmyCas/App.Models.clickedTerrModel.get("prvPopulation")*100)+"%)</li><li>"+App.Utilities.addCommas(e.attArmyCas)+" "+App.Models.selectedTerrModel.get("name")+" Army casualties ("+Math.round(e.attArmyCas/App.Models.selectedTerrModel.get("prvPopulation")*100)+"%)</li><li>"+App.Utilities.addCommas(e.defCivCas)+" "+App.Models.clickedTerrModel.get("name")+" Civilian casualties ("+Math.round(e.defCivCas/App.Models.clickedTerrModel.get("prvEconPopulation")*100)+"%)</li></ul>";return{icon:"glyphicon glyphicon-globe",titleTxt:e.defCasRate<e.attCasRate&&!i?App.Models.clickedTerrModel.get("name")+" "+t[d]+" "+App.Models.selectedTerrModel.get("name"):App.Models.selectedTerrModel.get("name")+" "+t[d]+" "+App.Models.clickedTerrModel.get("name"),msgTxt:c,msgType:"info",vert:"bottom"}},randomSource:function(){var e=["AP","Reuters","WSJ","NYT","CNBC","Forbes"];return e[_.random(0,e.length-1)]},recruitMax:function(){var e=this.activeSide(),t=App.Models.nationStats.get(e).get("armyTechLvl"),i=parseInt(this.getTreasury()/(App.Constants.ARMY_UNIT_COST*t)),o=Math.round(App.Models.selectedTerrModel.get("econPopulation")/2)-App.Constants.MIN_ECON_POP_RECRUITING;return Math.min(i,o)},recruitUnitsModal:function(e){var t=new App.Models.Modal({title:"Recruit Army Units: "+e.get("name"),confBtnId:"confNewRecruits",modalMsg:'<p class="form-text">How many army units should '+e.get("name")+" recruit from the civilian population?</p>",impactMsg:'<span>Cost $<span id="recruitCost">'+App.Utilities.addCommas(Math.round(1e4*App.Constants.COST_PER_RECRUIT))+'</span></span><span class="pull-right"><span id="recruitCount">10,000</span> Units</span>',impactClass:"text-muted",noTurnsMsg:"Ends turn for "+e.get("name")+".",confBtnClass:"btn-danger",showRange:!0,rangeMin:App.Constants.RECRUIT_ARMY_MINIMUM,rangeMax:App.Utilities.recruitMax()-App.Utilities.recruitMax()%100,rangeVal:1e4});new App.Views.SinglePromptModal({model:t})},removeClassName:function(e){if("object"==typeof e){var t=0,i=e.length;for(t=0;t<i;t++)$("."+e[t]).removeClass(e[t])}else $("."+e).removeClass(e)},repairTerrFortStr:function(e){void 0===e&&(e=App.Models.selectedTerrModel);var t=e.get("morale"),i=Math.round(t+(100-e.get("fortStrength")/2)),o=(i=Math.min(i,100),App.Utilities.updateEconMorale({selectedFortStrength:100,newMorale:e.get("econMorale")})),a=App.Utilities.updateGDP({newMorale:o,newEconStrength:e.get("econStrength"),newEconPopulation:e.get("econPopulation"),newLevel:e.get("econLevel"),ecGrowthRate:e.get("econGrowthPct")});e.set({fortStrength:100,fortStrengthCost:0,economicOutput:a,econMorale:o,morale:i})},restartSkipBeginning:function(){App.Models.battleMapModel=new App.Models.BattleZone({territories:App.Models.battleMapModel.get("territories"),mobileMode:App.Defaults.mobileMode,randomMap:App.Models.battleMapModel.get("randomMap"),audio:App.Models.battleMapModel.get("audio"),tipsMode:App.Models.battleMapModel.get("tipsMode")}),App.Views.battleMap=new App.Views.BattleZone({model:App.Models.battleMapModel}),$("#game").html(App.Views.battleMap.$el);var e=App.Utilities.isMobile()?App.Constants.STARTING_TREASURY_MOB:App.Constants.STARTING_TREASURY,t=App.Utilities.isMobile()?18e9:5e10,i=App.Utilities.isMobile()?9e7:25e7,o=App.Utilities.isMobile()&&!App.Constants.TESTING_MODE?225e4:625e4,a=App.Utilities.isMobile()&&!App.Constants.TESTING_MODE?72e10:2e12,n=new Emp({armyPopulationStart:o,color:App.Models.nationStats.get("left").get("color"),econPopulationStart:i,econPopulationNow:i,nextTreasuryAddedEst:e,repairAllInfrastructureCost:t,treasury:e,treasuryPrev:e,treasuryStart:e,econOutput:a,econOutputStart:a}),r=new Emp({armyPopulationStart:o,color:App.Models.nationStats.get("right").get("color"),econPopulationStart:i,econPopulationNow:i,nextTreasuryAddedEst:e,repairAllInfrastructureCost:t,treasury:e,treasuryPrev:e,treasuryStart:e,econOutput:a,econOutputStart:a});App.Models.nationStats=new App.Models.NationStats({left:n,right:r}),App.Views.nationStatsView=new App.Views.NationStats({model:App.Models.nationStats}),App.Collections.terrCollection=new App.Collections.Territories,App.Utilities.makeTerritories()},returnHighTaxLimit:function(){return 100*App.Constants.HIGH_TAX_MORALE_AMT},returnLowTaxLimit:function(){return 100*App.Constants.LOW_TAX_EC_CRASH_AMT},returnNewMoraleXpRank:function(e,t){_.isEmpty(App.Models.clickedTerrModel)&&(App.Models.clickedTerrModel=e),_.isEmpty(App.Models.selectedTerrModel)&&(App.Models.selectedTerrModel=e);var i=100*App.Models.clickedTerrModel.get("armyRank")+App.Models.clickedTerrModel.get("armyXP"),o=100*App.Models.selectedTerrModel.get("armyRank")+App.Models.selectedTerrModel.get("armyXP"),a=App.Models.clickedTerrModel.get("armyPopulation")/(App.Models.clickedTerrModel.get("armyPopulation")+t),n=t/(t+App.Models.clickedTerrModel.get("armyPopulation")),r=Math.round(i*a+o*n),s=1==App.Models.clickedTerrModel.get("armyRank")?1:0;if(100<=r){var l=r%100;s=(r-l)/100,s=Math.min(s,App.Constants.MAX_RANK)}else l=r;var p=t/App.Models.clickedTerrModel.get("armyPopulation"),d=t/App.Models.selectedTerrModel.get("armyPopulation"),c=Math.min(Math.round(App.Models.clickedTerrModel.get("morale")+50*p),100);Math.max(Math.round(parseInt(App.Models.selectedTerrModel.get("morale"))-50*d),0);return{toMorale:c,fromMorale:Math.max(Math.round(parseInt(App.Models.selectedTerrModel.get("morale"))-50*d),0),toXP:l,toRank:s}},returnNextElectionYear:function(){return App.Models.nationStats.get("currentTurn")-App.Models.nationStats.get("currentTurn")%4+4},returnRecentCrash:function(e){return"undefined"==typeof turn&&(e=3),App.Models.nationStats.get("currentTurn")-App.Models.nationStats.get(App.Utilities.activeSide()).get("econCrashTurnPrv")>e},returnRecruitMoraleXPRank:function(e,t){var i=100*e.get("armyRank")+e.get("armyXP"),o=e.get("armyPopulation")/(e.get("armyPopulation")+t),a=t/(t+e.get("armyPopulation")),n=Math.round(i*o+100*a),r=1==e.get("armyRank")?1:0;if(100<=n){var s=n%100;r=(n-s)/100,r=Math.min(r,App.Constants.MAX_RANK)}else s=n;var l=t/e.get("armyPopulation");return{toMorale:Math.min(Math.round(e.get("morale")+50*l),100),fromMorale:80,toXP:s,toRank:r}},returnSelectedTerritoryIsLimited:function(){var e=this.enoughPopToAttack(App.Models.selectedTerrModel),t=this.enoughMoraleToAttack(App.Models.selectedTerrModel),i=this.enoughPopToInvade(App.Models.selectedTerrModel);return!1===e||!1===t||!1===i},returnSelectedTerritoryLimits:function(){var e=this.enoughPopToAttack(App.Models.selectedTerrModel)?"":"Repair damaged infrastructure in the&nbsp;territory.",t=(e=App.Models.selectedTerrModel.get("armyPopulation")<2*App.Constants.ATTACK_ARMY_MINIMUM?"Recruit more units or send reinforcements from another&nbsp;territory.":e,this.enoughPopToInvade(App.Models.selectedTerrModel)?"":"Repair the infrastructure, recruit more units, or send reinforcements from another&nbsp;territory."),i=this.enoughMoraleToAttack(App.Models.selectedTerrModel)?"":"Improve morale by training units, repairing and upgrading forts, and by adding units to the&nbsp;army.",o={};return 0<e.length&&(o.popLimit=e),0<t.length&&(o.invLimit=t),0<i.length&&(o.moraleLimit=i),o},returnSimpleBarColors:function(e,t){return 80<e.get(t)?{background:"green",text:"white"}:25<e.get(t)?{background:"yellow",text:""}:{background:"red",text:"red"}},returnSimpleTerrBarColors:function(e,t){return 75<e.get(t)?{background:"green",text:"white"}:25<e.get(t)?{background:"yellow",text:""}:{background:"red",text:"red"}},returnStandardBarColors:function(e,t,i){return 80<e.get(t)/e.get(i)*100?{background:"green",text:"white"}:25<e.get(t)/e.get(i)*100?{background:"yellow",text:""}:{background:"red",text:"red"}},returnTerrFortCost:function(e){return App.Constants.FORT_STR_COST*e.get("fortLevel")*(100-e.get("fortStrength"))},returnTerrInfraCost:function(e){return Math.round(App.Constants.ECON_STR_COST*e.get("econLevel")*((100-e.get("econStrength"))/10))},returnTerrWarnings:function(e){var t=[];return e.get("econGrowthPct")<0&&t.push("gdp_shrinking"),e.get("econPopulationGrowthPct")<0&&t.push("pop_shrinking"),e.get("armyPopulation")*e.get("econStrength")/100<2*App.Constants.ATTACK_ARMY_MINIMUM&&t.push("army_trapped"),e.get("armyPopulation")*e.get("econStrength")/100<2*App.Constants.ATTACK_INVADE_ARMY_MINIMUM&&e.get("armyPopulation")*e.get("econStrength")/100>=2*App.Constants.ATTACK_ARMY_MINIMUM&&t.push("army_cant_invade"),e.get("armyPopulation")*(e.get("econStrength")/100)<2*App.Constants.ATTACK_ARMY_MINIMUM&&t.push("below_min_army_units"),e.get("morale")<App.Constants.ATTACK_MORALE_MINIMUM&&t.push("below_min_army_morale"),e.get("econStrength")<25&&t.push("below_25_infr_str"),e.get("fortStrength")<25&&t.push("below_25_fort_str"),e.get("econMorale")<25&&t.push("below_25_econ_mor"),t},selectOrFocus:function(e){var t=$("#"+e);0<t.val().length&&!this.smallScreenOnly()?t.select():this.smallScreenOnly()||t.focus()},setClickedTreasuryLimits:function(){var e=App.Models.selectedTerrModel.get("econStrength"),t=App.Models.selectedTerrModel.get("econLevel"),i=Math.round(App.Constants.ECON_STR_COST*t*((100-e)/10)),o=App.Models.selectedTerrModel.get("fortLevel"),a=App.Constants.FORT_LVL_COST*(1+o),n=App.Constants.FORT_STR_COST*o*(100-App.Models.selectedTerrModel.get("fortStrength")),r=App.Constants.ECON_LVL_UP_AMT*(1+t),s=.25*(100-App.Models.selectedTerrModel.get("armyXP"))*(App.Constants.ARMY_TRAINING_COST*App.Models.selectedTerrModel.get("armyPopulation")/1e3);App.Models.selectedTerrModel.set({currTreasury:App.Utilities.getTreasury(),econStrengthCost:i,fortLevelCost:a,fortStrengthCost:n,econLevelCost:r,trainingArmyCost:s}),App.Models.nationStats.get(App.Utilities.activeSide()).set({repairAllInfrastructureCost:App.Collections.terrCollection.returnTotalCost("econStrength",App.Utilities.activeSide()),repairAllFortCost:App.Collections.terrCollection.returnTotalCost("fortStrength",App.Utilities.activeSide())})},setNextTrack:function(){var e,t=$("#ambientMusic")[0].currentSrc.substring($("#ambientMusic")[0].currentSrc.indexOf("audio/")),i=App.Constants.AMBIENT_MUSIC.indexOf(t);-1!=i?(e=App.Constants.AMBIENT_MUSIC.slice()).splice(i,1):e=App.Constants.AMBIENT_MUSIC,newSong=e[_.random(0,e.length-1)],$("#ambientMusic").attr("src",newSong)},showModal:function(){$("#oneModal").modal({backdrop:"static",keyboard:!1}),$("#oneModal").on("shown.bs.modal",function(){App.Views.battleMap.smoothScroll(".terr:first-child")})},smallScreenOnly:function(){var e=Math.max(document.documentElement.clientWidth,window.innerWidth||0),t=Math.max(document.documentElement.clientHeight,window.innerHeight||0);return e<=1200||e<1280&&t<813},template:function(e){return _.template($("#"+e).html())},territoryNames:function(e){var t=["America","United Kingdom","France","Germany","Poland","Estonia","Ukraine","Sweden","Norway","Iceland","Mexico","Brazil","Finland","Ireland","Russia","India","Pakistan","Iran","Iraq","Libya","Kuwait","UAE","Yemen","Syria","Australia","China","North Korea","South Korea","Vietnam","Egypt","Tunisia","Greece","Italy","Spain","Portugal","Denmark","Switzerland","Japan","Turkey","Chile","Peru","Cameroon","Morocco","Jamaica","Senegal","Mozambique","Afghanistan","New Zealand","Canada","Colombia","Honduras","Bolivia","Ecuador","Panama","South Africa","Sierra Leone","Saudi Arabia","Philippines","Bolivia","Argentina","Paraguay","Uruguay","Latvia","Belarus","Belgium","Romania","Algeria","Chad","Nigeria","Nicaragua","Niger","Israel","Georgia","Liberia","Gabon","Ghana","Lebanon","Jordan","Oman","Nepal","Madagascar","Luxembourg","Singapore","Burma","Mongolia","Laos","Taiwan","Bangledash","Malaysia","Thailand","Togo","Argentina","Venezuela","Greenland","Indonesia"];switch(e){case"civilwar":t=["Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware","Florida","Georgia","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey","New Mexico","New York","North Carolina","North Dakota","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode Island","South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont","Virginia","Washington","West Virginia","Wisconsin","Wyoming"],App.Models.battleMapModel.set("mapMode",e);break;case"college":t=["NC State","Duke","UNC","Central Michigan","Kennesaw State","Pittsburgh","Full Sail","Kansas State","CUNY Manhattan","Connecticut","Oklahoma","SoCal","Riverside","Wisconsin","Oklahoma State","George Mason","James Madison","SUNY Buffalo","Oregon State","Oregon","Fresno State","Georgia State","Wake Forest","Kent State","East Carolina","Arkansas","Auburn","UNC Charlotte","Iowa","VCU","California St.","UCLA","Colorado State","Tennessee","West Virginia","Cincinnati","San Jose State","LSU","Virginia Tech","Virginia","Temple","Maryland","Texas Tech","Kentucky","Kansas","Michigan","Michigan State","Ohio","Ohio State","BYU","Liberty","UC Davis","Purdue","Alabama","Florida","Florida State","Georgia Tech","Georgia State","Arizona","Indiana","Rutgers","Central Florida","Arizona State","Penn State","Texas","Texas A M","Boston College","Syracuse","Clemson","Notre Dame","Army","Navy","Miami","Georgia","Louisville"],App.Models.battleMapModel.set("mapMode",e);break;case"wallstreet":t=["Boeing","Apple","Microsoft","Google","IBM","3M","Caterpillar","Chevron","Cisco","Coca Cola","Exxon Mobil","General Electric","Goldman Sachs","Home Depot","Intel","Johnson","JP Morgan Chase","McDonalds","Merck","Nike","Pfizer","Verizon","Starbucks","Tesla","Dominos","Visa","Walmart","Disney","Facebook","Toyota","Wells Fargo","BP","GlaxoSmithkline","Siemens","BASF","Samsung","Qualcomm","Philip Morris","Novartis","Citigroup","Amazon.com","Pfizer","Biogen","MasterCard","Oracle","Intel","SAP","Nestle","Pepsi","Unilever","Volkswagen","Daimler","Shell","Comcast","Spectrum","Walgreens","UPS","AT&T","Bayer","CVS Health","eBay","McKesson","GM","Ford","Honda","Costco","Kroger","Nissan","Fannie Mae","BMW","Prudential","Hitachi","Hyundai","State Farm","Philips 66","Sony","Target","Panasonic","Freddie Mac","Lowes","Dell","Metlife","Aetna","Mitsubishi","AIG","FedEx","HP","Dow Chemical","Cigna","Delta","Best Buy","Honeywell","Morgan Stanley","Tyson Foods","Allstate","Volvo","Rite Aid","Subaru","Mazda","Deere","Macys","Raytheon","Progressive","Heineken","Aflac"],App.Models.battleMapModel.set("mapMode",e);break;case"makebelieve":t=["Lilliput","Ecotopia","Gilead","Panem","Petoria","Joehio","Franklin","Arixo","Xanadu","Pacifica","Tropico","Anchuria","Chimerica","Hidalgo","Tijata","Aldorria","Wadiya","Vadeem","Vespugia","Urkesh","Urk","Tecala","Sangala","Sardovia","Sarkhan","Sokovia","Sunda","Rhelasia","Ruritania","Latveria","Laurania","Kamistan","Kangan","Kasnia","Illyria","Ixania","Halla","Genosha","Glovania","Guilder","Groland","Florin","Franchia","Erewhon","Estoccia","Danu","Deltora","Caledonia","Carpathia","Cordinia","Cortuguay","Atlantis","Bahari","Honahlee","Basran","Balavia","Blefuscu","Bolumbia","Buranda","Gondor","Mordor","Rohan","Rivendell","Isengard","Narnia","Hogwarts"],App.Models.battleMapModel.set("mapMode",e);break;case"joshua":case"wargames":App.Models.battleMapModel.set("mapMode",e);break;default:App.Models.battleMapModel.set("mapMode","")}return t},trainTerrArmy:function(){var e=App.Models.selectedTerrModel.get("armyXP"),t=e+Math.round(.25*(100-e)),i=App.Models.selectedTerrModel.get("morale"),o=Math.min(Math.round(i+(t-e)),100);App.Models.selectedTerrModel.set({armyXP:t,morale:o,remainingTurns:App.Models.selectedTerrModel.get("remainingTurns")-1,selected:!1,trainingClicked:!0})},updateEconMorale:function(e){var t=e.side?e.side:"left",i=e.econStrength?e.econStrength:0,o=(e.econPopulation&&e.econPopulation,e.econLevel?e.econLevel:0),a=e.selectedArmyPop?e.selectedArmyPop:0,n=e.selectedFortLevel?e.selectedFortLevel:0,r=e.selectedFortStrength?e.selectedFortStrength:0,s=e.selectedTaxRate?100*e.selectedTaxRate:0,l=e.oldTaxRate?100*e.oldTaxRate:0,p=e.genTaxBonuses,d=3<=e.leftHighTaxTurnLength?5*e.leftHighTaxTurnLength:0,c=3<=e.rightHighTaxTurnLength?5*e.rightHighTaxTurnLength:0,g=3<=e.leftLowTaxTurnLength?e.leftLowTaxTurnLength:0,u=3<=e.rightLowTaxTurnLength?e.rightLowTaxTurnLength:0,m=e.newMorale,A=0;0==g&&0==u||(A="left"===t?Math.min(e.leftLowTaxTurnLength,5):Math.min(e.rightLowTaxTurnLength,5),A=App.Models.nationStats.get(t).get("econCrash")?-5*A:3*A);var h=75<=r?2:0,M=1<o?o:0,T=n||0,f=e.selectedArmyPop?Math.floor(a/App.Constants.MIN_ARMY_FOR_MORALE):0,C=h+M+n+T+f+(75<=i?Math.round(i/100*10):0)+(p&&e.selectedTaxRate&&s<15?Math.round((15-s)/15*5):0)+(0<l-s?l-s:0);var v=0;0==d&&0==c||(v="left"===t?Math.min(8*e.leftHighTaxTurnLength,50):Math.min(50,8*e.rightHighTaxTurnLength));var y,S,w=e.econStrength?Math.round(10*(1-i/100)):0,b=e.selectedArmyPop&&0===f?10:0,R=0<e.oldTerrArmyPop-e.selectedArmyPop?Math.round((e.oldTerrArmyPop-e.selectedArmyPop)/e.oldTerrArmyPop*20):0,U=e.selectedFortStrength&&r<50?(y=r,S=Math.min(y/200,10),S=Math.max(S,3),Math.round(S)):0,k=0<(k=e.econPopulation?e.oldEconPop-e.econPopulation:0)?Math.round(k/1e4):0,P=e.governorCasualty?3:0;return ecHighTaxDrag=p&&e.selectedTaxRate&&s>App.Constants.HIGH_TAX_MORALE_AMT?v:0,ecRaisedTaxes=0<s-l?s-l:0,ecMoraleDrags=w+b+R+U+k+ecRaisedTaxes+ecHighTaxDrag+P,m+=C-ecMoraleDrags+A,m=Math.min(m,100),m=Math.max(m,1),Math.round(m)},updateGDP:function(e){var t=e.newEconPopulation,i=1e3*(1+(e.newLevel-1)/5)*(e.newEconStrength/20+e.newMorale/20);return Math.round(i*t)+Math.round(i*t*(e.ecGrowthRate/100))},upgradeTerrArmyFortLevel:function(){var e=1+App.Models.selectedTerrModel.get("fortLevel"),t=App.Models.selectedTerrModel.get("morale"),i=(t=Math.round(t+10*e),t=Math.min(t,100),App.Utilities.updateEconMorale({selectedFortLevel:e,newMorale:App.Models.selectedTerrModel.get("econMorale")})),o=App.Utilities.updateGDP({newMorale:i,newEconStrength:App.Models.selectedTerrModel.get("econStrength"),newEconPopulation:App.Models.selectedTerrModel.get("econPopulation"),newLevel:App.Models.selectedTerrModel.get("econLevel"),ecGrowthRate:App.Models.selectedTerrModel.get("econGrowthPct")});App.Models.selectedTerrModel.set({economicOutput:o,fortLevel:e,econMorale:i,fortLeveledUp:!0,morale:t})},upgradeTerrEconLevel:function(e,t){void 0===e&&(e=App.Models.selectedTerrModel);var i=parseInt(e.get("econLevel"))+1,o=e.get("econMorale"),a=App.Utilities.updateEconMorale({econLevel:i,newMorale:o}),n=App.Utilities.updateGDP({newLevel:i,newMorale:a,newEconStrength:e.get("econStrength"),newEconPopulation:e.get("econPopulation"),ecGrowthRate:e.get("econGrowthPct")}),r=!t;e.set({economicOutput:n,econLevel:i,econLeveledUp:r,econMorale:a,econLevelCost:App.Constants.ECON_LVL_UP_AMT*(1+i)}),App.Models.nationStats.get(e.get("side")).set("armyTechLvl",App.Collections.terrCollection.returnAvgTechLevel(e.get("side")))},upgradeTerrEconStr:function(e){void 0===e&&(e=App.Models.selectedTerrModel);var t=App.Utilities.updateEconMorale({econStrength:100,newMorale:e.get("econMorale")}),i=App.Utilities.updateGDP({newMorale:t,newEconStrength:100,newEconPopulation:e.get("econPopulation"),newLevel:e.get("econLevel"),ecGrowthRate:e.get("econGrowthPct")});e.set({economicOutput:i,econStrength:100,econStrengthCost:0,econMorale:t})},validateName:function(e,t){var i=function(){return"empire"==t?8:"territory"==t?15:void 0},o={};return e.length>i()?(o.errCode=1,o.msg="Your "+t+" name can not exceed "+i()+"&nbsp;characters."):e.length<2?(o.errCode=2,o.msg="Your "+t+" name must contain at least 2&nbsp;characters."):e.match(/^[a-zA-Z_ \.]*$/)?App.Collections.terrCollection.duplicateNameCheck(e,t)?(o.errCode=4,o.msg="Your "+t+" name must be&nbsp;unique."):(o.errCode=0,o.msg=""):(o.errCode=3,o.msg="Your "+t+" name must contain only letters and&nbsp;spaces."),o},validName:function(e,t){return!(e.length>t||e.length<2||!e.match(/^[a-zA-Z_ \.]*$/))},victoryTrackSource:function(){switch(App.Models.battleMapModel.get("mapMode")){case"civilwar":return"left"==App.Utilities.activeSide()?App.Constants.VICTORY_MUSIC[0].union:App.Constants.VICTORY_MUSIC[0].rebels;case"wargames":return App.Constants.VICTORY_MUSIC[0].wargames;case"college":return App.Constants.VICTORY_MUSIC[0].college;case"wallstreet":return App.Constants.VICTORY_MUSIC[0].wallstreet;default:return App.Constants.VICTORY_MUSIC[0].def}},warpEls:function(e){for(var t=0;t<e.length;t++)$(e[t]).each(function(){$(this).removeClass("tada").addClass("tada")})}}},App.Models.GameStart=Backbone.Model.extend({defaults:{allColorsArr:["blue","orange","green","purple","pink"],availableColorsArr:["green","purple","pink"],p1Color:"blue",p2Color:"orange"}}),App.Models.Territory=Backbone.Model.extend({defaults:{armyPopulation:App.Constants.START_ARMY_UNITS,armyPopulationCost:App.Constants.ARMY_UNIT_COST*App.Constants.RECRUIT_ARMY_MINIMUM,armyRecruits:0,attackRange:2,armyCasualties:0,armyRank:1,armyXP:0,armyWins:0,armyLosses:0,column:0,currTreasury:0,econCasualties:0,econGrowthPct:0,econLevel:1,econLevelCost:2e10,econLeveledUp:!1,econMorale:80,economicOutput:8e10,econPopulation:1e7,econPopulationGrowthPct:0,econStrength:80,econStrengthCost:2e9,fortLevel:1,fortLevelCost:2e9,fortLeveledUp:!1,fortStrength:100,fortStrengthCost:0,governorKilled:!1,inRange:!1,isCapital:!1,morale:80,name:"",prvEconPopulation:1e7,prvEconPopulationGrowthPct:0,prvPopulation:25e4,recruitTarget:!1,remainingTurns:1,row:0,runTimer:!1,selected:!1,side:"",color:"",startEconomicOutput:8e10,startEconPopulation:1e7,startPopulation:25e4,trainingArmyCost:App.Constants.ARMY_TRAINING_COST,trainingClicked:!1,small:!1},initialize:function(){},setName:function(e){this.set("name",e)},incomingUnitsAuto:function(e,t,i){var o=Math.round(t),a=App.Utilities.returnRecruitMoraleXPRank(e,t),n=e.get("econPopulation")-o,r=o+this.get("armyPopulation"),s=App.Utilities.updateEconMorale({newMorale:e.get("econMorale"),selectedArmyPop:r}),l=App.Utilities.updateGDP({newMorale:s,newEconStrength:e.get("econStrength"),newEconPopulation:n,newLevel:e.get("econLevel"),ecGrowthRate:e.get("econGrowthPct")}),p=App.Models.nationStats.get(i).get("econPopulationStart")-o;e.set({armyPopulation:r,armyRecruits:o,econPopulation:n,morale:a.toMorale,armyXP:a.toXP,armyRank:a.toRank,econMorale:s,economicOutput:l});var d=App.Collections.terrCollection.getSideTerritoriesWithRecruits(i),c=App.Collections.terrCollection.returnSideTotal(i,"armyRecruits");App.Models.nationStats.get(i).set({recruitsAuto:c,terrsWithRecruits:d,econPopulationStart:p}),App.Collections.terrCollection.nextTreasury()},incomingUnits:function(e,t){var i=e===App.Models.selectedTerrModel,o=Math.round(t),a=App.Models.selectedTerrModel.get("armyRecruits"),n=i?App.Utilities.returnRecruitMoraleXPRank(e,t):App.Utilities.returnNewMoraleXpRank(e,t),r=i?App.Models.selectedTerrModel.get("econPopulation")-t:App.Models.selectedTerrModel.get("econPopulation");if(i){a=t;var s=App.Collections.terrCollection.returnSideTotal(App.Utilities.activeSide(),"armyRecruits")+a}else{var l=App.Models.selectedTerrModel.get("armyPopulation")-o,p=App.Utilities.updateEconMorale({newMorale:App.Models.selectedTerrModel.get("econMorale"),selectedArmyPop:l}),d=App.Utilities.updateGDP({newMorale:p,newEconStrength:App.Models.selectedTerrModel.get("econStrength"),newEconPopulation:App.Models.selectedTerrModel.get("econPopulation"),newLevel:App.Models.selectedTerrModel.get("econLevel"),ecGrowthRate:App.Models.selectedTerrModel.get("econGrowthPct")});App.Models.selectedTerrModel.set({armyPopulation:l,morale:n.fromMorale,remainingTurns:0,selected:!1,econMorale:p,economicOutput:d})}t=o+this.get("armyPopulation");var c=i?this.get("remainingTurns")-1:this.get("remainingTurns");p=App.Utilities.updateEconMorale({newMorale:App.Models.clickedTerrModel.get("econMorale"),selectedArmyPop:t}),d=App.Utilities.updateGDP({newMorale:p,newEconStrength:App.Models.clickedTerrModel.get("econStrength"),newEconPopulation:r,newLevel:App.Models.clickedTerrModel.get("econLevel"),ecGrowthRate:App.Models.clickedTerrModel.get("econGrowthPct")});if(App.Models.clickedTerrModel.set({armyPopulation:t,morale:n.toMorale,armyXP:n.toXP,armyRank:n.toRank,econMorale:p,economicOutput:d,remainingTurns:c}),App.Models.selectedTerrModel.set({econPopulation:r,armyRecruits:a}),i){var g=App.Collections.terrCollection.getSideTerritoriesWithRecruits(App.Utilities.activeSide());App.Models.nationStats.get(App.Utilities.activeSide()).set({recruitsThisTurn:s,terrsWithRecruits:g})}setTimeout(function(){App.Utilities.flipEls([".armyPopulation-main"])},100),App.Collections.terrCollection.nextTreasury()}});var startLeftArmy=App.Constants.TESTING_MODE?2e7*App.Constants.STARTING_TERRITORIES:App.Constants.START_ARMY_UNITS*App.Constants.STARTING_TERRITORIES,startRightArmy=App.Constants.TESTING_MODE?2e7*App.Constants.STARTING_TERRITORIES:App.Constants.START_ARMY_UNITS*App.Constants.STARTING_TERRITORIES,initTreasury=App.Utilities.isMobile()?App.Constants.STARTING_TREASURY_MOB:App.Constants.STARTING_TREASURY,initInfraCost=App.Utilities.isMobile()?18e9:5e10,initEconPopulation=App.Utilities.isMobile()?9e7:25e7,initArmyPopulation=App.Utilities.isMobile()&&!App.Constants.TESTING_MODE?225e4:625e4,initEconOutput=App.Utilities.isMobile()&&!App.Constants.TESTING_MODE?72e10:2e12,Emp=Backbone.Model.extend({defaults:{activePolicies:App.Constants.POLICIES,activePolicyCount:0,clickedPolicy:"",armiesPromoted:[],armyPopulationStart:initArmyPopulation,armyPopulationNow:initArmyPopulation,armyCasualties:0,armyTechLvl:1,armyTrainingSpend:0,battleLosses:0,battleWins:0,color:"",econAvgTechLevel:1,econCasualties:0,econCrash:!1,econCrashTurn:0,econCrashTurnPrv:0,econCrashPenalty:0,econLevelSpend:0,econOutput:initEconOutput,econOutputStart:initEconOutput,econPopulationStart:initEconPopulation,econPopulationNow:initEconPopulation,empName:"",fortLevelSpend:0,fortsLost:[],highTaxTurnLength:0,infrastructureSpend:0,fortSpend:0,invadedThisTurn:[],invasionArmyCasualties:0,invasionEconCasualties:0,lowTaxTurnLength:0,nextTreasuryAddedEst:initTreasury,policyCosts:0,recruitsThisTurn:0,recruitsAuto:0,recruitSpend:0,repairAllInfrastructureCost:initInfraCost,repairAllFortCost:0,taxRate:.25,taxesCollected:0,terrs:[],terrsWithRecruits:[],terrsWithTurns:[],terrLostThisTurn:[],treasury:initTreasury,treasuryPrev:initTreasury,treasuryStart:initTreasury},returnLowTaxInfraDrag:function(){return Math.min(this.get("lowTaxTurnLength"),5)}}),LeftModel=new Emp({color:"blue"}),RightModel=new Emp({color:"orange"});App.Models.NationStats=Backbone.Model.extend({defaults:{currentTurn:App.Constants.START_TURN,sideTurn:"left",left:LeftModel,right:RightModel,fullScreen:!1},setPolicies:function(){App.Collections.leftPolCollection=new App.Collections.Policies,App.Collections.rightPolCollection=new App.Collections.Policies;for(var e=0;e<App.Constants.POLICIES.length;e++)App.Collections.leftPolCollection.add(App.Constants.POLICIES[e]),App.Collections.rightPolCollection.add(App.Constants.POLICIES[e])},getTaxRate:function(){return this.get(App.Utilities.activeSide()).get("taxRate")},setTaxRate:function(e){var t=App.Utilities.activeSide(),i=e>=App.Constants.HIGH_TAX_MORALE_AMT?Math.max(1,this.get(t).get("highTaxTurnLength")):0,o=e<=App.Constants.LOW_TAX_EC_CRASH_AMT?Math.max(1,this.get(t).get("lowTaxTurnLength")):0,a=parseInt(App.Collections.terrCollection.returnSideTotal(t,"economicOutput")*e);this.get(t).set({nextTreasuryAddedEst:a,taxRate:e,highTaxTurnLength:i,lowTaxTurnLength:o,econOutput:App.Collections.terrCollection.returnSideTotal(t,"economicOutput")})},setEmpName:function(e){this.get(App.Utilities.activeSide()).set("empName",e)},payForUpgradeAuto:function(e,t,i){App.Collections.terrCollection.nextTreasury(),App.Models.nationStats.get(t).set({treasury:e,treasuryPrev:e,policyCosts:i})},payForUpgrade:function(e){App.Collections.terrCollection.nextTreasury(),App.Models.nationStats.get(App.Utilities.activeSide()).set({treasury:e,treasuryPrev:e}),_.isEmpty(App.selectedTerrModel)||App.Models.selectedTerrModel.setClickedTreasuryLimits()},newTurnNationUpdates:function(){var e=this.get("left").get("highTaxTurnLength")?this.get("left").get("highTaxTurnLength"):0,t=this.get("right").get("highTaxTurnLength")?this.get("right").get("highTaxTurnLength"):0,i=this.get("left").get("lowTaxTurnLength")?this.get("left").get("lowTaxTurnLength"):0,o=this.get("right").get("lowTaxTurnLength")?this.get("right").get("lowTaxTurnLength"):0,a="left"!=this.get("sideTurn")?"left":"right",n=this.get("currentTurn");"left"!=this.get("sideTurn")&&(e=this.get("left").get("taxRate")>=App.Constants.HIGH_TAX_MORALE_AMT?this.get("left").get("highTaxTurnLength")+1:this.get("left").get("highTaxTurnLength"),t=this.get("right").get("taxRate")>=App.Constants.HIGH_TAX_MORALE_AMT?this.get("right").get("highTaxTurnLength")+1:this.get("right").get("highTaxTurnLength"),i=this.get("left").get("taxRate")<=App.Constants.LOW_TAX_EC_CRASH_AMT?this.get("left").get("lowTaxTurnLength")+1:this.get("left").get("lowTaxTurnLength"),o=this.get("right").get("taxRate")<=App.Constants.LOW_TAX_EC_CRASH_AMT?this.get("right").get("lowTaxTurnLength")+1:this.get("right").get("lowTaxTurnLength"),App.Collections.terrCollection.taxCollection(),App.Collections.terrCollection.nextTreasury(),n++),this.set({currentTurn:n,sideTurn:a});var r="left"===App.Utilities.activeSide()?e:t;App.Utilities.highTaxNotification(r);var s="left"===App.Utilities.activeSide()?i:o,l=App.Models.nationStats.get(App.Utilities.activeSide()).get("econCrashPenalty");App.Models.nationStats.get(App.Utilities.activeSide()).get("econCrash")?App.Utilities.crashNotification(l):App.Utilities.lowTaxNotification(s),this.get("left").set({highTaxTurnLength:e,lowTaxTurnLength:i,infrastructureSpend:0,fortSpend:0,econLevelSpend:0,fortLevelSpend:0,recruitSpend:0,armyTrainingSpend:0}),this.get("right").set({highTaxTurnLength:t,lowTaxTurnLength:o,infrastructureSpend:0,fortSpend:0,econLevelSpend:0,fortLevelSpend:0,recruitSpend:0,armyTrainingSpend:0})}}),App.Models.BattleZone=Backbone.Model.extend({defaults:{selectedMode:!1,mobileMode:!1,mapMode:"",mapType:"",randomMap:!1,territories:9,audio:!1,tipsMode:!0}}),App.Models.Modal=Backbone.Model.extend({defaults:{title:"",showCancelBtn:!0,confBtnClass:"btn-primary",confBtnId:"",confBtnTxt:"Confirm",noTurnsMsg:"",impactMsg:"",impactClass:"text-success",field1:"",field2:"",errorMsg1:"Test",errorMsg2:"",modalMsg:"",modalMsg2:"",modalView:{},attacking:{},defending:{},newObj:{},animationOver:!1,rangeMax:0,rangeMin:0,rangeDef:0,rangeStep:100,showRange:!1,stopClick:!1,notification:{}}}),App.Views.Terr=Backbone.View.extend({className:function(){var e="terr ";return this.model.get("small")&&(e+=" small "),this.model.get("inRange")&&(e+=" inrange "),this.model.get("recruitTarget")&&(e+=" reinforce "),0===this.model.get("remainingTurns")&&(e+=" noTurns "),this.model.get("isCapital")&&(e+=" capital "),this.model.get("selected")&&(e+=" selected "),e+=this.model.get("side")+" "+App.Models.nationStats.get(this.model.get("side")).get("color")},template:App.Utilities.template("terrTemplate"),initialize:function(){this.model.on("change",this.render,this),this.render(),App.Utilities.smallScreenOnly()?(this.events["click .army"]="terrClick",this.events["click .glyphicon-fire"]="terrClick",this.events["click .glyphicon-user"]="terrClick"):(this.events["mouseup .army"]="terrClick",this.events["mouseup .glyphicon-fire"]="terrClick",this.events["mouseup .glyphicon-user"]="terrClick",this.events["mouseup .army > label"]="terrClick",this.events["mouseup .army > h2"]="terrClick"),this.delegateEvents()},events:{"keyup .army":"terrFocus"},terrFocus:function(e){App.Utilities.isEnterKey(e)?this.terrClick():App.Utilities.isEscKey(e)&&this.unfocus()},render:function(){this.$el.html(this.template(this.model.toJSON()));var e=this.className();return this.$el.attr("class","terr"),this.$el.addClass(e),this},unfocus:function(){this.$el.find(".army").blur()},deselect:function(){App.Views.nationStatsView.closeMenu(),App.Views.battleMap.notify({icon:"glyphicon glyphicon-remove-sign",titleTxt:App.Models.clickedTerrModel.get("name")+" deselected.",delay:App.Constants.DELAY_SHORTEST}),App.Views.battleMap.deselect(),App.Utilities.isMobile()||this.$el.find(".army").focus()},terrClick:function(e){App.Utilities.removeClassName(["pulse","shake"]),App.Models.clickedTerrModel=this.model,App.Views.clickedTerrView=this;var t=App.Views.battleMap.model.get("selectedMode"),i=App.Models.clickedTerrModel.get("selected")&&t;if(0===App.Models.clickedTerrModel.get("remainingTurns")&&!t){var o=App.Models.clickedTerrModel.get("name");return App.Models.clickedTerrModel.get("side")===App.Utilities.activeSide()?App.Views.battleMap.notify({icon:"glyphicon glyphicon-exclamation-sign",titleTxt:o+" is out of&nbsp;turns.",msgTxt:"Select another territory from your empire, or click the End Turn&nbsp;button.",msgType:"warning",delay:App.Constants.DELAY_SHORTEST}):App.Views.battleMap.notify({icon:"glyphicon glyphicon-exclamation-sign",titleTxt:o+" belongs to the&nbsp;enemy.",msgTxt:"You must invade this territory with units from a territory of your&nbsp;own.",msgType:"warning",delay:App.Constants.DELAY_SHORTEST}),this.$el.find(".army").addClass("animated shake"),!1}if(i)return this.deselect(),App.Views.nationStatsView.render(),!1;if(!t){App.Views.nationStatsView.closeMenu();App.Models.clickedTerrModel.get("side");if(App.Utilities.console(App.Models.clickedTerrModel),App.Models.selectedTerrModel=App.Models.clickedTerrModel,App.Views.nationStatsView.render(),App.Utilities.returnSelectedTerritoryIsLimited(App.Models.selectedTerrModel)){var a=App.Utilities.returnSelectedTerritoryLimits(),n=(a.length,App.Models.clickedTerrModel.get("name")+"&nbsp;selected."),r="";a.moraleLimit&&!a.popLimit?r="Army can not attack. "+a.moraleLimit:!a.moraleLimit&&!a.invLimit||a.popLimit?r="Army can not attack or send reinforcements. "+a.popLimit:a.moraleLimit&&a.popLimit?r="Army can not attack or send reinforcements. "+a.popLimit+" "+a.moraleLimit:a.invLimit&&(r="Army can not invade. "+a.invLimit),App.Views.battleMap.notify({icon:"glyphicon glyphicon-exclamation-sign",titleTxt:n,msgTxt:r})}else App.Views.battleMap.notify({icon:"glyphicon glyphicon-ok-sign",titleTxt:App.Models.clickedTerrModel.get("name")+" selected.",msgTxt:"Select a territory in "+App.Utilities.getEnemyEmpireName()+" to attack or in "+App.Utilities.getActiveEmpireName()+" to send&nbsp;units.",delay:App.Constants.DELAY_SHORTEST});return App.Utilities.setClickedTreasuryLimits(),App.Views.selectedTerrView=this,App.Views.battleMap.model.set("selectedMode",!0),App.Models.clickedTerrModel.set("selected",!0),this.$el.find(".army").addClass("animated pulse"),t=!0,App.Views.selectedFooterView=new App.Views.Footer({model:App.Models.clickedTerrModel}),$("#footerZone").html(App.Views.selectedFooterView.$el),App.Utilities.smallScreenOnly()&&$("#selectedFixedRotator").width(App.Views.selectedFooterView.armyWidth),$("#game").addClass("selectedSection"),App.Utilities.displayInRange(),$("body").addClass("terrSelected"),App.Utilities.isMobile()||this.$el.find(".army").focus(),!1}var s=App.Models.selectedTerrModel.get("side")==App.Models.clickedTerrModel.get("side"),l="Send reinforcements from another territory and try&nbsp;again.",p="send reinforcements from another territory and try&nbsp;again.";if(p=App.Models.selectedTerrModel.get("fortStrength")<100?"Repair your fort and try again.":100===App.Models.selectedTerrModel.get("fortStrength")&&10!=App.Models.selectedTerrModel.get("fortLevel")?"Upgrade your fort to the next tech level and try again.":l,!s&&!this.model.get("inRange")){o=App.Models.clickedTerrModel.get("name");var d=App.Utilities.enoughPopToAttack(App.Models.selectedTerrModel),c=App.Models.selectedTerrModel.get("morale")>App.Constants.ATTACK_MORALE_MINIMUM,g=App.Models.selectedTerrModel.get("name");if(d&&c)return App.Views.battleMap.notify({icon:"glyphicon glyphicon-exclamation-sign",titleTxt:o+" is out of&nbsp;range.",msgType:"warning",delay:App.Constants.DELAY_SHORTEST}),this.$el.find(".army").addClass("animated shake"),!1;if(!d){var u="";return u=App.Models.selectedTerrModel.get("armyPopulation")>App.Constants.ATTACK_ARMY_MINIMUM?"Rebuild the damaged infrastructure in "+g+" so that your units can travel and attack other&nbsp;territories.":g+" does not have enough units ("+App.Constants.ATTACK_ARMY_MINIMUM+" min) to attack&nbsp;"+o+".\n\n"+l,App.Views.battleMap.notify({icon:"glyphicon glyphicon-exclamation-sign",titleTxt:g+" can not&nbsp;attack.",msgTxt:u,msgType:"warning"}),this.$el.find(".army").addClass("animated shake"),!1}if(!c)return u="The "+g+" army does not have enough morale ("+App.Constants.ATTACK_MORALE_MINIMUM+" min) to attack&nbsp;"+o+".\n\n"+p,App.Views.battleMap.notify({icon:"glyphicon glyphicon-exclamation-sign",titleTxt:g+" can not&nbsp;attack.",msgTxt:u,msgType:"warning"}),this.$el.find(".army").addClass("animated shake"),!1}var m=t&&!i&&s;if(!i&&t){var A=0<App.Models.selectedTerrModel.get("remainingTurns");g=App.Models.selectedTerrModel.get("name");if(A&&!m){g=App.Models.selectedTerrModel.get("name");var h=App.Models.clickedTerrModel.get("name");if(App.Models.clickedTerrModel.set("selected",!1),!App.Utilities.enoughPopToAttack(App.Models.selectedTerrModel)){u="";return u=App.Models.selectedTerrModel.get("armyPopulation")>App.Constants.ATTACK_ARMY_MINIMUM?"Rebuild the damaged infrastructure in "+g+" so that your units can travel and attack other&nbsp;territories.":g+" does not have enough units ("+App.Constants.ATTACK_ARMY_MINIMUM+" min) to attack&nbsp;"+h+".\n\n"+l,App.Views.battleMap.notify({icon:"glyphicon glyphicon-exclamation-sign",titleTxt:g+" can not&nbsp;attack.",msgTxt:u,msgType:"warning"}),this.$el.find(".army").addClass("animated shake"),!1}if(App.Models.selectedTerrModel.get("morale")<=App.Constants.ATTACK_MORALE_MINIMUM)return u=g+" does not have enough morale ("+App.Constants.ATTACK_MORALE_MINIMUM+" min) to attack&nbsp;"+h+".\n\n"+l,App.Views.battleMap.notify({icon:"glyphicon glyphicon-exclamation-sign",titleTxt:g+" can not&nbsp;attack.",msgTxt:u,msgType:"warning"}),this.$el.find(".army").addClass("animated shake"),!1;App.Views.clickedTerrView.attackTerr()}else if(A&&m){if(!App.Utilities.enoughPopToReinforce(App.Models.selectedTerrModel)){u="";return u=App.Models.selectedTerrModel.get("armyPopulation")>App.Constants.ATTACK_ARMY_MINIMUM?"Rebuild the damaged infrastructure in "+g+" so that your units can travel and attack other&nbsp;territories.":g+" does not have enough units ("+App.Constants.ATTACK_ARMY_MINIMUM+" min) to send reinforcements to&nbsp;"+App.Models.clickedTerrModel.get("name")+".\n\n"+l,App.Views.battleMap.notify({icon:"glyphicon glyphicon-exclamation-sign",titleTxt:g+" can not&nbsp;reinforce.",msgTxt:u,msgType:"warning"}),this.$el.find(".army").addClass("animated shake"),!1}App.Views.clickedTerrView.reinforceTerr()}}},attackTerr:function(){var e="Attack "+App.Models.clickedTerrModel.get("name")+" from "+App.Models.selectedTerrModel.get("name")+"?",t=App.Utilities.addCommas(App.Models.selectedTerrModel.get("armyPopulation")),i=App.Utilities.addCommas(App.Models.clickedTerrModel.get("armyPopulation")),o=25*App.Models.nationStats.get(App.Utilities.activeSide()).get("armyTechLvl"),a=25*App.Models.nationStats.get(App.Models.clickedTerrModel.get("side")).get("armyTechLvl"),n='<div class="pull-right"><span class="glyphicon glyphicon-user"></span> ('+App.Models.clickedTerrModel.get("armyWins")+" - "+App.Models.clickedTerrModel.get("armyLosses")+')</div><div><label class="top-label">Defender: '+App.Models.clickedTerrModel.get("name")+"</label></div><div><label>Army:</label> "+i+" units</div><div><label>Rank: "+App.Utilities.makeStarGroup({newRank:App.Models.clickedTerrModel.get("armyRank"),armyPromoted:!1})+"</label></div><div><label>Experience:</label> "+App.Models.clickedTerrModel.get("armyXP")+" XP</div><div><label>Morale:</label> "+App.Models.clickedTerrModel.get("morale")+"%</div><div><label>Avg Tech:</label> +"+a+'%</div><div class="fort-data"><div><label>Fort Strength: </label> '+App.Models.clickedTerrModel.get("fortStrength")+"%</div><div><label>Fort Level:</label> "+App.Models.clickedTerrModel.get("fortLevel")+"</div></div>",r='<div class="pull-right"><span class="glyphicon glyphicon-user"></span> ('+App.Models.selectedTerrModel.get("armyWins")+" - "+App.Models.selectedTerrModel.get("armyLosses")+')</div><div><label class="top-label">Attacker: '+App.Models.selectedTerrModel.get("name")+"</label></div><div><label>Army:</label> "+t+" units</div><div><label>Rank: "+App.Utilities.makeStarGroup({newRank:App.Models.selectedTerrModel.get("armyRank"),armyPromoted:!1})+"</label></div><div><label>Experience:</label> "+App.Models.selectedTerrModel.get("armyXP")+" XP</div><div><label>Morale:</label> "+App.Models.selectedTerrModel.get("morale")+"%</div><div><label>Avg Tech:</label> +"+o+"%</div>",s=Math.round(App.Models.selectedTerrModel.get("armyPopulation")*(App.Models.selectedTerrModel.get("econStrength")/100)),l=App.Models.selectedTerrModel.get("econStrength")<100?'<small class="text-danger text-center center-block">Only '+App.Utilities.addCommas(s)+" units available to invade due to "+App.Models.selectedTerrModel.get("econStrength")+"% infrastructure in "+App.Models.selectedTerrModel.get("name")+".</small>":"",p='<div class="modal-two-terr-container '+App.Models.selectedTerrModel.get("color")+'"><div class="col-xs-6 pull-'+App.Models.selectedTerrModel.get("side")+" "+App.Models.selectedTerrModel.get("color")+' modal-side-container">'+r+'</div><div class="col-xs-6 defender-col pull-'+App.Models.clickedTerrModel.get("side")+" "+App.Models.clickedTerrModel.get("color")+' modal-side-container">'+n+'</div><div class="clearfix"></div></div>'+l,d=new App.Models.Modal({title:e,confBtnId:"confAttack",modalMsg:p,noTurnsMsg:"Ends turn for "+App.Models.selectedTerrModel.get("name")+".",confBtnClass:"btn-danger"});new App.Views.ConfModal({model:d})},reinforceTerr:function(){var e=(App.Models.selectedTerrModel.get("armyPopulation")-App.Constants.ATTACK_ARMY_MINIMUM)*(App.Models.selectedTerrModel.get("econStrength")/100),t=(e=Math.round(e),App.Models.selectedTerrModel.get("econStrength")<100?'<small class="text-danger text-center center-block">Only '+App.Utilities.addCommas(e)+" reinforcements available due to "+App.Models.selectedTerrModel.get("econStrength")+"% infrastructure in&nbsp;"+App.Models.selectedTerrModel.get("name")+".</small>":""),i=App.Utilities.returnNewMoraleXpRank(App.Models.clickedTerrModel,Math.round(e/2)),o='<div class="pull-right"><span class="glyphicon glyphicon-user"></span> ('+App.Models.clickedTerrModel.get("armyWins")+" - "+App.Models.clickedTerrModel.get("armyLosses")+')</div><div><label class="top-label">To: '+App.Models.clickedTerrModel.get("name")+'</label></div><div><label>Army:</label> <span id="toUnits">'+App.Utilities.addCommas(App.Models.clickedTerrModel.get("armyPopulation")+Math.round(e/2))+'</span> Units</div><div><label>Rank: <span id="toRank">'+App.Utilities.makeStarGroup({newRank:i.toRank,armyPromoted:!1})+'</span></label></div><div><label>Experience:</label> <span id="toXP">'+i.toXP+'</span> XP</div><div><label>Morale:</label> <span id="toMorale">'+i.toMorale+"</span>%</div>",a='<div class="pull-right"><span class="glyphicon glyphicon-user"></span> ('+App.Models.selectedTerrModel.get("armyWins")+" - "+App.Models.selectedTerrModel.get("armyLosses")+')</div><div><label class="top-label">From: '+App.Models.selectedTerrModel.get("name")+'</label></div><div><label>Army:</label> <span id="remainingUnits">'+App.Utilities.addCommas(Math.round(e/2))+"</span> Units</div><div><label>Rank: "+App.Utilities.makeStarGroup({newRank:App.Models.selectedTerrModel.get("armyRank"),armyPromoted:!1})+"</label></div><div><label>Experience:</label> "+App.Models.selectedTerrModel.get("armyXP")+' XP</div><div><label>Morale:</label> <span id="fromMorale">'+i.fromMorale+"</span>%</div>",n='<div class="modal-two-terr-container '+App.Models.selectedTerrModel.get("color")+'"><div class="col-xs-6 reinf-col pull-left '+App.Models.selectedTerrModel.get("color")+' modal-side-container">'+a+'</div><div class="col-xs-6 reinf-col pull-right '+App.Models.clickedTerrModel.get("color")+' modal-side-container">'+o+'</div><div class="clearfix"></div></div>'+t+'<p class="form-text">How many army units would you like to send to&nbsp;'+App.Models.clickedTerrModel.get("name")+"?</p>",r=new App.Models.Modal({title:"Send Army Units from "+App.Models.selectedTerrModel.get("name")+" to&nbsp;"+App.Models.clickedTerrModel.get("name"),confBtnId:"confReinforce",modalMsg:n,impactMsg:"Strengthens army and citizen morale in "+App.Models.clickedTerrModel.get("name")+". Weakens both in "+App.Models.selectedTerrModel.get("name")+". Impacts army XP in&nbsp;"+App.Models.clickedTerrModel.get("name")+".",impactClass:"text-muted",noTurnsMsg:"Ends turn for "+App.Models.selectedTerrModel.get("name")+".",confBtnClass:"btn-danger",showRange:!0,rangeMin:App.Constants.ATTACK_ARMY_MINIMUM,rangeMax:e,rangeVal:Math.round(e/2)});new App.Views.SinglePromptModal({model:r})},invadeTerr:function(e,t,i){i.invaded,i.attacking;var o=(o=(App.Models.selectedTerrModel.get("armyPopulation")-App.Constants.ATTACK_ARMY_MINIMUM)*(App.Models.selectedTerrModel.get("econStrength")/100))-o%100,a=Math.min(Math.round(o/2)-Math.round(o/2)%100,App.Constants.ATTACK_INVADE_ARMY_MINIMUM),n=App.Models.selectedTerrModel.get("econStrength")<100?'<small class="text-danger text-center center-block">Only '+App.Utilities.addCommas(o)+" units available to invade due to "+App.Models.selectedTerrModel.get("econStrength")+"% infrastructure in&nbsp;"+App.Models.selectedTerrModel.get("name")+".</small>":"",r='<div class="pull-right"><span class="glyphicon glyphicon-user"></span> ('+App.Models.clickedTerrModel.get("armyWins")+" - "+App.Models.clickedTerrModel.get("armyLosses")+')</div><div><label class="top-label">To: <span class="newTerrName">'+App.Models.clickedTerrModel.get("name")+'</span></label></div><div><label>Army:</label> <span id="invadedUnits">'+App.Utilities.addCommas(a)+'</span> units</div><div><label>Rank: <span id="invadedRank">'+App.Utilities.makeStarGroup({newRank:App.Models.clickedTerrModel.get("armyRank"),armyPromoted:!1})+'</span></label></div><div><label>Experience:</label> <span id="invadedXP">'+App.Models.clickedTerrModel.get("armyXP")+'</span> XP</div><div><label>Morale:</label> <span id="invadedMorale">'+App.Models.selectedTerrModel.get("morale")+"</span>%</div>",s='<div class="pull-right"><span class="glyphicon glyphicon-user"></span> ('+App.Models.selectedTerrModel.get("armyWins")+" - "+App.Models.selectedTerrModel.get("armyLosses")+')</div><div><label class="top-label">From: '+App.Models.selectedTerrModel.get("name")+'</label></div><div><label>Army:</label> <span id="remainingUnits">'+App.Utilities.addCommas(App.Models.selectedTerrModel.get("armyPopulation")-a)+"</span> units</div><div><label>Rank: "+App.Utilities.makeStarGroup({newRank:App.Models.selectedTerrModel.get("armyRank"),armyPromoted:!1})+"</label></div><div><label>Experience:</label> "+App.Models.selectedTerrModel.get("armyXP")+' XP</div><div><label>Morale:</label> <span id="invaderMorale">'+App.Models.selectedTerrModel.get("morale")+"</span>%</div>",l='<div class="modal-two-terr-container '+App.Models.clickedTerrModel.get("color")+'"><div class="col-xs-6 reinf-col pull-'+App.Models.selectedTerrModel.get("side")+" "+App.Models.selectedTerrModel.get("color")+' modal-side-container">'+s+'</div><div class="col-xs-6 reinf-col pull-'+App.Models.clickedTerrModel.get("side")+" "+App.Models.clickedTerrModel.get("color")+' modal-side-container">'+r+'</div><div class="clearfix"></div></div><div class="clearfix"></div>'+n+'<p class="form-text">How many army units would you like to send from '+App.Models.selectedTerrModel.get("name")+' to secure&nbsp;<span class="newTerrName">'+App.Models.clickedTerrModel.get("name")+"</span>?</p>",p=new App.Models.Modal({title:"<span>"+App.Models.clickedTerrModel.get("name")+'</span> invaded<span id="renameMsg"></span>!',confBtnId:"confInvasion",modalMsg:l,modalMsg2:'<p class="form-text">Enter a new name for this territory:</p>',noTurnsMsg:"Ends turn for "+App.Models.selectedTerrModel.get("name")+".",confBtnClass:"btn-danger",attacking:e,defending:t,newObj:i,rangeMin:App.Constants.ATTACK_INVADE_ARMY_MINIMUM,rangeMax:o,rangeVal:a,showRange:!0});new App.Views.TwoPromptModal({model:p});$("#tp-input-2").val(App.Models.clickedTerrModel.get("name")),App.Utilities.selectOrFocus("tp-input-1")}}),App.Views.GameStart=Backbone.View.extend({template:App.Utilities.template("startUp"),initialize:function(){this.render(),App.Views.gameStartView=this,App.Utilities.detectIE()?this.events["change #terrNumberInput"]="toggleSliderLabel":this.events["input #terrNumberInput"]="toggleSliderLabel",this.delegateEvents();var e=App.Constants.AMBIENT_MUSIC[_.random(0,App.Constants.AMBIENT_MUSIC.length-1)],t=$('<audio id="ambientMusic" hidden><source src="'+e+'" type="audio/mpeg"> </audio>');$("body").append(t),t[0].volume=App.Utilities.smallScreenOnly()?.33:.25,t.bind("ended",App.Utilities.playNextTrack)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},events:{'keyup input[type="text"]':"validateSideName","click #declareWar":"declareWar","change .color-select":"updateIndicator","mouseover .color-select":"raiseColorIndicator","mouseout .color-select":"lowerColorIndicator","focus .color-select":"raiseColorIndicator","blur .color-select":"lowerColorIndicator","change #noSound":"toggleSound","change #randomMap":"toggleRandomMap","change #showTips":"toggleTips"},toggleSound:function(e){$(e.currentTarget)[0].checked?($("#ambientMusic")[0].play(),App.Models.battleMapModel.set("audio",!0),$("#soundState").text("On")):($("#ambientMusic")[0].pause(),App.Models.battleMapModel.set("audio",!1),$("#soundState").text("Off"))},toggleRandomMap:function(e){$(e.currentTarget)[0].checked?(App.Models.battleMapModel.set("randomMap",!0),$("#randomMapState").text("On")):(App.Models.battleMapModel.set("randomMap",!1),$("#randomMapState").text("Off"))},toggleTips:function(e){$(e.currentTarget)[0].checked?(App.Models.battleMapModel.set("tipsMode",!0),$("#tipsState").text("On")):(App.Models.battleMapModel.set("tipsMode",!1),$("#tipsState").text("Off"))},toggleSliderLabel:function(e){var t=parseInt(e.currentTarget.value);t===App.Constants.STARTING_TERRITORIES_MOB?($("#quickGame").removeClass("text-muted").addClass("active"),$("#longGame").addClass("text-muted").removeClass("active")):t===App.Constants.STARTING_TERRITORIES&&($("#longGame").removeClass("text-muted").addClass("active"),$("#quickGame").addClass("text-muted").removeClass("active"))},raiseColorIndicator:function(e){$(e.currentTarget).parent().parent().prev().find(".select-indicator").addClass("raised")},lowerColorIndicator:function(e){$(e.currentTarget).parent().parent().prev().find(".select-indicator").removeClass("raised")},validateSideName:function(e){$(".error").remove();var t=e.currentTarget.value,i=13===(window.event?e.keyCode:e.which),o=$('<p class="error"></p>'),a=App.Utilities.validateName(t,"empire"),n=0!=a.errCode;if(n)o.html(a.msg),$(e.currentTarget).addClass("invalid"),$(o).insertBefore($(".terr-slider-control")),$("#declareWar").prop("disabled",!0),$("#specialMap").remove();else{$(e.currentTarget).removeClass("invalid");var r=$("#leftName").val(),s=$("#rightName").val(),l=App.Views.gameStartView.isSpecialMode(r,s);if($("#specialMap").remove(),l&&0===$("#specialMap").length)$("<p class='bg-success text-center' id='specialMap'><span class='glyphicon glyphicon-globe'></span> Bonus unlocked!</p>").insertAfter($("#declareWar"));var p=0===App.Utilities.validateName(r,"empire").errCode&&0===App.Utilities.validateName(s,"empire").errCode;r!=s&&p?($("#declareWar").prop("disabled",!1),$(".invalid").removeClass("invalid"),i&&this.declareWar()):p&&(o.text("Your empire name must be unique."),$(e.currentTarget).addClass("invalid"),$(o).insertBefore($(".terr-slider-control")),$("#declareWar").prop("disabled",!0),$("#specialMap").remove())}i&&"leftName"===e.currentTarget.id&&!n&&""===$("#rightName").val()?$("#rightName").focus():i&&"rightName"===e.currentTarget.id&&!n&&""===$("#leftName").val()&&$("#leftName").focus()},updateIndicator:function(e){var t=$(e.currentTarget);t.parent().parent().parent().find(".select-indicator").attr("class","select-indicator raised "+t.val());var i=-1!=t.attr("id").indexOf("left")?"left":"right",o=t.val(),a=this.model.get("availableColorsArr"),n="left"==i?"p1":"p2",r=this.model.get(n+"Color");a.push(r);var s=a.indexOf(o);-1<s&&a.splice(s,1),this.model.set(n+"Color",o),this.model.set("availableColorsArr",a)},declareWar:function(){var e=App.Views.battleMap.$el.attr("class");if(App.Models.battleMapModel.get("randomMap"))if(-1!=e.indexOf("civil-war"))var t=e.indexOf("civil-war"),i=e.substring(0,t)+App.Views.battleMap.addMap();else{var o=e.indexOf("world-war");i=e.substring(0,o)+App.Views.battleMap.addMap()}else if(-1!=e.indexOf("texture")){var a="civilwar"==App.Models.battleMapModel.get("mapMode")?"civil-war":"world-war";t=e.indexOf("texture"),i=e.substring(0,t)+a}else a="civilwar"==App.Models.battleMapModel.get("mapMode")?"civil-war":"world-war",t=e.indexOf(a),i=e.substring(0,t)+a;App.Views.battleMap.$el.attr("class",i);var n=$("#leftName").val().trim(),r=$("#rightName").val().trim(),s=$("#leftColor").val(),l=$("#rightColor").val(),p=parseInt($("#terrNumberInput").val());if(App.Defaults.mobileMode=p!=App.Constants.STARTING_TERRITORIES,App.Models.battleMapModel.set({territories:p,mobileMode:App.Defaults.mobileMode}),App.Models.nationStats.get("left").set("color",s),App.Models.nationStats.get("right").set("color",l),App.Collections.terrCollection.changeColors(),App.Utilities.isMobile()&&"blue"==s&&"orange"==l||App.Utilities.restartSkipBeginning(),App.Views.gameStartView.isSpecialMode(n,r)){App.Collections.terrCollection.specialMap(n,r);var d="";if(!App.Models.battleMapModel.get("randomMap")&&(-1!=(n.toLowerCase()+r.toLowerCase()).indexOf("civilwar")||-1!=(n.toLowerCase()+r.toLowerCase()).indexOf("college"))){d="civil-war";var c=-1!=App.Views.battleMap.$el.attr("class").indexOf("world-war")?App.Views.battleMap.$el.attr("class").indexOf("world-war"):App.Views.battleMap.$el.attr("class").indexOf("texture");i=e.substring(0,c)+d;App.Models.battleMapModel.get("randomMap")||App.Views.battleMap.$el.attr("class",i)}}this.$el.parent().addClass("fadeout"),$("#game").addClass("fadein").attr("tabindex",""),$(".restart").attr("tabindex","");var g="<p>The world is in crisis! Citizens gripped by fear and fury as rival alliances wage war for world&nbsp;domination.</p>";if(0<App.Models.battleMapModel.get("mapMode").length){var u="joshua"===App.Models.battleMapModel.get("mapMode")||"wargames"===App.Models.battleMapModel.get("mapMode"),m="civilwar"===App.Models.battleMapModel.get("mapMode"),A="wallstreet"===App.Models.battleMapModel.get("mapMode"),h="makebelieve"===App.Models.battleMapModel.get("mapMode"),M="college"===App.Models.battleMapModel.get("mapMode");g=h?"<p>The fictional universe is in crisis! Empires have joined forces and declared war on each other for control of the human&nbsp;imagination.</p>":g,g=m?"<p>The Union is in crisis! A powerful confederation of rebel states has seceded from the Union and declared war on the United&nbsp;States.</p>":g,g=A?"<p>The world economy is in crisis! Millions in fear as price wars between rival companies turn bloody in battle for precious&nbsp;marketshare.</p>":g,g=M?"<p>The university system is in crisis! Dorms are barricaded across the nation as a new alliance of schools fight to establish a new college athletic&nbsp;association.</p>":g,n=u?"Allies":n,r=u?"Axis":r,n=m?"America":n,r=m?"Rebels":r,n=A?"NYSE":n,r=A?"NASDAQ":r,n=h?"Light":n,r=h?"Dark":r,n=M?"NCAA":n,r=M?"Alliance":r}if(u){$("body").append('<audio id="easterEgg" hidden><source src="audio/wargames.mp3" type="audio/mpeg"> </audio>'),$("#easterEgg")[0].play(),$("#easterEgg")[0].volume=1}App.Models.nationStats.get("left").set("empName",n),App.Models.nationStats.get("right").set("empName",r);var T="left"==App.Utilities.activeSide()?App.Collections.terrCollection.getSideCapital("right"):App.Collections.terrCollection.getSideCapital("left");App.Views.battleMap.notify({icon:"glyphicon glyphicon-globe",titleTxt:"War Declared!",msgTxt:g+"<p>Attack neighboring territories occupied by the enemy to expand your empire and take control of enemy resources. Invade the enemy capital ("+T+") to win the&nbsp;game.</p><p>To change tax rates, enact policies, and see details about your empire, click the menu button at the top corner of your&nbsp;screen.</p><p>Invest wisely in your economy and your military for the best chance of victory. Good&nbsp;luck!</p>",msgType:"info",delay:App.Constants.DELAY_INFINITE}),App.Utilities.launchFullScreen(document.documentElement),setTimeout(function(){App.Views.battleMap.smoothScroll(".terr:first-child"),App.Views.gameStartView.closeView(),$("#setup").remove()},600)},isSpecialMode:function(e,t){var i=e.toLowerCase(),o=t.toLowerCase();return-1!=["civilwar","wargames","joshua","wallstreet","makebelieve","college"].indexOf(i+o)},closeView:function(){this.unbind(),this.undelegateEvents(),this.remove()}}),App.Views.ColorView=Backbone.View.extend({template:App.Utilities.template("menuTemplate"),initialize:function(){this.model.on("change",this.render,this),this.render()},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),App.Views.RightColorView=Backbone.View.extend({template:App.Utilities.template("rightMenuTemplate"),initialize:function(){this.model.on("change",this.render,this),this.render()},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),App.Views.NationStats=Backbone.View.extend({el:"#nationStats",template:App.Utilities.template("sideStats"),initialize:function(){this.model.on("change",this.render,this),this.model.get("left").on("change",this.render,this),this.model.get("right").on("change",this.render,this),this.render()},className:function(){return App.Models.battleMapModel.get("mobileMode")?"mobile":""},render:function(){void 0!==t?t.off():void 0!==i&&i.off();var e=this.className();this.$el.addClass(e),this.$el.html(this.template(this.model.toJSON())),App.Utilities.console("Nation Stats View Rendered:"),App.Utilities.console(this.model);var t=$("#sidebar-main"),i=$("#sidebar-secondary"),o=Math.min(.45*Math.max(document.documentElement.clientWidth,window.innerWidth||0),300);return"left"==App.Utilities.activeSide()?t.simplerSidebar({attr:"sidebar-main",align:"left",mask:{display:!1},selectors:{trigger:"#sidebar-main-trigger",quitter:".quitter"},sidebar:{width:o}}):i.simplerSidebar({attr:"sidebar-secondary",mask:{display:!1},selectors:{trigger:"#sidebar-secondary-trigger",quitter:".quitter"},sidebar:{width:o}}),$(function(){$('[data-toggle="popover"]').popover("destroy"),$('[data-toggle="popover"]').popover()}),this},events:{"click .changeTax":"changeTax","click .sideName":"changeName","click .newTurn":"confirmNewTurn","click .restart":"restartGame","click .sideRebuildAllInf":"rebuildEmpInfrastructure","click .sideRebuildAllFort":"rebuildEmpForts","click .exitFullScreen":"exitFullScreen","click .launchFullScreen":"launchFullScreen","click .stopMusic":"stopMusic","click .startMusic":"startMusic","click .skipSong":"nextTrack","click .policy":"policyClick","click .disableTips":"disableTips","click .sidebarTerr":"selectTerr","click .budget":"budgetModal","click #recruitSidebar":"recruitSidebar"},selectTerr:function(e){var t=$(e.currentTarget).attr("data-cid");App.Collections.terrCollection.returnSelectedView(t).terrClick()},closeMenu:function(){$(".close-menu").trigger("click")},changeName:function(e){var t=e.currentTarget.getAttribute("data-side"),i=this.model.get(t).get("empName");if(!(App.Utilities.activeSide()===t))return App.Views.battleMap.notify({titleTxt:"You can't rename your enemy's&nbsp;empire.",msgType:"danger",icon:"glyphicon glyphicon-remove-sign"}),!1;var o=new App.Models.Modal({title:"Change Empire Name: "+i,confBtnId:"confNewEmpName",modalMsg:"<p>Enter your empire's new name:</p>"});new App.Views.SinglePromptModal({model:o})},changeTax:function(e){var t=e.currentTarget.getAttribute("data-side");if(!(App.Utilities.activeSide()===t))return App.Views.battleMap.notify({titleTxt:"You can't update your enemy's tax&nbsp;rate.",msgType:"danger",icon:"glyphicon glyphicon-remove-sign"}),!1;var i=App.Models.nationStats.get(t).get("empName"),o=App.Collections.terrCollection.returnSideTotal(t,"economicOutput"),a=Math.round(o*this.model.getTaxRate()),n=App.Utilities.addCommas(a),r=this.model.get(t).get("treasury")+a,s=(r=App.Utilities.addCommas(r),'<div class="row container-fluid"><label>Current Tax Rate:</label> '+parseInt(100*this.model.getTaxRate())+'%</div><div class="row container-fluid"><label>Est. Taxes Collected:</label> $<span id="projTaxes">'+n+'</span></div><div class="row container-fluid"><label>Est. Next Turn Treasury:</label> $<span id="projTreasury">'+r+'</span></div><p class="form-text"><label>New Tax Rate:</label> <span id="projTaxRate">'+parseInt(100*this.model.getTaxRate())+"</span>%</p>"),l=new App.Models.Modal({title:"Change Tax Rate: "+i,confBtnId:"confNewTaxRate",modalMsg:s,impactMsg:"Changing tax rates will impact citizen&nbsp;morale.",impactClass:"text-muted",rangeMax:100,rangeMin:0,rangeVal:Math.round(100*this.model.getTaxRate()),rangeStep:1,showRange:!0});new App.Views.SinglePromptModal({model:l});App.Utilities.isMobile()&&$("#spInput").attr("type","number"),$("#spInput").val(parseInt(100*this.model.getTaxRate()))},budgetModal:function(){var e=new App.Models.Modal({title:App.Utilities.getActiveEmpireName()+" "+App.Models.nationStats.get("currentTurn")+" Budget",confBtnId:"",modalMsg:'<div id="budgetTable"></div>',confBtnClass:"btn-primary",showCancelBtn:!1});new App.Views.ConfModal({model:e});App.Views.budgetView=new App.Views.BudgetView({model:App.Models.nationStats.get(App.Utilities.activeSide())}),$("#budgetTable").html(App.Views.budgetView.$el)},policyClick:function(e){this.model.get(App.Utilities.activeSide()).get("empName");var t=e.currentTarget.getAttribute("data-pol-id");App.Models.nationStats.set("clickedPolicy",t);var i=_.pluck(App.Models.nationStats.get(App.Utilities.activeSide()).get("activePolicies"),"id"),o=(i=_.indexOf(i,t),""),a=App.Models.nationStats.get(App.Utilities.activeSide()).get("activePolicies");o+="<h3>Available Policies</h3>",o+="<p>Policies are tasks that can be carried out in your empire automatically before the start of each year when funds are&nbsp;available.</p>",o+='<div class="available-policies-container">';for(var n=0;n<a.length;n++)0!=a[n].priority&&a[n].side===App.Utilities.activeSide()?o+='<label for="'+a[n].id+'"><input type="checkbox" id="'+a[n].id+'" value="'+a[n].id+'" name="available-policies" class="available-policies" checked> '+a[n].title+"</label>":a[n].side===App.Utilities.activeSide()&&(o+='<label for="'+a[n].id+'"><input type="checkbox" id="'+a[n].id+'" value="'+a[n].id+'" name="available-policies" class="available-policies"> '+a[n].title+"</label>");o+="</div>",o+='<div id="enactedPolicies"></div>';var r=new App.Models.Modal({title:"Update Policies",confBtnId:"confUpdatePolicy",modalMsg:o,confBtnClass:"btn-primary",showCancelBtn:!1});new App.Views.ConfModal({model:r});$("#oneModal .modal-dialog").addClass("modal-lg"),App.Views.policiesView=new App.Views.PolicyView({model:App.Models.nationStats.get(App.Utilities.activeSide())}),$("#enactedPolicies").html(App.Views.policiesView.$el)},confirmNewTurn:function(e){this.model.get(App.Utilities.activeSide()).get("empName");if(e){var t=new App.Models.Modal({title:"End Turn: Year "+App.Models.nationStats.get("currentTurn"),confBtnId:"confNewTurn",modalMsg:"<p>End turn for "+App.Utilities.getActiveEmpireName()+"?</p>",impactMsg:App.Collections.terrCollection.getSideTerritoriesWithTurns(App.Utilities.activeSide()).length+"/"+App.Collections.terrCollection.getSideTerritories(App.Utilities.activeSide()).length+" territory turns&nbsp;remaining.",impactClass:"text-muted",confBtnClass:"btn-danger"});new App.Views.ConfModal({model:t})}else App.Views.nationStatsView.updater()},disableTips:function(){App.Models.battleMapModel.set("tipsMode",!1),this.render()},exitFullScreen:function(){App.Utilities.exitFullScreen(),this.model.set("fullScreen",!1)},launchFullScreen:function(){App.Utilities.launchFullScreen(document.documentElement),this.model.set("fullScreen",!0)},recruitSidebar:function(){var e=$(".sidebar-recruit-menu").val();App.Collections.terrCollection.returnSelectedView(e).terrClick(),App.Utilities.recruitUnitsModal(App.Models.selectedTerrModel),App.Views.selectedFooterView.raiseFooter()},startMusic:function(){App.Models.battleMapModel.set("audio",!0),$("#ambientMusic")[0].play(),this.render()},stopMusic:function(){App.Models.battleMapModel.set("audio",!1),$("#ambientMusic")[0].pause(),this.render()},nextTrack:function(){App.Utilities.playNextTrack()},updater:function(){var e="left"===App.Utilities.activeSide(),t=e?App.Models.nationStats.get("currentTurn"):App.Models.nationStats.get("currentTurn")+1;if($("#dropFooter").hasClass("drop")&&App.Views.selectedFooterView.closeView(),App.Models.battleMapModel.get("tipsMode")&&t>App.Constants.START_TURN+3&&(App.Models.battleMapModel.set("tipsMode",!1),$('[data-toggle="popover"]').popover("destroy")),e)App.Views.battleMap.notify({icon:"glyphicon glyphicon-globe",titleTxt:"Start of Year "+App.Models.nationStats.get("currentTurn")+" for&nbsp;"+App.Models.nationStats.get("right").get("empName"),msgType:"info",delay:3,vert:"bottom",offset:20});else{var i=App.Collections.terrCollection.casualtiesTotal();if(0<i){var o=App.Utilities.addCommas(App.Collections.terrCollection.getSideCasualties("left","army")),a=App.Utilities.addCommas(App.Collections.terrCollection.getSideCasualties("left","econ")),n=App.Utilities.addCommas(App.Collections.terrCollection.getSideCasualties("right","army")),r=App.Utilities.addCommas(App.Collections.terrCollection.getSideCasualties("right","econ")),s=App.Collections.terrCollection.getSideCasualties("left","econ")+App.Collections.terrCollection.getSideCasualties("right","econ"),l=App.Collections.terrCollection.getSideCasualties("left","army")+App.Collections.terrCollection.getSideCasualties("right","army"),p=App.Utilities.addCommas(s+l),d="<ul class='casualties-list'><li>"+App.Models.nationStats.get("left").get("empName")+"</li><li>"+o+" Army casualties</li><li>"+a+" Civilian casualties</li></ul><ul class='casualties-list'><li>"+App.Models.nationStats.get("right").get("empName")+"</li><li>"+n+" Army casualties</li><li>"+r+" Civilian casualties</li></ul>";i=App.Utilities.addCommas(i),App.Views.battleMap.notify({icon:"glyphicon glyphicon-globe",titleTxt:"WAR RAGES ON, "+p+"&nbsp;DEAD",msgTxt:d,msgType:"info"}),App.Views.battleMap.notify({icon:"glyphicon glyphicon-globe",titleTxt:"Start of Year "+(1+App.Models.nationStats.get("currentTurn"))+" for&nbsp;"+App.Models.nationStats.get("left").get("empName"),msgType:"info",delay:3,vert:"bottom",offset:20})}else App.Views.battleMap.notify({icon:"glyphicon glyphicon-globe",titleTxt:"Start of Year "+(1+App.Models.nationStats.get("currentTurn"))+" for&nbsp;"+App.Models.nationStats.get("left").get("empName"),msgType:"info",delay:3,vert:"bottom",offset:20})}App.Collections.terrCollection.newTurnUpdate(),App.Constants.LOGGING&&(App.Utilities.console("Nation Stats Updated:"),App.Utilities.console(App.Models.nationStats.attributes)),App.Models.nationStats.newTurnNationUpdates(),App.Views.battleMap.deselect(),$(".turn-counter .glyphicon").removeClass("endOfTurn").addClass("endOfTurn"),$("."+App.Utilities.activeSide()+"-stats > .sideName").removeClass("tada").addClass("tada"),e||App.Utilities.warpEls([".treasury-tot",".changeTax"])},rebuildEmpInfrastructure:function(){var e=App.Collections.terrCollection.getSideTerritoriesWithTurns(App.Utilities.activeSide()).length===App.Collections.terrCollection.getSideTerritories(App.Utilities.activeSide()).length?"":" with turns&nbsp;remaining",t="<p>Spend $"+App.Utilities.addCommas(App.Collections.terrCollection.returnTotalCost("econStrength"))+" to repair damaged infrastructure in all territories"+e+"?</p>",i=new App.Models.Modal({title:"Repair All Infrastructure: "+App.Utilities.getActiveEmpireName(),confBtnId:"repairAllInfrastructure",impactMsg:"Strengthens citizen morale, population growth, and&nbsp;GDP.",modalMsg:t,affordAll:!1,confBtnTxt:"Repair All",repairAllId:""});new App.Views.ConfModal({model:i})},rebuildEmpForts:function(){var e=App.Collections.terrCollection.getSideTerritoriesWithTurns(App.Utilities.activeSide()).length===App.Collections.terrCollection.getSideTerritories(App.Utilities.activeSide()).length?"":" in territories with turns&nbsp;remaining",t="<p>Spend $"+App.Utilities.addCommas(App.Collections.terrCollection.returnTotalCost("fortStrength"))+" to repair all damaged forts"+e+"?</p>",i=new App.Models.Modal({title:"Repair All Forts: "+App.Utilities.getActiveEmpireName(),confBtnId:"repairAllFortStr",impactMsg:"Improves defense Strength bonus. Impacts citizen and army&nbsp;morale.",modalMsg:t,affordAll:!1,repairAllId:"",confBtnTxt:"Repair All"});new App.Views.ConfModal({model:i})},restartGame:function(e){void 0===e&&(e=!0);var t=new App.Models.Modal({title:"Restart Game",confBtnId:"confNewGame",modalMsg:"<p>Start a new game?</p>",confBtnClass:"btn-danger",showCancelBtn:e});new App.Views.ConfModal({model:t})}}),App.Views.BattleZone=Backbone.View.extend({template:App.Utilities.template("battleBox"),initialize:function(){App.Utilities.smallScreenOnly()&&this.model.set("tipsMode",!1),this.render()},className:function(){return App.Utilities.isMobile()?"mobile":""},addMap:function(){var e=["texture-0","texture-1","texture-2","texture-3","texture-4"];return App.Models.battleMapModel.get("randomMap")?e[_.random(0,e.length-1)]:"world-war"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$el.addClass(this.className()+" "+this.addMap()),this},deselect:function(){App.Utilities.removeClassName(["selected","selectedSection","pulse","shake"]),App.Collections.terrCollection.removeAttackRange(App.Models.selectedTerrModel),App.Collections.terrCollection.removeRecruitTarget(),this.model.set("selectedMode",!1),void 0!==App.Models.clickedTerrModel.cid&&App.Models.clickedTerrModel.set("selected",!1),App.Models.selectedTerrModel={},App.Views.selectedTerrView={},App.Models.clickedTerrModel={},App.Views.clickedTerrView={},void 0!==App.Views.selectedFooterView.cid&&App.Views.selectedFooterView.closeView(),App.Collections.terrCollection.returnAnyTurnsLeft()||(App.Views.nationStatsView.closeMenu(),App.Views.nationStatsView.confirmNewTurn(!1)),App.Models.nationStats.get("left").set({terrs:App.Collections.terrCollection.getSideTerritories("left"),terrsWithTurns:App.Collections.terrCollection.getSideTerritoriesWithTurns("left")}),App.Models.nationStats.get("right").set({terrs:App.Collections.terrCollection.getSideTerritories("right"),terrsWithTurns:App.Collections.terrCollection.getSideTerritoriesWithTurns("right")}),$("body").removeClass("terrSelected")},battle:function(e,t){App.Utilities.console("\n\n===================================ATTACK==================================="),App.Utilities.console(e.get("name")+" ("+e.get("armyPopulation")+" units) attacks "+t.get("name")+" ("+t.get("armyPopulation")+" units)!");var i,o=1+t.get("fortLevel")*t.get("fortStrength")/100/10,a=1<e.get("armyRank")?e.get("armyXP")+100*e.get("armyRank"):Math.max(e.get("armyXP"),1),n=1<t.get("armyRank")?t.get("armyXP")+100*t.get("armyRank"):Math.max(t.get("armyXP"),1);i=t.get("isCapital")?2.5:1;var r=1+.25*App.Models.nationStats.get(e.get("side")).get("armyTechLvl"),s=1+.25*App.Models.nationStats.get(t.get("side")).get("armyTechLvl"),l=Math.round(e.get("armyPopulation")*e.get("morale")*(1+a/100)*r/100),p=l/(l+Math.max(Math.round(t.get("armyPopulation")*t.get("morale")*(1+n/100)*o*s*i/100),1)),d=.9<p,c=d?Math.max(Math.random()-.1,0):Math.random(),g=d?Math.max(Math.random(),.2):Math.random(),u=Math.random(),m=Math.random();if(p<c){if(d){var A=t.get("armyPopulation")*g,h=0;for(h=50<t.get("morale")?10*A:5*A;.5<m||m<.25;)m=Math.random();for(var M=h/e.get("armyPopulation");M<u;)u=Math.random()}else{for(var T=e.get("armyPopulation")*u/t.get("armyPopulation");.25<m;)m=Math.random();for(;T<g;)g=Math.random()}this.updatePopulations(e,t,g,u,m)}else{if(d){for(var f,C=t.get("armyPopulation"),v=e.get("armyPopulation"),y=(80<e.get("morale")?4*C:10*C)/v;y<u;)u=Math.random();for(;m<.5;)m=Math.random();if(4<v/C)g=1;else for(w=u*v,f=Math.min(w/C,1);g<f&&1!==f;)g=Math.random();g=(g*C<w?C:g*C)==C?1:g}else{for(var S=t.get("armyPopulation")*g/e.get("armyPopulation");S<u;)u=Math.random();for(;.5<m||m<.35;)m=Math.random();var w;(w=u*e.get("armyPopulation"))>=t.get("armyPopulation")&&(g=1)}this.updatePopulations(e,t,g,u,m)}},updatePopulations:function(n,r,e,t,i){var o,a,s,l,p=r.get("armyPopulation"),d=Math.round(p*e),c=Math.max(p-d,0),g=r.get("fortStrength"),u=r.get("fortLevel"),m=Math.max(Math.round(g-i*g),1),A=r.get("side"),h=n.get("armyPopulation"),M=Math.round(h*t),T=Math.max(h-M,0),f=n.get("armyXP"),C=r.get("armyXP"),v=Math.min(Math.round(r.get("morale")*(c/p)*(h/T)*(M/d)),100),y=r.get("morale"),S=Math.min(Math.round(n.get("morale")*(T/h)*(p/c)*(d/M)),100),w=n.get("morale"),b=v<=10&&0<c&&c<2*App.Constants.ATTACK_ARMY_MINIMUM&&T*(n.get("econStrength")/100)>App.Constants.ATTACK_INVADE_ARMY_MINIMUM,R=T*(n.get("econStrength")/100)>App.Constants.ATTACK_INVADE_ARMY_MINIMUM&&c<2*App.Constants.ATTACK_ARMY_MINIMUM,U=(c=1===(e=1!=e&&(b||R)?1:e)&&(b||R)?0:c,1===e&&T*(n.get("econStrength")/100)>App.Constants.ATTACK_INVADE_ARMY_MINIMUM),k=1===e&&!U,P=(U=!k&&U,e=k?1-Math.round(2e3*Math.random())/r.get("armyPopulation"):e,c=k?Math.max(Math.round(p*(1-e)),0):c,e<t),x=P?Math.round(200*(t-e)/10):Math.round(200*(e-t)/10),E=Math.round(x/2),I=!1,N=!1,V=P?App.Models.selectedTerrModel.get("armyWins"):1+App.Models.selectedTerrModel.get("armyWins"),L=P?1+App.Models.clickedTerrModel.get("armyWins"):App.Models.clickedTerrModel.get("armyWins");newAttLosses=P?1+App.Models.selectedTerrModel.get("armyLosses"):App.Models.selectedTerrModel.get("armyLosses"),ue=P?App.Models.selectedTerrModel.get("armyLosses"):1+App.Models.clickedTerrModel.get("armyLosses"),P?(s=Math.min(C+App.Constants.XP_PER_BATTLE+x,100),a=Math.min(f+App.Constants.XP_PER_BATTLE+E,100),l=Math.min(App.Utilities.newRank(a,n),App.Constants.MAX_RANK),I=(o=Math.min(App.Utilities.newRank(s,r),App.Constants.MAX_RANK))>r.get("armyRank"),N=l>n.get("armyRank"),s=o===App.Constants.MAX_RANK?100===s?s:C+App.Constants.XP_PER_BATTLE+x:100===s?C+App.Constants.XP_PER_BATTLE+x-100:s,a=100===(a=l===App.Constants.MAX_RANK?100===a?a:f+App.Constants.XP_PER_BATTLE+E:100===a?f+App.Constants.XP_PER_BATTLE+E-100:a)?f+App.Constants.XP_PER_BATTLE+E-100:a,v=Math.min(v+3,100)):U?(L=V,ue=newAttLosses,a=Math.min(f+App.Constants.XP_PER_BATTLE+x,100),N=(o=l=Math.min(App.Utilities.newRank(a,n),App.Constants.MAX_RANK))>n.get("armyRank"),s=a=l===App.Constants.MAX_RANK?100===a?a:f+App.Constants.XP_PER_BATTLE+x:100===a?f+App.Constants.XP_PER_BATTLE+x-100:a,S=Math.min(S+5,100)):(s=Math.min(C+App.Constants.XP_PER_BATTLE+E,100),a=Math.min(f+App.Constants.XP_PER_BATTLE+x,100),l=Math.min(App.Utilities.newRank(a,n),App.Constants.MAX_RANK),I=(o=Math.min(App.Utilities.newRank(s,r),App.Constants.MAX_RANK))>r.get("armyRank"),N=l>n.get("armyRank"),s=l===App.Constants.MAX_RANK?100===s?s:C+App.Constants.XP_PER_BATTLE+E:100===s?C+App.Constants.XP_PER_BATTLE+E-100:s,a=l===App.Constants.MAX_RANK?100===a?a:f+App.Constants.XP_PER_BATTLE+x:100===a?f+App.Constants.XP_PER_BATTLE+x-100:a,S=Math.min(S+3,100));var O=n.get("econMorale"),F=App.Utilities.updateEconMorale({oldTerrArmyPop:h,selectedArmyPop:T,oldEconPop:n.get("prvEconPopulation"),newMorale:O}),G=n.get("econStrength"),B=n.get("econPopulation"),D=n.get("econLevel"),X=n.get("economicOutput"),W=App.Utilities.updateGDP({newMorale:F,newEconStrength:G,newEconPopulation:B,newLevel:D,ecGrowthRate:n.get("econGrowthPct")}),Y=r.get("econPopulation"),K=r.get("econStrength"),H=r.get("econLevel"),z=H,j=r.get("econMorale"),J=r.get("economicOutput"),q=r.get("econGrowthPct"),Z=App.Utilities.newEconPopCalc(Y,i,g),Q=App.Utilities.newEconStrengthCalc(K,i,g);Q<=0&&1<H?(Q+=100,z=H-1):Q<0&&1==H&&(Q=0);var ee=!1,te=u;if(m<=5&&1<u){m=u=1,ee=!0;var ie=App.Models.nationStats.get(A).get("fortsLost").slice();ie.push(r.get("name")),App.Models.nationStats.get(A).set("fortsLost",ie),App.Views.battleMap.notify({icon:"glyphicon glyphicon-globe",titleTxt:"Fort destroyed at&nbsp;"+App.Models.clickedTerrModel.get("name")+"!",msgType:"success"})}var oe=!1;!r.get("isCapital")&&!r.get("governorKilled")&&.01<1-Z/Y&&Math.random()<.1&&(oe=!0,r.set("governorKilled",!0));var ae=App.Utilities.updateEconMorale({governorCasualty:oe,selectedArmyPop:c,selectedFortStrength:m,econLevel:z,econStrength:Q,econPopulation:Z,newMorale:j,oldTerrArmyPop:p,selectedFortLevel:u}),ne=App.Utilities.updateGDP({newLevel:z,newEconPopulation:Z,newEconStrength:Q,newMorale:ae,ecGrowthRate:q}),re=n.get("armyCasualties")+(h-T),se=r.get("armyCasualties")+(p-c),le=r.get("econCasualties")+(Y-Z);if(n.set({morale:S,armyCasualties:re,armyPopulation:T,prvPopulation:h,armyXP:a,armyRank:l,economicOutput:W,econMorale:F,armyWins:V,armyLosses:newAttLosses}),r.set({morale:v,armyCasualties:se,fortStrength:m,fortLevel:u,armyPopulation:c,prvPopulation:p,armyXP:s,armyRank:o,econCasualties:le,econPopulation:Z,prvEconPopulation:Z,econLevel:z,econStrength:Q,economicOutput:ne,econMorale:ae,armyWins:L,armyLosses:ue}),U){App.Collections.terrCollection.battleImpact(n,!0);var pe=n.get("side"),de=r.get("side"),ce=App.Models.nationStats.get(de).get("invasionArmyCasualties")+se,ge=App.Models.nationStats.get(de).get("invasionEconCasualties")+le,ue=(V=App.Models.nationStats.get(pe).get("battleWins")+1,App.Models.nationStats.get(de).get("battleLosses")+1),me=App.Models.nationStats.get(pe).get("invadedThisTurn").slice();me.push(r.get("name"));var Ae=App.Models.nationStats.get(de).get("terrLostThisTurn").slice();Ae.push(r.get("name")),App.Models.nationStats.get(pe).set({armyPopulationNow:App.Collections.terrCollection.returnSideTotal(pe,"armyPopulation"),battleWins:V,invadedThisTurn:me,econPopulationNow:App.Collections.terrCollection.returnSideTotal(pe,"armyPopulation")}),App.Models.nationStats.get(de).set({armyPopulationNow:App.Collections.terrCollection.returnSideTotal(de,"armyPopulation"),battleLosses:ue,terrLostThisTurn:Ae,invasionEconCasualties:ge,invasionArmyCasualties:ce}),this.updateMessage(n,r);var he,Me=App.Models.nationStats.get(n.get("side")).get("empName"),Te=App.Models.nationStats.get(r.get("side")).get("empName");if(r.get("isCapital")){App.Models.battleMapModel.get("audio")&&($("#ambientMusic").unbind(),App.Utilities.playVictoryTrack(),$("#ambientMusic").bind("ended",App.Utilities.playVictoryTrack));var fe=.5<Math.random();he=fe?"The notorious leader of "+Te+" refused to surrender and was killed in battle. All remaining enemy forces quickly surrendered in the&nbsp;aftermath.":"The notorious leader of "+Te+" was captured attempting to escape the capital and has ordered the unconditional surrender of all enemy&nbsp;forces.";var Ce=n.get("armyPopulation"),ve=Ce-App.Constants.ATTACK_ARMY_MINIMUM;r.set({morale:100,armyPopulation:ve,selected:!1,side:pe,armyXP:a,armyRank:l,econCasualties:0,armyCasualties:0}),n.set({morale:100,armyPopulation:Ce-ve,armyXP:a,armyRank:l}),App.Collections.terrCollection.nextTreasury(),App.Views.battleMap.notify({icon:"glyphicon glyphicon-globe",titleTxt:"Game Over",msgTxt:Me+" defeats&nbsp;"+Te+"!",msgType:"success"}),setTimeout(function(){var e="";App.Models.nationStats.get("currentTurn")-App.Constants.START_TURN==1?e=" 1 year ":App.Models.nationStats.get("currentTurn")-App.Constants.START_TURN==0?e=" months ":1<App.Models.nationStats.get("currentTurn")-App.Constants.START_TURN&&(e=App.Models.nationStats.get("currentTurn")-App.Constants.START_TURN+" years ");var t="";t=-1!=App.Models.battleMapModel.get("mapMode").indexOf("college")?" the "+r.get("name")+" campus":-1!=App.Models.battleMapModel.get("mapMode").indexOf("wallstreet")?" the trading floor of "+r.get("name"):" the streets of "+r.get("name");var i="";i=-1!=App.Models.battleMapModel.get("mapMode").indexOf("college")?" secured the future for your athletic&nbsp;association":-1!=App.Models.battleMapModel.get("mapMode").indexOf("wallstreet")?" driven your competition from the&nbsp;marketplace":-1!=App.Models.battleMapModel.get("mapMode").indexOf("civilwar")?" secured the future for your great&nbsp;nation":" secured the future for your glorious&nbsp;empire";var o="<p>Your forces march through "+t+"! After "+e+" of bloodshed and countless lives lost, the "+n.get("color")+" flag has been raised over the "+Te+"&nbsp;capital!</p><p>"+he+"</p><p>Your triumph has brought glory to the people of "+Me+" and "+i+".</p>",a=new App.Models.Modal({title:Me+" Victory!",confBtnId:"confEnd",modalMsg:o,confBtnClass:"btn-danger",showCancelBtn:!1});new App.Views.ConfModal({model:a});$("#oneModal").on("hidden.bs.modal",function(e){$("#oneModal").off(),App.Views.battleMap.deselect(),App.Models.nationStats.set("sideTurn","left"),App.Views.nationStatsView.restartGame(!1)})},600)}else{if(newObj={invaded:{newEconStrength:Q,newEconPopulation:Z,newEconLvl:z,oldDefFortLvl:u,newDefFortStr:m,newEconMorale:ae,newDefPop:c},attacking:{newAttXP:a,newAttPop:T,newAttArmyRank:l}},"left"===App.Utilities.activeSide()){var ye=_.indexOf(App.Views.rightViews,App.Views.clickedTerrView);App.Views.leftViews.push(App.Views.rightViews[ye]),App.Views.rightViews=_.without(App.Views.rightViews,App.Views.rightViews[ye])}else{ye=_.indexOf(App.Views.leftViews,App.Views.clickedTerrView);App.Views.rightViews.push(App.Views.leftViews[ye]),App.Views.leftViews=_.without(App.Views.leftViews,App.Views.leftViews[ye])}App.Utilities.console("Invasion complete:"),App.Utilities.console("App.Views.leftViews:"),App.Utilities.console(App.Views.leftViews),App.Utilities.console("App.Views.rightViews:"),App.Utilities.console(App.Views.rightViews),App.Views.battleMap.battleResultWindow({attackerWins:!0,attackerCivilianMoraleImpact:F-O,attackerGDPImpact:W-X,attackerRankUp:N,defenderFortDamage:g-m,defenderStartFortLevel:te,defenderFortDestroyed:ee,defenderInfrastructureDamage:K-Q,defenderCivilianCasualties:Y-Z,defenderCivilianMoraleImpact:j-ae,defenderGDPImpact:J-ne,defenderRankUp:I,oldAttMorale:w,oldDefMorale:y,invasion:!0,loser:r,loserCas:p-c,loserGainedXP:s-C,loserMoraleImpact:v-y,winner:n,winnerCas:h-T,winnerGainedXP:a-f,winnerMoraleImpact:S-w,newObj:newObj})}}else if(P){App.Collections.terrCollection.battleImpact(r,!1),this.updateMessage(r,n);Se=n.get("side"),A=r.get("side");App.Models.nationStats.get(Se).set({armyPopulationNow:App.Collections.terrCollection.returnSideTotal(Se,"armyPopulation"),battleLosses:App.Models.nationStats.get(Se).get("battleLosses")+1}),App.Models.nationStats.get(A).set({armyPopulationNow:App.Collections.terrCollection.returnSideTotal(A,"armyPopulation"),battleWins:App.Models.nationStats.get(A).get("battleWins")+1,econPopulationNow:App.Collections.terrCollection.returnSideTotal(A,"econPopulation")}),App.Views.battleMap.battleResultWindow({attackerWins:!1,attackerCivilianMoraleImpact:F-O,attackerGDPImpact:W-X,attackerRankUp:N,defenderFortDamage:g-m,defenderStartFortLevel:te,defenderFortDestroyed:ee,defenderInfrastructureDamage:K-Q,defenderCivilianCasualties:Y-Z,defenderCivilianMoraleImpact:j-ae,defenderGDPImpact:J-ne,defenderRankUp:I,defGovCas:oe,oldAttMorale:w,oldDefMorale:y,invasion:!1,loser:n,loserCas:h-T,loserGainedXP:a-f,loserMoraleImpact:S-w,winner:r,winnerCas:p-c,winnerGainedXP:s-C,winnerMoraleImpact:v-y,battleNotification:App.Utilities.randomBattleOutcome({attCasRate:t,defCasRate:e,attArmyCas:h-T,defArmyCas:p-c,defCivCas:Y-Z})}),we()}else{App.Collections.terrCollection.battleImpact(n,!1),this.updateMessage(n,r);var Se=n.get("side"),A=r.get("side");App.Models.nationStats.get(Se).set({armyPopulationNow:App.Collections.terrCollection.returnSideTotal(Se,"armyPopulation"),battleWins:App.Models.nationStats.get(Se).get("battleWins")+1}),App.Models.nationStats.get(A).set({armyPopulationNow:App.Collections.terrCollection.returnSideTotal(A,"armyPopulation"),battleLosses:App.Models.nationStats.get(A).get("battleLosses")+1,econPopulationNow:App.Collections.terrCollection.returnSideTotal(A,"econPopulation")}),App.Views.battleMap.battleResultWindow({attackerWins:!0,attackerCivilianMoraleImpact:F-O,attackerGDPImpact:W-X,attackerRankUp:N,defenderFortDamage:g-m,defenderStartFortLevel:te,defenderFortDestroyed:ee,defenderInfrastructureDamage:K-Q,defenderCivilianCasualties:Y-Z,defenderCivilianMoraleImpact:j-ae,defenderGDPImpact:J-ne,defenderRankUp:I,defGovCas:oe,oldAttMorale:w,oldDefMorale:y,invasion:!1,loser:r,loserCas:p-c,loserGainedXP:s-C,loserMoraleImpact:v-y,winner:n,winnerCas:h-T,winnerGainedXP:a-f,winnerMoraleImpact:S-w,battleNotification:App.Utilities.randomBattleOutcome({attCasRate:t,defCasRate:e,attArmyCas:h-T,defArmyCas:p-c,defCivCas:Y-Z})}),we()}function we(){App.Models.nationStats.get("left").set({armyCasualties:App.Collections.terrCollection.getSideCasualties("left","army"),econCasualties:App.Collections.terrCollection.getSideCasualties("left","econ"),repairAllInfrastructureCost:App.Collections.terrCollection.returnTotalCost("econStrength","left"),repairAllFortCost:App.Collections.terrCollection.returnTotalCost("fortStrength","left")}),App.Models.nationStats.get("right").set({armyCasualties:App.Collections.terrCollection.getSideCasualties("right","army"),econCasualties:App.Collections.terrCollection.getSideCasualties("right","econ"),repairAllInfrastructureCost:App.Collections.terrCollection.returnTotalCost("econStrength","right"),repairAllFortCost:App.Collections.terrCollection.returnTotalCost("fortStrength","right")}),App.Models.selectedTerrModel.set({remainingTurns:App.Models.selectedTerrModel.get("remainingTurns")-1,selected:!1})}App.Collections.terrCollection.nextTreasury()},smoothScroll:function(e){document.querySelector(e).scrollIntoView({behavior:"smooth"})},battleResultWindow:function(a){var e=a.invasion?"invasionStep":"battleNot",t=a.invasion?"btn-primary":"btn-danger",i=a.invasion?"":"Ends turn for "+App.Models.selectedTerrModel.get("name")+".",o=a.attackerWins?a.winner:a.loser,n=a.attackerWins?a.loser:a.winner,r=a.invasion?a.newObj:"",s=a.attackerWins?App.Models.selectedTerrModel.get("name")+" strikes "+App.Models.clickedTerrModel.get("name"):App.Models.selectedTerrModel.get("name")+" army retreats";s=a.invasion?App.Models.clickedTerrModel.get("name")+" invaded":s;for(var l,p=n.previous("economicOutput")+a.defenderGDPImpact,d=n.get("economicOutput"),c=Ee(p,d),g=_e(p,d),u=n.get("econPopulation")+a.defenderCivilianCasualties,m=n.get("econPopulation"),A=Ee(u,m),h=_e(u,m),M=n.get("econStrength")+a.defenderInfrastructureDamage,T=M,f=n.get("econStrength"),C=f,v=n.previous("econMorale")+a.defenderCivilianMoraleImpact,y=v,S=n.get("econMorale"),w=S,b=a.attackerWins?n.get("armyPopulation")+a.loserCas:n.get("armyPopulation")+a.winnerCas,R=n.get("armyPopulation"),U=Ee(b,R),k=_e(b,R),P=a.oldDefMorale,x=P,E=a.invasion?0:n.get("morale"),_=E,I=n.get("fortStrength")+a.defenderFortDamage,N=I,V=n.get("fortStrength")<=5?0:n.get("fortStrength"),L=V,O=a.attackerWins?n.get("armyXP")-a.loserGainedXP:n.get("armyXP")-a.winnerGainedXP,F=O,G=a.invasion?0:n.get("armyXP"),B=G,D=o.previous("economicOutput")-a.attackerGDPImpact,X=o.get("economicOutput"),W=Ee(D,X),Y=_e(D,X),K=o.get("econPopulation"),H=K,z=o.previous("econMorale")-a.attackerCivilianMoraleImpact,j=z,J=o.get("econMorale"),q=J,Z=a.attackerWins?o.get("armyPopulation")+a.winnerCas:o.get("armyPopulation")+a.loserCas,Q=o.get("armyPopulation"),ee=Ee(Z,Q),te=_e(Z,Q),ie=a.oldAttMorale,oe=ie,ae=o.get("morale"),ne=ae,re=a.attackerWins?o.get("armyXP")-a.winnerGainedXP:o.get("armyXP")-a.loserGainedXP,se=re,le=o.get("armyXP"),pe=le,de=["def","GDP",c,g,"GDP","$"+App.Utilities.addCommas(p),"$"+App.Utilities.addCommas(d),App.Models.nationStats.get(n.get("side")).get("color")],ce=["def","EconPop",A,h,"Population",App.Utilities.addCommas(u),App.Utilities.addCommas(m),App.Models.nationStats.get(n.get("side")).get("color")],ge=["def","EconMor",v,S,"Morale",y+"%",w+"%",App.Models.nationStats.get(n.get("side")).get("color")],ue=["def","EconStr",M,f,"Infrastructure",T+"%",C+"%",App.Models.nationStats.get(n.get("side")).get("color")],me=["att","GDP",W,Y,"GDP","$"+App.Utilities.addCommas(D),"$"+App.Utilities.addCommas(X),App.Models.nationStats.get(o.get("side")).get("color")],Ae=["att","EconPop",100,100,"Population",App.Utilities.addCommas(K),App.Utilities.addCommas(H),App.Models.nationStats.get(o.get("side")).get("color")],he=["att","EconMor",z,J,"Morale",j+"%",q+"%",App.Models.nationStats.get(o.get("side")).get("color")],Me=["att","EconStr",o.get("econStrength"),o.get("econStrength"),"Infrastructure",o.get("econStrength")+"%",o.get("econStrength")+"%",App.Models.nationStats.get(o.get("side")).get("color")],Te=[["def","ArmyPop",U,k,"Units",App.Utilities.addCommas(b),App.Utilities.addCommas(R),App.Models.nationStats.get(n.get("side")).get("color")],["def","ArmyMor",P,E,"Morale",x+"%",_+"%",App.Models.nationStats.get(n.get("side")).get("color")],["def","ArmyXP",O,G,"XP",F,B,App.Models.nationStats.get(n.get("side")).get("color")],["def","FortStr",I,V,"Fort Strength",N+"%",L+"%",App.Models.nationStats.get(n.get("side")).get("color")],["att","ArmyPop",ee,te,"Units",App.Utilities.addCommas(Z),App.Utilities.addCommas(Q),App.Models.nationStats.get(o.get("side")).get("color")],["att","ArmyMor",ie,ae,"Morale",oe+"%",ne+"%",App.Models.nationStats.get(o.get("side")).get("color")],["att","ArmyXP",re,le,"XP",se,pe,App.Models.nationStats.get(o.get("side")).get("color")],["att","FortStr",o.get("fortStrength"),o.get("fortStrength"),"Fort Strength",o.get("fortStrength")+"%",o.get("fortStrength")+"%",App.Models.nationStats.get(o.get("side")).get("color")],de,ce,ge,ue,me,Ae,he,Me],fe=[],Ce=0,ve={},ye=a.attackerRankUp?{newRank:o.get("armyRank"),armyPromoted:!0}:{newRank:o.get("armyRank"),armyPromoted:!1},Se=a.defenderRankUp?{newRank:n.get("armyRank"),armyPromoted:!0}:{newRank:n.get("armyRank"),armyPromoted:!1},we=a.attackerRankUp?App.Utilities.makeStarGroup(ye):"",be=a.defenderRankUp?App.Utilities.makeStarGroup(Se):"",Re=a.defenderFortDestroyed?'<p class="text-center battle-update"><strong><span class="glyphicon glyphicon-fire" aria-hidden="true"></span> Fort destroyed!</strong></p>':"",Ue=a.attackerRankUp?'<p class="text-center battle-update"><strong>'+we+"</strong></p>":"",ke=a.defenderRankUp?'<p class="text-center battle-update"><strong>'+be+"</strong></p>":"",Pe=a.defenderRankUp||a.attackerRankUp||a.defenderFortDestroyed?'<div class="col-xs-6 pull-'+n.get("side")+'">'+Re+ke+'</div><div class="col-xs-6 pull-'+o.get("side")+'">'+Ue+"</div>":"";Ce<Te.length;)ve={barid:Te[Ce][0]+Te[Ce][1]+"Bar",widthVal:Te[Ce][2],updateWidthVal:Te[Ce][3],labelText:Te[Ce][4],textid:Te[Ce][0]+Te[Ce][1]+"Txt",textVal:Te[Ce][5],updatedTextVal:Te[Ce][6],color:Te[Ce][7]},0===Ce?l='<div class="row battle-result"><div class="col-xs-6 pull-'+n.get("side")+'"><h3 class="text-center" id="defHeading">Defender: '+n.get("name")+'</h3></div><div class="col-xs-6 pull-'+o.get("side")+'"><h3 class="text-center" id="attHeading">Attacker: '+o.get("name")+'</h3></div><div class="clearfix"></div>'+Pe+'<div class="container-fluid"><h3 class="text-center charts-header">Army</h3></div><div class="col-xs-6 pull-'+n.get("side")+" "+n.get("side")+'-side-color">':4===Ce?l+='</div><div class="col-xs-6 pull-'+o.get("side")+" "+o.get("side")+'-side-color">':8==Ce?l+='</div><div class="clearfix"></div><div class="container-fluid"><h3 class="text-center charts-header">Economy</h3></div><div class="col-xs-6 pull-'+n.get("side")+" "+n.get("side")+'-side-color">':12==Ce?l+='</div><div class="col-xs-6 pull-'+o.get("side")+" "+o.get("side")+'-side-color">':15==Ce&&(fe.push(ve),l+=xe(ve),l+='</div><div class="clearfix"></div></div>'),15!=Ce&&(fe.push(ve),l+=xe(ve)),Ce++;function xe(e){return'<button class="fort-label no-btn current"><div id="'+e.barid+'" class="prog-bar '+e.color+'" data-start-val="'+e.widthVal+'" data-end-val="'+e.updateWidthVal+'" style="width: '+e.widthVal+'%"></div><div class="prog-txt"><strong>'+e.labelText+' <span class="prog-bar-text-val" id="'+e.textid+'" data-start-val="'+e.textVal+'" data-end-val="'+e.updatedTextVal+'">'+e.textVal+"</span></strong></div></button>"}function Ee(e,t){return t<e?100:e/t*100}function _e(e,t){return t<e?100-Math.abs(e-t)/e*100:100}l+=App.Utilities.isMobile()?'<p class="br-alert text-center">Tap each bar to see the impact from the battle.</p>':"";var Ie=new App.Models.Modal({title:s,confBtnId:e,showCancelBtn:!1,modalMsg:l,noTurnsMsg:i,confBtnClass:t,attacking:o,defending:n,newObj:r,animationOver:!1,notification:a.battleNotification,govKilled:a.defGovCas}),Ne=new App.Views.ConfModal({model:Ie});$("#oneModal .modal-dialog").addClass("modal-lg"),$("#oneModal .modal-title").addClass("headline-title"),setTimeout(function(){var e=a.attackerWins?"":"animated pulse",t=(e=a.invasion?"animated hinge":e,a.attackerWins?"animated pulse":"");$("#defHeading").addClass(e),$("#attHeading").addClass(t);for(var i=[["def","GDP",g+"%","$"+App.Utilities.addCommas(d)],["def","EconPop",h+"%",App.Utilities.addCommas(m)],["def","EconStr",f+"%",C+"%"],["def","EconMor",w+"%",w+"%"],["def","ArmyPop",k+"%",App.Utilities.addCommas(R)],["def","ArmyMor",_+"%",_+"%"],["def","ArmyXP",B+"%",B],["def","FortStr",V+"%",L+"%"],["att","GDP",Y+"%","$"+App.Utilities.addCommas(X)],["att","EconMor",q+"%",q+"%"],["att","ArmyPop",te+"%",App.Utilities.addCommas(Q)],["att","ArmyMor",ne+"%",ne+"%"],["att","ArmyXP",pe+"%",pe]],o=0;o<i.length;o++)$("#"+i[o][0]+i[o][1]+"Bar").css("width",i[o][2]),$("#"+i[o][0]+i[o][1]+"Txt").text(i[o][3]);Ne.model.set("animationOver",!0)},1200)},updateMessage:function(e,t){var i=t.get("armyPopulation"),o=e.get("prvPopulation")-e.get("armyPopulation"),a=t.get("prvPopulation")-i;0<i?App.Utilities.console(t.get("name")+" suffered "+a+" casualties and was defeated!"):0==i&&App.Utilities.console(t.get("name")+" was destroyed!");var n=Math.round(100*o/e.get("prvPopulation")),r=Math.round(100*a/t.get("prvPopulation"));App.Utilities.console("\nLosses"),App.Utilities.console(e.get("name")+" : "+o+" ("+n+"%)"),App.Utilities.console(t.get("name")+" : "+a+" ("+r+"%)\n\n"),App.Utilities.console("Remaining Forces"),App.Utilities.console(e.get("name")+" : "+e.get("armyPopulation")+" ("+e.get("morale")+" morale)"),App.Utilities.console(t.get("name")+" : "+t.get("armyPopulation")+" ("+t.get("morale")+" morale)"),App.Utilities.console("============================================================================\n\n")},notify:function(e){var t=e.titleTxt?e.titleTxt:"",i=e.msgTxt?e.msgTxt:"",o=e.icon?e.icon:"",a=e.delay?1e3*e.delay:1e3*App.Constants.DELAY_DEFAULT,n=e.vert?e.vert:"top",r=e.offset?e.offset:App.Utilities.isMobile()?Math.round(Math.max(document.documentElement.clientHeight,window.innerHeight||0)/9):Math.round(Math.max(document.documentElement.clientHeight,window.innerHeight||0)/15);if(0===e.delay&&(a=0),"info"!=e.msgType){var s="left"===App.Utilities.activeSide()?"right":"left",l="left"===App.Utilities.activeSide()?"Right":"Left",p="animated zoomIn"+l,d="animated zoomOut"+l,c=(r=20,"col-xs-5 col-md-4");g=App.Utilities.activeSide(),u=!0}else if("info"==e.msgType){s="center",p="top"===n?"animated zoomInDown":"animated zoomInUp",d="top"===n?"animated zoomOutUp":"animated zoomOutDown";var g="turn",u=(c=a>1e3*App.Constants.DELAY_SHORTEST?"col-xs-10 col-md-5 col-sm-8":"col-xs-8 col-md-4 col-sm-5",r="bottom"===n?20:r,"top"===n);0===e.delay&&(c="col-xs-10 col-md-5 col-sm-8")}$.notify({icon:o,title:t,message:i},{element:"body",position:null,type:g,allow_dismiss:!0,newest_on_top:u,showProgressbar:!1,placement:{from:n,align:s},offset:r,spacing:10,z_index:1031,delay:a,timer:1e3,url_target:"_blank",mouse_over:"pause",animate:{enter:p,exit:d},onShow:null,onShown:null,onClose:null,onClosed:null,icon_type:"class",template:'<div data-notify="container" class="'+c+" game-alert alert alert-{0} "+App.Models.nationStats.get(App.Utilities.activeSide()).get("color")+'" role="alert"><button type="button" aria-hidden="true" class="close" data-notify="dismiss"><span class="glyphicon glyphicon-remove"></span></button><span data-notify="icon"></span> <label data-notify="title">{1}</label> <p data-notify="message">{2}</p><div class="progress" data-notify="progressbar"><div class="progress-bar progress-bar-{0}" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div></div><a href="{3}" target="{4}" data-notify="url"></a></div>'})}}),App.Views.ConfModal=Backbone.View.extend({template:App.Utilities.template("confModal"),initialize:function(){var e=this;this.render(),$("#modalTarget").html(this.$el),$("#oneModal .modal-dialog").removeClass("modal-lg"),App.Utilities.showModal(),$("#oneModal").on("shown.bs.modal",function(e){0<$(".modal-footer .btn-primary").length&&!App.Utilities.smallScreenOnly()?$(".modal-footer .btn-primary").focus():App.Utilities.smallScreenOnly()||$(".modal-footer .btn-danger").focus(),App.Views.battleMap.smoothScroll(".terr:first-child")}),$("#oneModal").on("hidden.bs.modal",function(){App.Utilities.console("Before"),App.Utilities.console($._data($("#oneModal")[0],"events")),$("#oneModal").off(),e.closeView(),App.Utilities.console("After"),App.Utilities.console($._data($("#oneModal")[0],"events"))})},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},events:{"click #trainTerrArmyXP":"trainTheArmy","click #repairAllFortStr":"repairAllForts","click #rebuildInfrastructure":"rebuildTheInfrastructure","click #upgradeTerrFortLevel":"updateTheFortLevel","click #repairTerrFort":"repairTheFort","click #upgradeTerrEcon":"upgradeTheEconomy","click #confAttack":"attackTheTerritory","click #confNewGame":"restartTheGame","click #confNewTurn":"endTheTurn","click #invasionStep":"invadeTheTerritory","click #repairAllInfrastructure":"rebuildAllInfrastructure","click .current":"currentClick","click .previous":"mouseOutBar","mouseover .fort-label":"mouseOverBar","mouseout .fort-label":"mouseOutBar","focusin .fort-label":"mouseOverBar","focusout .fort-label":"mouseOutBar","click #battleNot":"battleNotification","click #confUpdatePolicy":"confUpdatePolicy","change .available-policies":"toggleEnactPolicy"},attackTheTerritory:function(){App.Views.clickedTerrView.model.get("inRange")&&!this.model.get("stopClick")&&(App.Views.battleMap.battle(App.Models.selectedTerrModel,App.Models.clickedTerrModel),$(".modal-footer .btn-danger").focus(),App.Views.battleMap.smoothScroll(".modal-header"),this.model.set("stopClick",!0))},battleNotification:function(){this.model.get("govKilled")&&App.Views.battleMap.notify({icon:"glyphicon glyphicon-globe",titleTxt:"Governor of "+App.Models.clickedTerrModel.get("name")+" Killed",msgTxt:"Flags lowered as citizens gather to pay respects for local&nbsp;leader.",msgType:"success"}),App.Views.battleMap.notify(this.model.get("notification")),App.Views.battleMap.deselect(),App.Utilities.warpEls([".treasury-tot",".changeTax"])},closeView:function(){$("#oneModal, #oneModal .fort-label").off(),this.unbind(),this.undelegateEvents(),this.remove(),$("#oneModal .modal-dialog").removeClass("modal-lg"),App.Views.battleMap.smoothScroll(".terr:first-child")},toggleEnactPolicy:function(e){var t=e.currentTarget.value,i=_.where(App.Models.nationStats.get(App.Utilities.activeSide()).get("activePolicies"),{side:App.Utilities.activeSide()}),o=_.pluck(i,"id"),a=_.indexOf(o,t);if(i[a].priority=e.currentTarget.checked?App.Models.nationStats.get(App.Utilities.activeSide()).get("activePolicyCount")+1:0,1<App.Models.nationStats.get(App.Utilities.activeSide()).get("activePolicyCount")&&!e.currentTarget.checked&&a<i.length-1)for(var n=0;n<i.length-1-a;n++)i[a+(n+1)].priority=i[a+(n+1)].priority-1;"recruit_army"===t&&(i[a].amount=25e3),i=_.sortBy(i,"priority");var r=e.currentTarget.checked?App.Models.nationStats.get(App.Utilities.activeSide()).get("activePolicyCount")+1:App.Models.nationStats.get(App.Utilities.activeSide()).get("activePolicyCount")-1;App.Models.nationStats.get(App.Utilities.activeSide()).set("activePolicies",i),App.Models.nationStats.get(App.Utilities.activeSide()).set("activePolicyCount",r),App.Utilities.console(App.Utilities.activeSide()+" side policies: "),App.Utilities.console(App.Models.nationStats.get(App.Utilities.activeSide()).get("activePolicies"));var s="left"===App.Utilities.activeSide()?"right":"left";App.Utilities.console(s+" side policies: "),App.Utilities.console(App.Models.nationStats.get(s).get("activePolicies"))},confUpdatePolicy:function(){this.model.get("stopClick")||(null!=App.Models.nationStats.get(App.Utilities.activeSide()).changedAttributes().activePolicyCount&&App.Views.battleMap.notify({icon:"glyphicon glyphicon-globe",titleTxt:"Polices Updated in&nbsp;"+App.Utilities.getActiveEmpireName(),msgType:"left"}),this.model.set("stopClick",!0))},endTheTurn:function(){this.model.get("stopClick")||(App.Views.battleMap.deselect(),App.Views.nationStatsView.updater(),this.model.set("stopClick",!0))},invadeTheTerritory:function(){this.model.get("stopClick")||(App.Views.selectedTerrView.invadeTerr(App.Models.selectedTerrModel,App.Models.clickedTerrModel,this.model.get("newObj")),this.model.set("stopClick",!0))},currentClick:function(e){$.each($(".previous"),function(){this.click()}),this.mouseOverBar(e)},mouseOutBar:function(e){if(!App.Utilities.smallScreenOnly()||"click"===e.type||App.Utilities.smallScreenOnly()&&"mouseout"===e.type){var t=e.currentTarget;this.model.get("animationOver")&&($(t).addClass("current").removeClass("previous"),$(t.firstChild).css("width",$(t.firstChild).data("endVal")+"%"),$(t).find(".prog-bar-text-val").text($(t).find(".prog-bar-text-val").data("endVal")))}},mouseOverBar:function(e){if(!App.Utilities.smallScreenOnly()||"click"===e.type){var t=e.currentTarget;this.model.get("animationOver")&&($(t).addClass("previous").removeClass("current"),$(t.firstChild).css("width",$(t.firstChild).data("startVal")+"%"),$(t).find(".prog-bar-text-val").text($(t).find(".prog-bar-text-val").data("startVal")))}},rebuildTheInfrastructure:function(){if(!this.model.get("stopClick")){var e=this.model.get("diffToNext"),t=App.Utilities.getTreasury()-e,i=100-App.Models.selectedTerrModel.get("econStrength"),o=App.Models.nationStats.get(App.Utilities.activeSide()).get("infrastructureSpend");App.Utilities.upgradeTerrEconStr(),App.Utilities.flipEls([".econStrength-bar",".econMorale-bar",".econMorale-bar",".economicOutput-bar"]),App.Models.nationStats.get(App.Utilities.activeSide()).set("repairAllInfrastructureCost",App.Collections.terrCollection.returnTotalCost("econStrength")),App.Models.nationStats.payForUpgrade(t),App.Models.nationStats.get(App.Utilities.activeSide()).set("infrastructureSpend",o+e),App.Utilities.displayInRange();var a=[["Traffic flowing",_.random(Math.round(i/2),i),"more smoothly through"],["Highways re-open in",i,"of"],["Commute times down",_.random(Math.round(i/2),i),"in"],["Army surveyors declare",100,"of roads passable in"]],n=_.random(0,a.length-1);App.Views.battleMap.notify({icon:"glyphicon glyphicon-wrench",titleTxt:"Infrastructure Repaired",msgTxt:a[n][0]+" "+a[n][1]+"% "+a[n][2]+" "+App.Models.selectedTerrModel.get("name")+" after completion of $"+App.Utilities.addCommas(e)+" reconstruction&nbsp;project.",msgType:"left"}),this.model.set("stopClick",!0)}},rebuildAllInfrastructure:function(){if(!this.model.get("stopClick")){var e=App.Collections.terrCollection.returnTotalCost("econStrength"),t=App.Utilities.getTreasury()-e,i=App.Models.nationStats.get(App.Utilities.activeSide()).get("infrastructureSpend");App.Collections.terrCollection.repairAllInfrastructure(),App.Models.nationStats.get(App.Utilities.activeSide()).set("repairAllInfrastructureCost",0),App.Models.nationStats.payForUpgrade(t),App.Models.nationStats.get(App.Utilities.activeSide()).set("infrastructureSpend",i+e),App.Models.battleMapModel.get("selectedMode")&&(App.Utilities.flipEls([".econStrength-bar",".econMorale-bar",".econMorale-bar",".economicOutput-bar"]),App.Utilities.displayInRange());var o=Math.round(e/App.Constants.ECON_STR_COST/App.Models.nationStats.get(App.Utilities.activeSide()).get("terrs").length*10),a=[["Traffic flowing",_.random(Math.round(o/2),o),"more smoothly through"],["Highways re-open in",o,"of"],["Commute times down",_.random(Math.round(o/2),o),"in"],["Army engineers report",100,"of roads clear for unit movements across"]],n=_.random(0,a.length-1);App.Views.battleMap.notify({icon:"glyphicon glyphicon-wrench",titleTxt:"Infrastructure Repaired",msgTxt:a[n][0]+" "+a[n][1]+"% "+a[n][2]+" "+App.Utilities.getActiveEmpireName()+" after completion of $"+App.Utilities.addCommas(e)+" national reconstruction&nbsp;project.",msgType:"left"}),this.model.set("stopClick",!0)}},restartTheGame:function(){if(!this.model.get("stopClick")){App.Utilities.setNextTrack(),$("#ambientMusic")[0].pause(),$("#ambientMusic").off(),$("#ambientMusic").bind("ended",App.Utilities.playNextTrack),App.Utilities.removeClassName(["selected","selectedSection"]),App.Models.battleMapModel=new App.Models.BattleZone,App.Views.battleMap=new App.Views.BattleZone({model:App.Models.battleMapModel}),$("#game").html(App.Views.battleMap.$el),$("#game").removeClass("fadein"),$("body").prepend($('<div id="setup"></div>'));var e=new Emp({armyPopulationStart:App.Constants.START_ARMY_UNITS,color:"blue"}),t=new Emp({armyPopulationStart:App.Constants.START_ARMY_UNITS,color:"orange"});App.Models.nationStats=new App.Models.NationStats({left:e,right:t}),App.Views.nationStatsView=new App.Views.NationStats({model:App.Models.nationStats}),App.Collections.terrCollection=new App.Collections.Territories,App.Utilities.makeTerritories(),App.Views.gameStartView=new App.Views.GameStart({model:App.Models.gameStartModel}),$("#setup").html(App.Views.gameStartView.$el),App.Views.p1ColorView=new App.Views.ColorView({model:App.Models.gameStartModel}),App.Views.p2ColorView=new App.Views.RightColorView({model:App.Models.gameStartModel}),$("#p1ColorMenu").html(App.Views.p1ColorView.$el),$("#p2ColorMenu").html(App.Views.p2ColorView.$el),this.model.set("stopClick",!0)}},repairTheFort:function(){if(!this.model.get("stopClick")){var e=App.Utilities.getTreasury()-this.model.get("diffToNext"),t=App.Models.nationStats.get(App.Utilities.activeSide()).get("fortSpend");App.Views.battleMap.notify({titleTxt:"+"+(100-App.Models.selectedTerrModel.get("fortStrength"))+"% Fort Strength",msgTxt:"Spirits lifted by $"+App.Utilities.addCommas(this.model.get("diffToNext"))+" investment in repairs at Fort&nbsp;"+App.Models.selectedTerrModel.get("name")+".",msgType:"success"}),App.Utilities.repairTerrFortStr(),App.Models.nationStats.payForUpgrade(e),App.Models.nationStats.get(App.Utilities.activeSide()).set("fortSpend",t+this.model.get("diffToNext")),App.Utilities.displayInRange(),App.Utilities.flipEls([".econMorale-bar",".econMorale-bar",".fortStrength-main",".economicOutput-bar"]),this.model.set("stopClick",!0)}},repairAllForts:function(){if(!this.model.get("stopClick")){var e=App.Collections.terrCollection.returnTotalCost("fortStrength"),t=App.Utilities.getTreasury()-e,i=App.Models.nationStats.get(App.Utilities.activeSide()).get("fortSpend");App.Collections.terrCollection.repairAllForts(),App.Models.battleMapModel.get("selectedMode")&&(App.Utilities.displayInRange(),App.Utilities.flipEls([".econMorale-bar",".econMorale-bar",".fortStrength-main",".economicOutput-bar"])),App.Models.nationStats.payForUpgrade(t),App.Models.nationStats.get(App.Utilities.activeSide()).set({fortSpend:i+e,repairAllFortCost:0}),App.Views.battleMap.notify({icon:"glyphicon glyphicon-wrench",titleTxt:"All Forts Repaired in&nbsp;"+App.Utilities.getActiveEmpireName(),msgTxt:"Cost: $"+App.Utilities.addCommas(e),msgType:"left"}),this.model.set("stopClick",!0)}},trainTheArmy:function(){if(!this.model.get("stopClick")){var e=App.Utilities.getTreasury()-this.model.get("diffToNext");startXP=App.Models.selectedTerrModel.get("armyXP"),newSideTrainingspend=App.Models.nationStats.get(App.Utilities.activeSide()).get("armyTrainingSpend"),App.Models.nationStats.payForUpgrade(e),App.Models.nationStats.get(App.Utilities.activeSide()).set("armyTrainingSpend",newSideTrainingspend+this.model.get("diffToNext")),App.Utilities.trainTerrArmy(),App.Views.battleMap.notify({titleTxt:"+"+(App.Models.selectedTerrModel.get("armyXP")-startXP)+" Army XP in&nbsp;"+App.Models.selectedTerrModel.get("name"),msgType:"success",delay:App.Constants.DELAY_SHORTEST,icon:"glyphicon glyphicon-signal"}),App.Views.battleMap.deselect(),this.model.set("stopClick",!0)}},upgradeTheEconomy:function(){if(!this.model.get("stopClick")){var e=Math.round(App.Utilities.getTreasury()-this.model.get("diffToNext")),t=App.Models.nationStats.get(App.Utilities.activeSide()).get("econLevelSpend");App.Utilities.upgradeTerrEconLevel(),App.Utilities.flipEls([".econMorale-bar",".econMorale-bar",".econLevel-bar",".economicOutput-bar"]),App.Models.nationStats.payForUpgrade(e),App.Models.nationStats.get(App.Utilities.activeSide()).set("econLevelSpend",t+this.model.get("diffToNext")),App.Views.battleMap.notify({icon:"glyphicon glyphicon-education",titleTxt:"Tech Level Upgraded in&nbsp;"+App.Models.selectedTerrModel.get("name"),msgType:"success",delay:App.Constants.DELAY_SHORTEST}),this.model.set("stopClick",!0)}},updateTheFortLevel:function(){if(!this.model.get("stopClick")){var e=App.Utilities.getTreasury()-this.model.get("diffToNext"),t=App.Models.nationStats.get(App.Utilities.activeSide()).get("fortLevelSpend");App.Utilities.upgradeTerrArmyFortLevel(),App.Utilities.flipEls([".econMorale-bar",".econMorale-bar",".fortStrength-main",".economicOutput-bar"]),App.Models.nationStats.payForUpgrade(e),App.Models.nationStats.get(App.Utilities.activeSide()).set("fortLevelSpend",t+this.model.get("diffToNext")),App.Utilities.displayInRange(),App.Views.battleMap.notify({icon:"glyphicon glyphicon-signal",titleTxt:"Fort Upgraded: Level&nbsp;"+App.Models.selectedTerrModel.get("fortLevel"),msgTxt:"Everyone feels safer in "+App.Models.selectedTerrModel.get("name")+" after installation of new $"+App.Utilities.addCommas(this.model.get("diffToNext"))+"&nbsp;defenses.",msgType:"success"}),this.model.set("stopClick",!0)}}}),App.Views.SinglePromptModal=Backbone.View.extend({template:App.Utilities.template("spModal"),initialize:function(){var t=this;this.render(),$("#modalTarget").html(this.$el),App.Utilities.showModal(),this.model.set({modalView:t}),this.model.get("showRange")?$("#oneModal").on("shown.bs.modal",function(){$("#spRangeInput").focus(),App.Views.battleMap.smoothScroll(".terr:first-child")}):$("#oneModal").on("shown.bs.modal",function(){App.Utilities.selectOrFocus("spInput"),App.Views.battleMap.smoothScroll(".terr:first-child")}),$("#oneModal").on("hidden.bs.modal",function(e){t.closeView(),$("#oneModal").off()}),"confNewTaxRate"!==this.model.get("confBtnId")||App.Utilities.detectIE()?"confNewTaxRate"===this.model.get("confBtnId")&&(this.events["change #spRangeInput"]="showTaxResult",this.delegateEvents()):(this.events["input #spRangeInput"]="showTaxResult",this.delegateEvents()),"confReinforce"!==this.model.get("confBtnId")||App.Utilities.detectIE()?"confReinforce"===this.model.get("confBtnId")&&(this.events["change #spRangeInput"]="showReinforcementsResult",this.delegateEvents()):(this.events["input #spRangeInput"]="showReinforcementsResult",this.delegateEvents()),"confNewRecruits"!==this.model.get("confBtnId")||App.Utilities.detectIE()?"confNewRecruits"===this.model.get("confBtnId")&&(this.events["change #spRangeInput"]="showRecruitResult",this.delegateEvents()):(this.events["input #spRangeInput"]="showRecruitResult",this.delegateEvents())},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},events:{"click #confNewEmpName":"changeTheEmpireName","keyup #spInput":"keyValidator","click #confNewTaxRate":"changeTheTaxRate","click #confNewTerrName":"changeTheTerritoryName","click #confNewRecruits":"recruitTheUnits","click #confReinforce":"sendTheReinforcements","keyup #spRangeInput":"rangeSliderKeypress"},changeTheEmpireName:function(){if(!this.model.get("stopClick")){var e=$("#spInput").val();if(!e)return!1;if(0!=App.Utilities.validateName($("#spInput").val(),"empire").errCode)return this.nameValidation("empire"),$("#spInput").addClass("invalid").select(),!1;App.Views.battleMap.notify({icon:"glyphicon glyphicon-globe",titleTxt:App.Utilities.getActiveEmpireName()+" empire renamed to&nbsp;"+e+".",msgType:"success"}),App.Models.nationStats.setEmpName(e),$("."+App.Utilities.activeSide()+"-stats .sideName").removeClass("tada").addClass("tada"),$("#oneModal").modal("hide"),this.model.set("stopClick",!0)}},changeTheTaxRate:function(){if(!this.model.get("stopClick")){var e=parseInt($("#spRangeInput").val())/100;if(e!=App.Models.nationStats.get(App.Utilities.activeSide()).get("taxRate")){App.Collections.terrCollection.updateAllMoraleGDP(e,App.Utilities.activeSide());var t="",i="",o="";App.Models.nationStats.getTaxRate()>e?(t="lowered",i="pleased",o="upward"):App.Models.nationStats.getTaxRate()<e&&(t="raised",i="unhappy",o="downward");var a="Citizens across the empire are "+i+" with the news. Economic forecasts revised&nbsp;"+o+".",n=App.Utilities.getActiveEmpireName()+" empire tax rate "+t+" to&nbsp;"+Math.round(100*e)+"%.";App.Models.nationStats.setTaxRate(e),$("."+App.Utilities.activeSide()+"-stats .changeTax").removeClass("tada").addClass("tada"),App.Views.battleMap.notify({icon:"glyphicon glyphicon-globe",titleTxt:n,msgTxt:a,msgType:"success"}),$("#oneModal").modal("hide"),App.Models.battleMapModel.get("selectedMode")&&App.Utilities.displayInRange()}else $("#oneModal").modal("hide");this.model.set("stopClick",!0)}},changeTheTerritoryName:function(){if(!this.model.get("stopClick")){var e=$("#spInput");if(!e.val())return!1;if(0!=App.Utilities.validateName($("#spInput").val(),"territory").errCode)return this.nameValidation("territory"),e.addClass("invalid").select(),!1;var t=App.Models.selectedTerrModel.get("name");App.Models.selectedTerrModel.setName(e.val()),$(".selectedTitle.animated").removeClass("tada").addClass("tada"),App.Views.selectedTerrView.$el.find(".army > h2").removeClass("tada").addClass("tada"),App.Views.battleMap.notify({icon:"glyphicon glyphicon-globe",titleTxt:t+" territory renamed to&nbsp;"+App.Models.selectedTerrModel.get("name")+".",msgType:"success"}),$("#oneModal").modal("hide"),this.model.set("stopClick",!0)}},closeView:function(){this.unbind(),this.undelegateEvents(),this.remove(),App.Views.battleMap.smoothScroll(".terr:first-child")},rangeSliderKeypress:function(e){App.Utilities.isEnterKey(e)&&this.enterPress(this.model.get("confBtnId"))},enterPress:function(e){switch(e){case"confNewEmpName":this.changeTheEmpireName();break;case"confNewTerrName":this.changeTheTerritoryName();break;case"confNewRecruits":this.recruitTheUnits();break;case"confReinforce":this.sendTheReinforcements();break;case"confNewTaxRate":this.changeTheTaxRate();break;default:return!1}return!1},nameValidation:function(e){0===App.Utilities.validateName($("#spInput").val(),e).errCode?($("#spInput").removeClass("invalid"),$("#error-message").html("")):($("#spInput").addClass("invalid"),$("#error-message").html(App.Utilities.validateName($("#spInput").val(),e).msg))},keyValidator:function(e){var t=this.model.get("confBtnId");App.Utilities.isEnterKey(e)&&this.enterPress(this.model.get("confBtnId")),"confNewEmpName"==t?this.nameValidation("empire"):"confNewTerrName"==t&&this.nameValidation("territory")},showRecruitResult:function(){var e=parseInt($("#spRangeInput").val()),t=e*App.Constants.COST_PER_RECRUIT;$("#recruitCost").text(App.Utilities.addCommas(t)),$("#recruitCount").text(App.Utilities.addCommas(e))},showReinforcementsResult:function(){var e=$("#spRangeInput").val(),t=(App.Models.selectedTerrModel.get("armyPopulation")-App.Constants.ATTACK_ARMY_MINIMUM)*(App.Models.selectedTerrModel.get("econStrength")/100),i=(t=Math.round(t),App.Utilities.addCommas(t),App.Utilities.addCommas(App.Models.clickedTerrModel.get("armyPopulation")),App.Utilities.addCommas(App.Models.selectedTerrModel.get("armyPopulation")-t),parseInt(e)),o=App.Utilities.addCommas(App.Models.clickedTerrModel.get("armyPopulation")+i),a=(App.Utilities.addCommas(e),App.Utilities.returnNewMoraleXpRank(App.Models.clickedTerrModel,i)),n=App.Utilities.addCommas(App.Models.selectedTerrModel.get("armyPopulation")-i);$("#remainingUnits").text(n),$("#fromMorale").text(a.fromMorale),$("#toRank").html(App.Utilities.makeStarGroup({newRank:a.toRank,armyPromoted:!1})),$("#toXP").text(a.toXP),$("#toUnits").text(o),$("#toMorale").text(a.toMorale)},showTaxResult:function(){var e=parseInt(100*App.Models.nationStats.get(App.Utilities.activeSide()).get("taxRate")),t=App.Collections.terrCollection.returnSideTotal(App.Utilities.activeSide(),"economicOutput"),i=parseInt(t*App.Models.nationStats.getTaxRate()),o=(App.Utilities.addCommas(i),App.Utilities.getTreasury()+i),a=(o=App.Utilities.addCommas(o),parseInt($("#spRangeInput").val()));if(a!=e){a>App.Utilities.returnHighTaxLimit()?$("#error-message").html("Tax rates above "+App.Utilities.returnHighTaxLimit()+"% will greatly anger your citizens and damage your economy over time until you lower&nbsp;them."):a<App.Utilities.returnLowTaxLimit()?$("#error-message").html("Tax rates below "+App.Utilities.returnLowTaxLimit()+"% will rapidly grow your economy, but at the risk of random market crashes until taxes are raised&nbsp;again."):$("#error-message").html("");i=parseInt(t*(a/100));var n,r=App.Utilities.addCommas(i),s=App.Utilities.getTreasury()+i,l=App.Utilities.addCommas(s);if(a>100*App.Models.nationStats.getTaxRate())n=a-Math.round(100*App.Models.nationStats.getTaxRate()),$("#impact-msg").attr("class","text-danger").html("-"+n+" civilian morale each territory. Shrinks the&nbsp;economy.");else{n=Math.round(100*App.Models.nationStats.getTaxRate())-a;var p=a<15?"&nbsp;rapidly":"";$("#impact-msg").attr("class","text-success").html("+"+n+" civilian morale each territory. Grows the&nbsp;economy"+p+".")}$("#projTaxRate").text(a),$("#projTaxes").text(r),$("#projTreasury").text(l)}else $("#projTaxRate").text(e),$("#projTaxes").text(App.Utilities.addCommas(i)),$("#projTreasury").text(o),$("#impact-msg").html(this.model.get("impactMsg")).removeClass("text-danger text-success").addClass(this.model.get("impactClass"))},recruitTheUnits:function(){if(!this.model.get("stopClick")){App.Utilities.recruitMax();var e=parseInt($("#spRangeInput").val()),t=App.Constants.ARMY_UNIT_COST*e,i=App.Utilities.getTreasury()-t,o=(App.Models.selectedTerrModel.get("econPopulation"),App.Models.nationStats.get(App.Utilities.activeSide()).get("recruitSpend"));App.Models.selectedTerrModel.incomingUnits(App.Models.selectedTerrModel,e),App.Utilities.flipEls([".armyPopulation-main"]),App.Models.nationStats.get(App.Utilities.activeSide()).set("armyPopulationNow",App.Models.nationStats.get(App.Utilities.activeSide()).get("armyPopulationNow")+e),App.Models.nationStats.payForUpgrade(i),App.Models.nationStats.get(App.Utilities.activeSide()).set("recruitSpend",o+t),App.Views.battleMap.notify({icon:"glyphicon glyphicon-user",titleTxt:"Uncle "+App.Utilities.getActiveEmpireName()+" Wants&nbsp;You",msgTxt:"Drill sergeants at Ft. "+App.Models.selectedTerrModel.get("name")+" give "+App.Utilities.addCommas(e)+" citizen recruits a warm&nbsp;welcome.",msgType:"success"}),App.Views.battleMap.deselect(),App.Utilities.warpEls([".treasury-tot",".changeTax"]),$("#oneModal").modal("hide"),this.model.set("stopClick",!0)}},sendTheReinforcements:function(){if(!this.model.get("stopClick")){var e=$("#spRangeInput"),t=parseInt(e.val());App.Models.clickedTerrModel.incomingUnits(App.Models.clickedTerrModel,t),App.Views.battleMap.notify({icon:"glyphicon glyphicon-user",titleTxt:App.Utilities.addCommas(t)+" units sent to&nbsp;"+App.Models.clickedTerrModel.get("name")}),App.Views.battleMap.deselect(),App.Utilities.warpEls([".changeTax"]),$("#oneModal").modal("hide"),this.model.set("stopClick",!0)}}}),App.Views.TwoPromptModal=Backbone.View.extend({template:App.Utilities.template("tpModal"),initialize:function(){var t=this;this.render(),$("#modalTarget").html(this.$el),$("#oneModal .modal-dialog").removeClass("modal-lg"),this.model.set({modalView:t}),$("#oneModal").on("shown.bs.modal",function(){$("#tp-input-1").focus(),App.Views.battleMap.smoothScroll(".terr:first-child")}),$("#oneModal").on("hidden.bs.modal",function(e){$("#oneModal").off(),t.closeView()}),"confInvasion"!==this.model.get("confBtnId")||App.Utilities.detectIE()?"confInvasion"===this.model.get("confBtnId")&&(this.events["change #tp-input-1"]="showReinforcementResult",this.delegateEvents()):(this.events["input #tp-input-1"]="showReinforcementResult",this.delegateEvents()),App.Views.battleMap.smoothScroll(".modal-header")},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},events:{"click #confInvasion":"confirmInvasion","keyup #tp-input-2":"nameValidator","keyup #tp-input-1":"keyPress"},closeView:function(){this.unbind(),this.undelegateEvents(),this.remove(),App.Views.battleMap.smoothScroll(".terr:first-child")},enterKey:function(e){if(void 0!==e)var t=13===(window.event?e.keyCode:e.which);if(t)return this.confirmInvasion(),!1},keyPress:function(e){this.enterKey(e)&&this.confirmInvasion()},showReinforcementResult:function(){var e=$("#tp-input-1"),t=parseInt(e.val()),i=App.Utilities.addCommas(App.Models.clickedTerrModel.get("armyPopulation")+t),o=(App.Utilities.addCommas(t),App.Utilities.returnNewMoraleXpRank(App.Models.clickedTerrModel,t)),a=App.Utilities.addCommas(App.Models.selectedTerrModel.get("armyPopulation")-t);$("#remainingUnits").text(a),$("#invaderMorale").text(o.fromMorale),$("#invadedXP").text(o.toXP),$("#invadedUnits").text(i),$("#invadedMorale").text(o.toMorale)},nameValidator:function(e){var t=$("#tp-input-2"),i=t.val(),o=App.Utilities.validateName(i,"territory");this.enterKey(e)?0===o.errCode?(t.removeClass("invalid"),$("#error-message-2").html(""),i!=App.Models.clickedTerrModel.get("name")?$("#renameMsg").html(" and renamed "+i):$("#renameMsg").html(""),$(".newTerrName").html(i)):($(".newTerrName").html(App.Models.clickedTerrModel.get("name")),$("#renameMsg").html(""),t.addClass("invalid"),$("#error-message-2").html(o.msg)):0===o.errCode?(t.removeClass("invalid"),$("#error-message-2").html(""),i!=App.Models.clickedTerrModel.get("name")?$("#renameMsg").html(" and renamed "+i):$("#renameMsg").html(""),$(".newTerrName").html(i)):($(".newTerrName").html(App.Models.clickedTerrModel.get("name")),$("#renameMsg").html(""),i!=App.Models.clickedTerrModel.get("name")&&(t.addClass("invalid"),$("#error-message-2").html(o.msg)))},confirmInvasion:function(){if(!this.model.get("stopClick")){var e=this.model.get("modalView"),t=$("#tp-input-2"),i=t.val(),o=App.Utilities.validateName(i,"territory");if(0!=o.errCode&&i!=App.Models.clickedTerrModel.get("name")){if(i!=App.Models.clickedTerrModel.get("name"))return $("#tp-error-msg-2").text(o.msg),t.addClass("invalid"),$(".invalid").select(),!1}else if(0===o.errCode||i===App.Models.clickedTerrModel.get("name")){var a=parseInt($("#tp-input-1").val()),n=e.model.get("newObj"),r=n.invaded,s=n.attacking,l=e.model.get("attacking"),p=e.model.get("defending"),d=l.get("side"),c=(p.get("side"),i!=p.get("name")?" and renamed it "+i:""),g=App.Views.nationStatsView.model.get(l.get("side")).get("empName");App.Views.battleMap.notify({icon:"glyphicon glyphicon-globe",titleTxt:g+" Invades&nbsp;"+p.get("name"),msgTxt:"The army defending "+p.get("name")+" was defeated. "+l.get("name")+" army divisions have taken control of the territory"+c+". The empire celebrates your&nbsp;victory!",msgType:"success"}),App.Views.clickedTerrView.$el.find(".army > h2").removeClass("tada").addClass("tada"),App.Models.selectedTerrModel=p;var u=App.Utilities.updateEconMorale({selectedArmyPop:a,econStrength:r.newEconStrength,econPopulation:r.newEconPopulation,econLevel:r.newEconLvl,selectedFortLevel:r.oldDefFortLvl,selectedFortStrength:r.newDefFortStr,newMorale:r.newEconMorale}),m=App.Utilities.updateGDP({newLevel:r.newEconLvl,newMorale:u,newEconPopulation:r.newEconPopulation,newEconStrength:r.newEconStrength,ecGrowthRate:p.get("econGrowthPct")}),A=App.Constants.FORT_STR_COST*r.oldDefFortLvl*(100-r.newDefFortStr),h=Math.round(App.Constants.ECON_STR_COST*r.newEconLvl*((100-r.newEconStrength)/10));App.Models.selectedTerrModel=l,p.set({morale:l.get("morale"),name:i,color:l.get("color"),armyPopulation:a,prvPopulation:a,remainingTurns:1,selected:!0,side:d,armyXP:s.newAttXP,armyRank:s.newAttArmyRank,econMorale:u,economicOutput:m,econLevel:r.newEconLvl,econPopulation:r.newEconPopulation,prvEconPopulation:r.newEconPopulation,currTreasury:l.get("currTreasury"),fortStrengthCost:A,econStrengthCost:h,econCasualties:0,armyCasualties:0,inRange:!1});var M=l.get("armyPopulation")-a,T=App.Utilities.updateEconMorale({selectedArmyPop:M,oldTerrArmyPop:l.get("armyPopulation"),newMorale:l.get("econMorale")}),f=l.get("econStrength"),C=l.get("econPopulation"),v=l.get("econLevel"),y=App.Utilities.updateGDP({newMorale:T,newEconStrength:f,newEconPopulation:C,newLevel:v,ecGrowthRate:l.get("econGrowthPct")});l.set({armyPopulation:M,selected:!1,armyXP:s.newAttXP,armyRank:s.newAttArmyRank,econMorale:T,economicOutput:y,remainingTurns:l.get("remainingTurns")-1}),App.Collections.terrCollection.nextTreasury(),$("#oneModal").modal("hide"),App.Models.selectedTerrModel=App.Models.clickedTerrModel,App.Views.selectedTerrView=App.Views.clickedTerrView,App.Utilities.displayInRange(),App.Models.battleMapModel.set("selectedMode",!0),App.Models.nationStats.get("left").set({armyPopulationNow:App.Collections.terrCollection.returnSideTotal("left","armyPopulation"),armyCasualties:App.Collections.terrCollection.getSideCasualties("left","army"),econCasualties:App.Collections.terrCollection.getSideCasualties("left","econ"),econPopulationNow:App.Collections.terrCollection.returnSideTotal("left","econPopulation"),terrs:App.Collections.terrCollection.getSideTerritories("left"),terrsWithTurns:App.Collections.terrCollection.getSideTerritoriesWithTurns("left")}),App.Models.nationStats.get("right").set({armyPopulationNow:App.Collections.terrCollection.returnSideTotal("right","armyPopulation"),armyCasualties:App.Collections.terrCollection.getSideCasualties("right","army"),econCasualties:App.Collections.terrCollection.getSideCasualties("right","econ"),econPopulationNow:App.Collections.terrCollection.returnSideTotal("right","econPopulation"),terrs:App.Collections.terrCollection.getSideTerritories("right"),terrsWithTurns:App.Collections.terrCollection.getSideTerritoriesWithTurns("right")}),App.Views.selectedFooterView.closeView(),App.Views.selectedFooterView=new App.Views.Footer({model:App.Models.selectedTerrModel}),$("#footerZone").html(App.Views.selectedFooterView.$el),App.Models.selectedTerrModel.get("armyPopulation")*App.Models.selectedTerrModel.get("econStrength")/100<2*App.Constants.ATTACK_ARMY_MINIMUM&&App.Views.battleMap.notify({icon:"glyphicon glyphicon-globe",titleTxt:"Army Stuck in&nbsp;"+p.get("name"),msgTxt:"The roads and bridges in "+p.get("name")+" are badly damaged and need to be repaired for your army units to move to other&nbsp;territories.",msgType:"success"}),App.Views.selectedFooterView.raiseFooter(),App.Models.nationStats.get(App.Utilities.activeSide()).set("armyTechLvl",App.Collections.terrCollection.returnAvgTechLevel(App.Utilities.activeSide()))}this.model.set("stopClick",!0)}}}),App.Views.BudgetView=Backbone.View.extend({template:App.Utilities.template("budgetList"),initialize:function(){this.render()},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),App.Views.PolicyView=Backbone.View.extend({template:App.Utilities.template("enactedPolicies"),initialize:function(){this.model.on("change",this.render,this),this.render(),-1==$("#confUpdatePolicy").length||App.Utilities.detectIE()?-1!=$("#confUpdatePolicy").length&&(this.events["change #armyUnitsRange"]="showRecruits",this.delegateEvents()):(this.events["input #armyUnitsRange"]="showRecruits",this.delegateEvents())},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},events:{"click .glyphicon-chevron-up":"moveUp","click .glyphicon-chevron-down":"moveDown"},moveUp:function(e){if(!$(e.currentTarget).hasClass("disabled")){var t=$(e.currentTarget).parent().attr("data-enacted-id"),i=parseInt($(e.currentTarget).parent().attr("data-priority")),o=App.Models.nationStats.get(App.Utilities.activeSide()).get("activePolicies"),a=_.indexOf(_.pluck(o,"id"),t);o[a].priority=i-1,o[a-1].priority=i,o=_.sortBy(o,"priority"),App.Models.nationStats.get(App.Utilities.activeSide()).set("activePolicies",o)}},moveDown:function(e){if(!$(e.currentTarget).hasClass("disabled")){var t=$(e.currentTarget).parent().attr("data-enacted-id"),i=parseInt($(e.currentTarget).parent().attr("data-priority")),o=App.Models.nationStats.get(App.Utilities.activeSide()).get("activePolicies"),a=_.indexOf(_.pluck(o,"id"),t);o[a].priority=i+1,o[a+1].priority=i,o=_.sortBy(o,"priority"),App.Models.nationStats.get(App.Utilities.activeSide()).set("activePolicies",o)}},showRecruits:function(e){var t=parseInt($("#armyUnitsRange").val()),i=App.Models.nationStats.get(App.Utilities.activeSide()).get("activePolicies"),o=_.indexOf(_.pluck(i,"id"),"recruit_army");i[o].amount=t;var a=App.Constants.ARMY_UNIT_COST*i[o].amount*App.Models.nationStats.get(App.Utilities.activeSide()).get("terrs").length;$("#recruitsPerYear").text(App.Utilities.addCommas(t)),$("#recruitPerYearCost").text(App.Utilities.addCommas(a))}}),App.Views.Footer=Backbone.View.extend({template:App.Utilities.template("footerTemplate"),initialize:function(){this.model.on("change",this.render,this),(App.Views.selectedFooterView=this).count=0,this.whichArr="army",this.startCount=!0,this.render()},render:function(){var e=$("#dropFooter").hasClass("drop");if(this.$el.html(this.template(this.model.toJSON())),e&&($("#dropFooter").removeClass("raise").addClass("drop"),$("#footerZone").addClass("lift")),$(function(){$('[data-toggle="tooltip"]').tooltip("destroy"),$('[data-toggle="tooltip"]').tooltip(),$('[data-toggle="popover"]').popover("destroy"),$('[data-toggle="popover"]').popover()}),App.Models.battleMapModel.get("selectedMode")){var t=App.Utilities.addCommas(App.Models.selectedTerrModel.get("armyPopulation")).length,i=App.Utilities.addCommas(App.Models.selectedTerrModel.get("econPopulation")).length;this.count=0,this.whichArr="army",this.startCount=!0,this.armyWidth={army11:152,army10:144,army9:137,army7:125,army6:117,army5:109}["army"+t],this.econWidth={econ11:152,econ10:145,econ9:136,econ7:125,econ6:116,econ5:107}["econ"+i],0===App.Timers.main&&(App.Timers.main=setTimeout(function e(){App.Models.battleMapModel.get("selectedMode")?(App.Views.selectedFooterView.detailsRotator({startCount:this.startCount,i:App.Views.selectedFooterView.count,whichArr:App.Views.selectedFooterView.whichArr}),App.Timers.inner=setTimeout(e,3e3)):App.Timers.main&&(clearTimeout(App.Timers.main),clearTimeout(App.Timers.inner))},3e3))}},events:{"click #repairFort":"repairFort","click #closeFooter":"closeFooter","click .drop":"dropFooter","click .raise":"raiseFooter","click #recruitUnits":"recruitUnits","click #investEcon":"investEcon","click #investEconStr":"investEconStr","click .selectedTitle":"updateTerrName","click #upgradeFort":"upgradeFortLevel","click #trainArmy":"trainArmy"},detailsRotator:function(e){var t="army"===e.whichArr?"Army: "+App.Utilities.addCommas(App.Models.selectedTerrModel.get("armyPopulation"))+" units":"Population: "+App.Utilities.addCommas(App.Models.selectedTerrModel.get("econPopulation")),i="army"==e.whichArr?"econ":"army",o=$('[data-msgs="army"]').length,a=($('[data-msgs="army"]'),$('[data-msgs="econ"]').length),n=($('[data-msgs="econ"]'),$($('[data-msgs="'+e.whichArr+'"]')[this.count])),r=$($('[data-msgs="'+e.whichArr+'"]')[this.count+1]),s=($('[data-msgs="'+e.whichArr+'"]').length===this.count?$($('[data-msgs="'+i+'"]')[0]):$($('[data-msgs="'+e.whichArr+'"]')[this.count+2]),$(".primary-item.fadeOutUp")),l=$(".primary-item.fadeInUp"),p=!1;"army"===e.whichArr&&e.i===o-1?(this.count=0,this.whichArr="econ",$($('[data-msgs="'+this.whichArr+'"]')[this.count+1]),r=$($('[data-msgs="'+this.whichArr+'"]')[this.count]),n=$($('[data-msgs="'+e.whichArr+'"]')[e.i]),t="Population: "+App.Utilities.addCommas(App.Models.selectedTerrModel.get("econPopulation")),p=!0):"econ"===e.whichArr&&e.i===a-1?(this.count=0,this.whichArr="army",$($('[data-msgs="'+this.whichArr+'"]')[this.count+1]),r=$($('[data-msgs="'+this.whichArr+'"]')[this.count]),n=$($('[data-msgs="'+e.whichArr+'"]')[e.i]),t="Army: "+App.Utilities.addCommas(App.Models.selectedTerrModel.get("armyPopulation"))+" units",p=!0):(this.count!==$('[data-msgs="'+e.whichArr+'"]').length||this.startCount?this.count===$('[data-msgs="'+e.whichArr+'"]').length&&this.startCount&&App.Models.selectedTerrModel.get("isCapital")&&this.count++:(l.removeClass("fadeInUp").addClass("fadeOutUp"),s.html(t).removeClass("fadeOutUp").addClass("fadeInUp")),this.count++),p&&!this.startCount&&(l.removeClass("fadeInUp").addClass("fadeOutUp"),s.html(t).removeClass("fadeOutUp").addClass("fadeInUp"),App.Utilities.smallScreenOnly()&&"army"==this.whichArr?s.parent().width(this.armyWidth):App.Utilities.smallScreenOnly()&&"econ"==this.whichArr?s.parent().width(this.econWidth):App.Utilities.smallScreenOnly()||s.parent().css("width","")),n.removeClass("fadeOutUp fadeInUp").addClass("fadeOutUp"),r.removeClass("fadeOutUp fadeInUp next").addClass("fadeInUp active"),this.startCount&&(this.startCount=!1)},trainArmy:function(){var e=.25*(100-this.model.get("armyXP"))*(App.Constants.ARMY_TRAINING_COST*this.model.get("armyPopulation")/1e3),t=new App.Models.Modal({title:"Train Units",confBtnClass:"btn-danger",confBtnId:"trainTerrArmyXP",noTurnsMsg:"Ends turn for "+this.model.get("name")+".",impactMsg:"+"+Math.round(.25*(100-this.model.get("armyXP")))+" XP",modalMsg:"<p>Spend $"+App.Utilities.addCommas(e)+" training the army stationed at&nbsp;"+this.model.get("name")+"?</p>",diffToNext:e});new App.Views.ConfModal({model:t})},updateTerrName:function(){if(!(App.Utilities.activeSide()===this.model.get("side")))return!1;$("#spInput");var e=new App.Models.Modal({title:"Update Territory Name: "+App.Models.selectedTerrModel.get("name"),confBtnId:"confNewTerrName",modalMsg:"<p>Enter your territory's new name:</p>"});new App.Views.SinglePromptModal({model:e})},investEconStr:function(){var e=App.Utilities.returnTerrInfraCost(this.model),t=App.Collections.terrCollection.getSideTerritoriesWithTurns(App.Utilities.activeSide()).length===App.Collections.terrCollection.getSideTerritories(App.Utilities.activeSide()).length?"":" with turns&nbsp;remaining",i=App.Collections.terrCollection.returnTotalCost("econStrength")<App.Utilities.getTreasury()&&0<App.Collections.terrCollection.returnTotalCost("econStrength")&&App.Collections.terrCollection.returnTotalCost("econStrength")!=App.Utilities.returnTerrInfraCost(App.Models.selectedTerrModel),o=i?"<p>Or spend $"+App.Utilities.addCommas(App.Collections.terrCollection.returnTotalCost("econStrength"))+" to repair damaged infrastructure in all&nbsp;territories"+t+"?</p>":"",a=i?"Repair "+this.model.get("name"):"Confirm",n=new App.Models.Modal({title:"Repair Infrastructure",confBtnId:"rebuildInfrastructure",impactMsg:"Strengthens citizen morale, population growth, and&nbsp;GDP.",modalMsg:"<p>Spend $"+App.Utilities.addCommas(e)+" to repair damaged infrastructure in "+this.model.get("name")+" (Tech Level&nbsp;"+this.model.get("econLevel")+")?</p>"+o,diffToNext:e,affordAll:i,repairAllId:"repairAllInfrastructure",confBtnTxt:a});new App.Views.ConfModal({model:n})},upgradeFortLevel:function(){var e=1+this.model.get("fortLevel"),t=new App.Models.Modal({title:"Upgrade Fort Level",confBtnId:"upgradeTerrFortLevel",impactMsg:"+"+e+"0% Defense Strength bonus at full strength. Strengthens army and citizen&nbsp;morale.",modalMsg:"<p>Spend $"+App.Utilities.addCommas(App.Constants.FORT_LVL_COST*e)+" to upgrade the defenses at "+this.model.get("name")+" to Level&nbsp;"+e+"?</p>",diffToNext:App.Constants.FORT_LVL_COST*e});new App.Views.ConfModal({model:t})},repairFort:function(){var e=App.Collections.terrCollection.returnTotalCost("fortStrength")<App.Utilities.getTreasury()&&0<App.Collections.terrCollection.returnTotalCost("fortStrength")&&App.Utilities.returnTerrFortCost(this.model)!=App.Collections.terrCollection.returnTotalCost("fortStrength"),t=App.Collections.terrCollection.getSideTerritoriesWithTurns(App.Utilities.activeSide()).length===App.Collections.terrCollection.getSideTerritories(App.Utilities.activeSide()).length?"":" in territories with turns&nbsp;remaining",i=e?"<p>Or spend $"+App.Utilities.addCommas(App.Collections.terrCollection.returnTotalCost("fortStrength"))+" to repair all damaged forts"+t+"?</p>":"",o=e?"Repair "+this.model.get("name"):"Confirm",a=new App.Models.Modal({title:"Repair Fort",confBtnId:"repairTerrFort",impactMsg:"Up to "+this.model.get("fortLevel")+"0% Defense Strength bonus. Impacts citizen and army&nbsp;morale.",modalMsg:"<p>Spend $"+App.Utilities.addCommas(App.Utilities.returnTerrFortCost(this.model))+" to repair the damage at Ft. "+this.model.get("name")+" (Level&nbsp;"+this.model.get("fortLevel")+")?</p>"+i,diffToNext:App.Utilities.returnTerrFortCost(this.model),affordAll:e,repairAllId:"repairAllFortStr",confBtnTxt:o});new App.Views.ConfModal({model:a})},recruitUnits:function(){App.Utilities.recruitUnitsModal(this.model)},investEcon:function(){var e=parseInt(this.model.get("econLevel"))+1,t=App.Constants.ECON_LVL_UP_AMT*e,i="<p>Spend $"+App.Utilities.addCommas(t)+" to upgrade the economy of "+this.model.get("name")+" to Level&nbsp;"+e+"?</p>",o=new App.Models.Modal({title:"Upgrade Economy Tech Level",confBtnId:"upgradeTerrEcon",impactMsg:"Strengthens citizen morale, population growth, and&nbsp;GDP.",modalMsg:i,diffToNext:t});new App.Views.ConfModal({model:o})},closeFooter:function(){App.Views.selectedTerrView.terrClick()},raiseFooter:function(){$("#dropFooter").addClass("drop").removeClass("raise"),$("#footerZone").toggleClass("lift")},dropFooter:function(){$("#dropFooter").removeClass("drop").addClass("raise"),$("#footerZone").toggleClass("lift")},closeView:function(){$("#footerZone").removeClass("lift"),$('[data-toggle="tooltip"]').off(),$('#footerZone [data-toggle="popover"]').off(),clearTimeout(App.Timers.main),clearTimeout(App.Timers.inner),App.Timers.main=0,App.Views.selectedFooterView={},this.unbind(),this.undelegateEvents(),this.remove()}}),App.Collections.Territories=Backbone.Collection.extend({model:App.Models.Territory,attackRange:function(e){var t=e.get("attackRange"),i=e.get("row"),o=e.get("column"),a=_.chain(this.models).filter(function(e){return e.get("side")!=App.Utilities.activeSide()}).value();_.each(a,function(e){Math.abs(parseInt(e.get("row"))-i)<t&&Math.abs(parseInt(e.get("column"))-o)<t&&e.set("inRange",!0)})},removeAttackRange:function(e){var t=_.chain(this.models).filter(function(e){return e.get("side")!=App.Utilities.activeSide()}).value();_.each(t,function(e){e.get("inRange")&&e.set("inRange",!1)})},casualtiesTotal:function(){return this.getSideCasualties("left","army")+this.getSideCasualties("right","army")},returnAvgTechLevel:function(t){var e=_.chain(this.models).filter(function(e){return e.get("side")===t}).reduce(function(e,t){return e+t.get("econLevel")},0).value(),i=_.chain(this.models).filter(function(e){return e.get("side")===t}).value();return Math.round(e/_.size(i))},specialMap:function(e,t){var i=e.toLowerCase()+t.toLowerCase(),o=App.Utilities.territoryNames(i);_.each(this.models,function(e){var t=o.length,i=_.random(0,t-1);e.set("name",o[i]),o.splice(i,1)})},changeColors:function(){_.each(this.models,function(e){e.set("color",App.Models.nationStats.get(e.get("side")).get("color"))})},duplicateNameCheck:function(t,e){return"territory"===e?_.chain(this.models).some(function(e){return e.get("name")===t}).value():"empire"===e?App.Utilities.getEnemyEmpireName()===t:void 0},recruitTarget:function(){var e=_.chain(this.models).filter(function(e){return e.get("side")===App.Utilities.activeSide()}).value();_.each(e,function(e){e.set("recruitTarget",!0)})},returnSelectedView:function(t){return _.chain(App.Views.allViews).filter(function(e){return e.model.cid===t}).value()[0]},removeRecruitTarget:function(){var e=_.chain(this.models).filter(function(e){return e.get("side")===App.Utilities.activeSide()}).value();_.each(e,function(e){e.set("recruitTarget",!1)})},returnAnyTurnsLeft:function(){return _.chain(this.models).filter(function(e){return e.get("side")===App.Utilities.activeSide()}).some(function(e){return 0<e.get("remainingTurns")}).value()},updgradeAllTechLevelsPolicy:function(i){var e=_.chain(this.models).filter(function(e){return e.get("side")===i&&e.get("econLevel")<App.Constants.MAX_TECH_LEVEL&&100===e.get("econStrength")}).sortBy(function(e){return e.get("econLevel")}).value();_.each(e,function(e){if(App.Utilities.getTreasuryAuto(i)>e.get("econLevelCost")){var t=App.Models.nationStats.get(i).get("policyCosts")+e.get("econLevelCost");App.Models.nationStats.payForUpgradeAuto(App.Utilities.getTreasuryAuto(i)-e.get("econLevelCost"),i,t),App.Utilities.upgradeTerrEconLevel(e,!0)}})},repairAllFortsPolicy:function(i){var e=_.chain(this.models).filter(function(e){return e.get("side")===i&&e.get("fortStrength")<100}).sortBy(function(e){return e.get("fortStrength")}).value();_.each(e,function(e){if(App.Utilities.getTreasuryAuto(i)>e.get("fortStrengthCost")){var t=App.Models.nationStats.get(i).get("policyCosts")+e.get("fortStrengthCost");App.Models.nationStats.payForUpgradeAuto(App.Utilities.getTreasuryAuto(i)-e.get("fortStrengthCost"),i,t),App.Utilities.repairTerrFortStr(e),App.Models.nationStats.get(i).set("repairAllFortCost",App.Collections.terrCollection.returnTotalCost("fortStrength"))}})},recruitPolicy:function(i){var o=_.findWhere(App.Models.nationStats.get(i).get("activePolicies"),{id:"recruit_army"}).amount,a=App.Constants.ARMY_UNIT_COST*o,e=_.chain(this.models).filter(function(e){return e.get("side")===i&&o<e.get("econPopulation")}).sortBy(function(e){return e.get("armyPopulation")}).value();_.each(e,function(e){if(a<App.Utilities.getTreasuryAuto(i)){var t=App.Models.nationStats.get(i).get("policyCosts")+a;App.Models.nationStats.payForUpgradeAuto(App.Utilities.getTreasuryAuto(i)-a,i,t),e.incomingUnitsAuto(e,o,i)}})},repairAllInfrastructurePolicy:function(i){var e=_.chain(this.models).filter(function(e){return e.get("side")===i&&e.get("econStrength")<100}).sortBy(function(e){return e.get("econStrength")}).value();_.each(e,function(e){if(App.Utilities.getTreasuryAuto(i)>e.get("econStrengthCost")){var t=App.Models.nationStats.get(i).get("policyCosts")+e.get("econStrengthCost");App.Models.nationStats.payForUpgradeAuto(App.Utilities.getTreasuryAuto(i)-e.get("econStrengthCost"),i,t),App.Utilities.upgradeTerrEconStr(e)}})},repairAllInfrastructure:function(){var e=_.chain(this.models).filter(function(e){return e.get("side")===App.Utilities.activeSide()&&e.get("econStrength")<100&&0<e.get("remainingTurns")}).value();_.each(e,function(e){App.Utilities.upgradeTerrEconStr(e)})},repairAllForts:function(){_.chain(this.models).filter(function(e){return e.get("side")===App.Utilities.activeSide()&&e.get("fortStrength")<100&&0<e.get("remainingTurns")}).value();_.each(this.models,function(e){App.Utilities.repairTerrFortStr(e)})},returnTotalCost:function(t,i){var e=0,o={};if("fortStrength"===t?o=App.Utilities.returnTerrFortCost:"econStrength"===t&&(o=App.Utilities.returnTerrInfraCost),void 0===i&&(i=App.Utilities.activeSide()),App.Utilities.activeSide()===i)e=_.chain(this.models).filter(function(e){return e.get("side")===i&&100!=e.get(t)&&0<e.get("remainingTurns")}).reduce(function(e,t){return e+o(t)},0).value();else e=_.chain(this.models).filter(function(e){return e.get("side")===i&&100!=e.get(t)}).reduce(function(e,t){return e+o(t)},0).value();return e},getSideCapital:function(t){return _.chain(this.models).filter(function(e){return e.get("side")===t&&e.get("isCapital")}).value()[0].get("name")},getSideCasualties:function(t,i){var e=_.chain(this.models).filter(function(e){return e.get("side")===t}).reduce(function(e,t){return e+t.get(i+"Casualties")},0).value();return"army"===i?e+App.Models.nationStats.get(t).get("invasionArmyCasualties"):"econ"===i?e+App.Models.nationStats.get(t).get("invasionEconCasualties"):void 0},getSideTerritories:function(t){return _.chain(this.models).filter(function(e){return e.get("side")===t}).sortBy(function(e){return e.get("remainingTurns")}).partition(function(e){return 0<e.get("remainingTurns")}).flatten().value()},getSideTerritoriesWithTurns:function(t){return _.filter(this.models,function(e){return e.get("side")===t&&0!=e.get("remainingTurns")})},returnSideTotal:function(t,i){return _.chain(this.models).filter(function(e){return e.get("side")===t}).reduce(function(e,t){return e+t.get(i)},0).value()},getSideTerritoriesWithRecruits:function(t){return _.chain(this.models).sortBy(function(e){return e.get("armyRecruits")}).reverse().filter(function(e){return e.get("side")==t&&0<e.get("armyRecruits")}).value()},taxCollection:function(){var t=0,i=0,o=App.Views.nationStatsView.model.get("left").get("taxRate"),a=App.Views.nationStatsView.model.get("right").get("taxRate");_.each(this.models,function(e){"left"===e.get("side")?t+=Math.round(e.get("economicOutput")*o):"right"===e.get("side")&&(i+=Math.round(e.get("economicOutput")*a))});var e=App.Views.nationStatsView.model.get("left").get("treasury")+t,n=App.Views.nationStatsView.model.get("right").get("treasury")+i;App.Views.nationStatsView.model.get("left").set({treasury:e,treasuryStart:e,treasuryPrev:e,taxesCollected:t}),App.Views.nationStatsView.model.get("right").set({treasury:n,treasuryStart:n,treasuryPrev:n,taxesCollected:i})},nextTreasury:function(){var e=this.returnSideTotal("left","economicOutput"),t=this.returnSideTotal("right","economicOutput"),i=Math.round(e*App.Models.nationStats.get("left").get("taxRate")),o=Math.round(t*App.Models.nationStats.get("right").get("taxRate"));App.Models.nationStats.get("left").set({nextTreasuryAddedEst:i,econOutput:this.returnSideTotal("left","economicOutput")}),App.Models.nationStats.get("right").set({nextTreasuryAddedEst:o,econOutput:this.returnSideTotal("right","economicOutput")})},updateAllMoraleGDP:function(o,a){var n=App.Views.nationStatsView.model.get(a).get("taxRate");_.each(this.models,function(e){if((App.Models.selectedTerrModel=e).get("side")===a){var t=App.Utilities.updateEconMorale({selectedTaxRate:o,oldTaxRate:n,newMorale:App.Models.selectedTerrModel.get("econMorale")}),i=App.Utilities.updateGDP({newMorale:t,newLevel:App.Models.selectedTerrModel.get("econLevel"),newEconPopulation:App.Models.selectedTerrModel.get("econPopulation"),newEconStrength:App.Models.selectedTerrModel.get("econStrength"),ecGrowthRate:App.Models.selectedTerrModel.get("econGrowthPct")});App.Models.selectedTerrModel.set({econMorale:t,economicOutput:i})}}),App.Models.selectedTerrModel=App.Models.clickedTerrModel},battleImpact:function(e,s){var l=e.get("side");App.Collections.terrCollection.forEach(function(e,t){var i,o,a=e.get("morale"),n=e.get("econMorale");e.get("economicOutput");if(e.get("side")==l){i=s?Math.min(a+5,100):Math.min(a+2,100),o=s?Math.min(n+5,100):Math.min(n+3,100);var r=App.Utilities.updateGDP({newMorale:o,newLevel:e.get("econLevel"),newEconPopulation:e.get("econPopulation"),newEconStrength:e.get("econStrength"),ecGrowthRate:e.get("econGrowthPct")})}else{i=s?Math.max(a-5,1):Math.max(a-2,1),o=s?Math.max(n-5,1):Math.max(n-3,1);r=App.Utilities.updateGDP({newMorale:o,newLevel:e.get("econLevel"),newEconPopulation:e.get("econPopulation"),newEconStrength:e.get("econStrength"),ecGrowthRate:e.get("econGrowthPct")})}e.set({morale:i,econMorale:o,economicOutput:r})})},newTurnUpdate:function(){var E="left"===App.Utilities.activeSide(),I=0,N=0,V=E?App.Models.nationStats.get("left").get("econCrash"):4<App.Models.nationStats.get("left").get("lowTaxTurnLength")&&Math.random()<.25,L=E?App.Models.nationStats.get("right").get("econCrash"):4<App.Models.nationStats.get("right").get("lowTaxTurnLength")&&Math.random()<.25,$=!1,O=V?App.Constants.GDP_PENALTY_LOW_TAX+Math.random()/20:1,F=L?App.Constants.GDP_PENALTY_LOW_TAX+Math.random()/20:1,G=0,B=0;if(V&&!E?(App.Models.nationStats.get("left").set("econCrash",!0),App.Models.nationStats.get("left").get("econCrashTurn")===App.Models.nationStats.get("currentTurn")-1&&App.Models.nationStats.get("left").set("econCrashTurnPrv",App.Models.nationStats.get("left").get("econCrashTurn")),App.Models.nationStats.get("left").set("econCrashTurn",App.Models.nationStats.get("currentTurn"))):E||(App.Models.nationStats.get("left").set("econCrash",!1),0!=App.Models.nationStats.get("left").get("econCrashTurn")&&App.Models.nationStats.get("left").set("econCrashTurnPrv",App.Models.nationStats.get("left").get("econCrashTurn")),App.Models.nationStats.get("left").set("econCrashTurn",0)),L&&!E?(App.Models.nationStats.get("right").set("econCrash",!0),App.Models.nationStats.get("right").get("econCrashTurn")===App.Models.nationStats.get("currentTurn")-1&&App.Models.nationStats.get("right").set("econCrashTurnPrv",App.Models.nationStats.get("right").get("econCrashTurn")),App.Models.nationStats.get("right").set("econCrashTurn",App.Models.nationStats.get("currentTurn"))):E||(App.Models.nationStats.get("right").set("econCrash",!1),0!=App.Models.nationStats.get("right").get("econCrashTurn")&&App.Models.nationStats.get("right").set("econCrashTurnPrv",App.Models.nationStats.get("right").get("econCrashTurn")),App.Models.nationStats.get("right").set("econCrashTurn",0)),!E){App.Models.nationStats.get("left").set("policyCosts",0),App.Models.nationStats.get("right").set("policyCosts",0);for(var e=[{side:"left",policies:App.Models.nationStats.get("left").get("activePolicies"),enabled:App.Models.nationStats.get("left").get("activePolicyCount")},{side:"right",policies:App.Models.nationStats.get("right").get("activePolicies"),enabled:App.Models.nationStats.get("right").get("activePolicyCount")}],t=0;t<e.length;t++)if(0!=e[t].enabled){for(var i=e[t].side,o=[],a=0;a<e[t].policies.length;a++)0!=e[t].policies[a].priority&&e[t].policies[a].side==e[t].side&&o.push(e[t].policies[a]);_.sortBy(o,"priority");for(var n=0;n<o.length;n++)switch(o[n].id){case"repair_infra":App.Collections.terrCollection.repairAllInfrastructurePolicy(i);break;case"repair_forts":App.Collections.terrCollection.repairAllFortsPolicy(i);break;case"upgrade_tech":App.Collections.terrCollection.updgradeAllTechLevelsPolicy(i);break;case"recruit_army":App.Collections.terrCollection.recruitPolicy(i);break;default:return!1}}}if(App.Collections.terrCollection.forEach(function(e,t){var i=e.get("side"),o=e.get("armyPopulation"),a=e.get("fortStrength"),n=e.get("fortLevel"),r=0,s="left"===i,l=s?O:F;if(e.set("prvPopulation",e.get("armyPopulation")),r=s?E?0:1:E?1:0,E)e.set({remainingTurns:r,selected:!1,trainingClicked:!1});else{var p,d=e.get("econPopulation"),c=(e.get("economicOutput"),e.get("econLevel")),g=e.get("econMorale"),u=Math.max(e.get("econStrength")-App.Models.nationStats.get(i).returnLowTaxInfraDrag(),0);$=!("left"!==e.get("side")||!V)||!("right"!==e.get("side")||!L);var m=s?App.Models.nationStats.get("left").get("highTaxTurnLength"):App.Models.nationStats.get("right").get("highTaxTurnLength"),A=s?App.Models.nationStats.get("left").get("lowTaxTurnLength"):App.Models.nationStats.get("right").get("lowTaxTurnLength"),h=App.Utilities.newGDPGrowthRate({econPop:d,econMorale:g,econStrength:u,econLevel:c,highTaxTurnLength:m,lowTaxTurnLength:A,lowTaxCrash:$}),M=App.Utilities.newEconPopGrowthRate({econPop:d,econMorale:g,econLevel:c,econStrengh:u,highTaxTurnLength:m,lowTaxCrash:$}),T=d+Math.round(M*d),f=App.Models.nationStats.get(i).get("taxRate"),C="left"===i?App.Models.nationStats.get("left").get("highTaxTurnLength"):0,v="right"===i?App.Models.nationStats.get("right").get("highTaxTurnLength"):0,y="left"===i?App.Models.nationStats.get("left").get("lowTaxTurnLength"):0,S="right"===i?App.Models.nationStats.get("left").get("lowTaxTurnLength"):0,w=App.Utilities.updateEconMorale({selectedArmyPop:o,selectedFortStrength:a,selectedFortLevel:n,econLevel:c,econStrength:u,econPopulation:d,newMorale:g,oldTaxRate:f,genTaxBonuses:!0,selectedTaxRate:f,leftHighTaxTurnLength:C,rightHighTaxTurnLength:v,leftLowTaxTurnLength:y,rightLowTaxTurnLength:S,side:i}),b=Math.min(Math.round(a+e.get("armyPopulation")/1e4),100),R=e.get("morale"),U=(U="left"===e.get("side")&&V||"right"===e.get("side")&&L)?10:0,k=Math.min(Math.round((R+5)*App.Constants.LEVEL_0_MOR_PER_TURN_MULT),100)-U,P=App.Utilities.updateGDP({newMorale:w,newLevel:e.get("econLevel"),newEconPopulation:T,newEconStrength:u,ecGrowthRate:h});P=Math.round(l*P);p=Math.round(P-l*P),"left"==i?(I+=T,G+=p):(N+=T,B+=p);var x=0;0<App.Models.nationStats.get(i).get("recruitsAuto")&&(x=e.get("armyRecruits")),e.set({armyCasualties:0,armyPopulation:o,armyRecruits:x,prvPopulation:o,startPopulation:o,morale:k,fortStrength:b,economicOutput:P,governorKilled:!1,startEconomicOutput:P,econCasualties:0,econPopulation:T,prvEconPopulation:T,startEconPopulation:T,econMorale:w,econStrength:u,econLeveledUp:!1,fortLeveledUp:!1,remainingTurns:r,selected:!1,trainingClicked:!1,econPopulationGrowthPct:100*M,econGrowthPct:100*h}),App.Utilities.flipEls([".armyPopulation-main",".fortStrength-main"])}}),!E){var r=0,s=[];0<App.Models.nationStats.get("left").get("recruitsAuto")&&(r=App.Models.nationStats.get("left").get("recruitsAuto"),s=App.Models.nationStats.get("left").get("terrsWithRecruits")),App.Models.nationStats.get("left").set({armyPopulationStart:this.returnSideTotal("left","armyPopulation"),armyPopulationNow:this.returnSideTotal("left","armyPopulation"),armyCasualties:0,econPopulationStart:I,econPopulationNow:this.returnSideTotal("left","econPopulation"),armiesPromoted:[],battleLosses:0,battleWins:0,econCasualties:0,econCrashPenalty:G,econOutput:this.returnSideTotal("left","economicOutput"),econOutputStart:this.returnSideTotal("left","economicOutput"),fortsLost:[],invadedThisTurn:[],invasionArmyCasualties:0,invasionEconCasualties:0,recruitsAuto:0,recruitsThisTurn:r,terrLostThisTurn:[],terrsWithRecruits:s,repairAllInfrastructureCost:this.returnTotalCost("econStrength","left"),repairAllFortCost:this.returnTotalCost("fortStrength","left")});var l=0,p=[];0<App.Models.nationStats.get("right").get("recruitsAuto")&&(l=App.Models.nationStats.get("right").get("recruitsAuto"),p=App.Models.nationStats.get("right").get("terrsWithRecruits")),App.Models.nationStats.get("right").set({armyPopulationStart:this.returnSideTotal("right","armyPopulation"),armyPopulationNow:this.returnSideTotal("right","armyPopulation"),armyCasualties:0,econPopulationStart:N,econPopulationNow:this.returnSideTotal("right","econPopulation"),armiesPromoted:[],battleLosses:0,battleWins:0,econCasualties:0,econCrashPenalty:B,econOutput:this.returnSideTotal("right","economicOutput"),econOutputStart:this.returnSideTotal("right","economicOutput"),fortsLost:[],invadedThisTurn:[],invasionArmyCasualties:0,invasionEconCasualties:0,recruitsAuto:0,recruitsThisTurn:l,terrLostThisTurn:[],terrsWithRecruits:p,repairAllInfrastructureCost:this.returnTotalCost("econStrength","right"),repairAllFortCost:this.returnTotalCost("fortStrength","right")})}}}),App.Collections.Policies=Backbone.Collection.extend({model:App.Models.Policy}),App.Models.battleMapModel=new App.Models.BattleZone,App.Views.battleMap=new App.Views.BattleZone({model:App.Models.battleMapModel}),$("#game").prepend(App.Views.battleMap.$el),App.Models.gameStartModel=new App.Models.GameStart,App.Views.gameStartView=new App.Views.GameStart({model:App.Models.gameStartModel}),$("#setup").html(App.Views.gameStartView.$el),App.Views.p1ColorView=new App.Views.ColorView({model:App.Models.gameStartModel}),App.Views.p2ColorView=new App.Views.RightColorView({model:App.Models.gameStartModel}),$("#p1ColorMenu").html(App.Views.p1ColorView.$el),$("#p2ColorMenu").html(App.Views.p2ColorView.$el),App.Models.nationStats=new App.Models.NationStats,App.Views.nationStatsView=new App.Views.NationStats({model:App.Models.nationStats}),App.Collections.terrCollection=new App.Collections.Territories,App.Utilities.makeTerritories(),document.documentElement.msRequestFullscreen?document.onmsfullscreenchange=function(){App.Models.nationStats.set("fullScreen",!!document.msFullscreenElement),setTimeout(function(){App.Views.nationStatsView.render()},250)}:document.documentElement.mozRequestFullScreen?document.onmozfullscreenchange=function(){App.Models.nationStats.set("fullScreen",!!document.mozFullScreenElement)}:document.documentElement.webkitRequestFullScreen&&(document.onwebkitfullscreenchange=function(){App.Models.nationStats.set("fullScreen",!!document.webkitFullscreenElement)}),App.Utilities.smallScreenOnly()&&App.Models.battleMapModel.set("tipsMode",!1),console.log("[accuwar]: Turn-based strategy game and battle simulator. Play free."),console.log("Release: -2.9.2 Pre-Alpha"),console.log("Release Date: 08.08.2018"),console.log("Author: Josh Harris");